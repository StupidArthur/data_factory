# 后端使用指南

本文档介绍如何使用后端功能来添加配置、生成数据等操作，无需依赖前端界面。

## 目录

1. [命令行工具使用](#命令行工具使用)
2. [API接口使用](#api接口使用)
3. [数据库直接操作](#数据库直接操作)
4. [Python脚本示例](#python脚本示例)

---

## 命令行工具使用

### 1. 使用 main.py 生成数据

`main.py` 提供了直接使用配置文件生成数据的功能。

#### 修改 main.py 中的参数

编辑 `main.py` 文件，修改以下参数：

```python
if __name__ == '__main__':
    # 配置参数
    config_path = 'config/test_case_01_single_sine.yaml'  # 配置文件路径
    output_path = 'output/test_output.csv'  # 输出文件路径（None表示不导出）
    preview = False  # 是否预览数据（True表示预览，False表示导出）
    
    # 生成数据
    generate_data(config_path, output_path, preview)
```

#### 运行

```bash
python main.py
```

#### 功能说明

- **config_path**: YAML配置文件路径（支持相对路径和绝对路径）
- **output_path**: 输出CSV文件路径
  - 如果指定，会生成两个文件：
    - `{output_path}_history.csv`: 历史数据（10000点）
    - `{output_path}.csv`: 完整数据（10120点，包含未来120点）
  - 如果为 `None`，则不导出文件
- **preview**: 是否打开数据预览窗口（需要PyQt6）

---

## API接口使用

### 启动后端服务

```bash
cd webserver
python app.py
```

默认服务地址：`http://localhost:8000`

### 1. 创建配置

#### 使用 curl

```bash
curl -X POST http://localhost:8000/api/configs/ \
  -H "Content-Type: application/json" \
  -d '{
    "name": "我的配置",
    "description": "配置描述",
    "config_yaml": "generator:\n  time_interval: 5.0\n  history_points: 10000\n  future_points: 120\n  start_time: \"2024-01-01 00:00:00\"\n  templates:\n    - type: ExpressionTemplate\n      name: template_1\n      config:\n        output_name: F.sine\n        calculation:\n          expression: \"50 + 100 * sin(2 * pi * t / 3600)\"\n        noise_level: 0.05\ntemplate:\n  time_format: datetime\n  has_title_row: true\n  has_description_row: true\n  hide_parameter_descriptions: true\n  column_descriptions:\n    timeStamp: \"时间戳\"\n    F.sine: \"正弦波数据\""
  }'
```

#### 使用 Python requests

```python
import requests
import yaml

# 读取YAML配置文件
with open('config/test_case_01_single_sine.yaml', 'r', encoding='utf-8') as f:
    config_yaml = f.read()

# 创建配置
response = requests.post('http://localhost:8000/api/configs/', json={
    'name': '我的配置',
    'description': '配置描述',
    'config_yaml': config_yaml
})

print(response.json())
```

### 2. 获取配置列表

```bash
curl http://localhost:8000/api/configs/
```

### 3. 获取单个配置

```bash
curl http://localhost:8000/api/configs/1
```

### 4. 更新配置

```bash
curl -X PUT http://localhost:8000/api/configs/1 \
  -H "Content-Type: application/json" \
  -d '{
    "name": "更新后的配置名称",
    "config_yaml": "..."
  }'
```

### 5. 删除配置

```bash
curl -X DELETE http://localhost:8000/api/configs/1
```

### 6. 生成数据

#### 使用配置ID

```bash
curl -X POST http://localhost:8000/api/generate/ \
  -H "Content-Type: application/json" \
  -d '{
    "config_id": 1
  }'
```

#### 直接使用YAML配置

```bash
curl -X POST http://localhost:8000/api/generate/ \
  -H "Content-Type: application/json" \
  -d '{
    "config_yaml": "generator:\n  time_interval: 5.0\n  ..."
  }'
```

### 7. 导出数据（CSV）

```bash
# 导出完整数据
curl http://localhost:8000/api/export/1?type=full -o output.csv

# 导出历史数据
curl http://localhost:8000/api/export/1?type=history -o output_history.csv
```

---

## 数据库直接操作

### 使用 SQLite 命令行工具

```bash
# 进入webserver目录
cd webserver

# 打开数据库
sqlite3 database.db
```

### 常用SQL命令

#### 查看所有配置

```sql
SELECT id, name, description, group_id, created_at FROM configs;
```

#### 查看配置的YAML内容

```sql
SELECT id, name, config_yaml FROM configs WHERE id = 1;
```

#### 插入新配置

```sql
INSERT INTO configs (name, description, config_yaml, group_id, user, created_at, updated_at)
VALUES (
  '新配置',
  '配置描述',
  'generator:
  time_interval: 5.0
  history_points: 10000
  future_points: 120
  start_time: "2024-01-01 00:00:00"
  templates: []
template:
  time_format: datetime
  has_title_row: true
  has_description_row: true
  hide_parameter_descriptions: true
  column_descriptions: {}',
  NULL,
  NULL,
  datetime('now'),
  datetime('now')
);
```

#### 更新配置

```sql
UPDATE configs 
SET name = '更新后的名称', 
    config_yaml = '...',
    updated_at = datetime('now')
WHERE id = 1;
```

#### 删除配置

```sql
DELETE FROM configs WHERE id = 1;
```

### 使用 Python 操作数据库

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from webserver.models import Config, Base
import yaml

# 连接数据库
engine = create_engine('sqlite:///webserver/database.db')
Session = sessionmaker(bind=engine)
session = Session()

# 读取YAML配置文件
with open('config/test_case_01_single_sine.yaml', 'r', encoding='utf-8') as f:
    config_yaml = f.read()

# 创建配置
config = Config(
    name='我的配置',
    description='配置描述',
    config_yaml=config_yaml,
    group_id=None,
    user=None
)
session.add(config)
session.commit()

# 查询配置
configs = session.query(Config).all()
for config in configs:
    print(f"ID: {config.id}, Name: {config.name}")

# 获取单个配置
config = session.query(Config).filter(Config.id == 1).first()
if config:
    print(config.config_yaml)

# 更新配置
config = session.query(Config).filter(Config.id == 1).first()
if config:
    config.name = '更新后的名称'
    session.commit()

# 删除配置
config = session.query(Config).filter(Config.id == 1).first()
if config:
    session.delete(config)
    session.commit()

session.close()
```

---

## Python脚本示例

### 示例1：批量导入配置文件

创建文件 `scripts/import_configs.py`：

```python
"""
批量导入配置文件到数据库
"""

import yaml
from pathlib import Path
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from webserver.models import Config
from datetime import datetime

def import_configs(config_dir='config', group_id=None):
    """
    批量导入配置文件到数据库
    
    Args:
        config_dir: 配置文件目录
        group_id: 分组ID（可选）
    """
    # 连接数据库
    engine = create_engine('sqlite:///webserver/database.db')
    Session = sessionmaker(bind=engine)
    session = Session()
    
    try:
        config_path = Path(config_dir)
        yaml_files = list(config_path.glob('*.yaml')) + list(config_path.glob('*.yml'))
        
        for yaml_file in yaml_files:
            # 读取YAML文件
            with open(yaml_file, 'r', encoding='utf-8') as f:
                config_yaml = f.read()
            
            # 配置名称（使用文件名，去掉扩展名）
            config_name = yaml_file.stem
            
            # 检查是否已存在
            existing = session.query(Config).filter(Config.name == config_name).first()
            if existing:
                print(f"配置 {config_name} 已存在，跳过")
                continue
            
            # 创建配置
            config = Config(
                name=config_name,
                description=f'从文件导入：{yaml_file.name}',
                config_yaml=config_yaml,
                group_id=group_id,
                user=None,
                created_at=datetime.now(),
                updated_at=datetime.now()
            )
            session.add(config)
            print(f"导入配置：{config_name}")
        
        session.commit()
        print("批量导入完成")
    except Exception as e:
        session.rollback()
        print(f"导入失败：{e}")
    finally:
        session.close()

if __name__ == '__main__':
    # 导入config目录下的所有YAML文件
    import_configs('config', group_id=None)
```

运行：

```bash
python scripts/import_configs.py
```

### 示例2：批量生成数据

创建文件 `scripts/batch_generate.py`：

```python
"""
批量生成数据
"""

import yaml
from pathlib import Path
from core.generators.data_generator import DataGenerator
from template.template_manager import TemplateManager
from output.data_exporter import DataExporter
from datetime import datetime

def batch_generate(config_dir='config', output_dir='output'):
    """
    批量生成数据
    
    Args:
        config_dir: 配置文件目录
        output_dir: 输出目录
    """
    config_path = Path(config_dir)
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)
    
    yaml_files = list(config_path.glob('*.yaml')) + list(config_path.glob('*.yml'))
    
    for yaml_file in yaml_files:
        print(f"处理配置文件：{yaml_file.name}")
        
        try:
            # 加载配置
            with open(yaml_file, 'r', encoding='utf-8') as f:
                config = yaml.safe_load(f)
            
            # 创建数据生成器
            generator_config = config.get('generator', {})
            generator = DataGenerator(generator_config)
            
            # 生成数据
            full_df = generator.generate()
            history_df = generator.get_history_data()
            
            # 创建模板管理器和导出器
            template_config = config.get('template', {})
            template_manager = TemplateManager(template_config)
            exporter = DataExporter(template_manager)
            
            # 生成时间戳
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            base_name = yaml_file.stem
            
            # 导出历史数据
            history_output = output_path / f"{base_name}_{timestamp}_history.csv"
            exporter.export(history_df, str(history_output), add_timestamp=False)
            print(f"  历史数据已导出：{history_output}")
            
            # 导出完整数据
            full_output = output_path / f"{base_name}_{timestamp}.csv"
            exporter.export(full_df, str(full_output), add_timestamp=False)
            print(f"  完整数据已导出：{full_output}")
            
        except Exception as e:
            print(f"  处理失败：{e}")
            continue
    
    print("批量生成完成")

if __name__ == '__main__':
    batch_generate('config', 'output')
```

运行：

```bash
python scripts/batch_generate.py
```

### 示例3：使用API批量生成数据

创建文件 `scripts/api_batch_generate.py`：

```python
"""
使用API批量生成数据
"""

import requests
import json
from pathlib import Path

API_BASE = 'http://localhost:8000'

def batch_generate_via_api(config_ids=None):
    """
    通过API批量生成数据
    
    Args:
        config_ids: 配置ID列表（如果为None，则使用所有配置）
    """
    # 获取配置列表
    if config_ids is None:
        response = requests.get(f'{API_BASE}/api/configs/')
        if response.status_code == 200:
            configs = response.json().get('data', [])
            config_ids = [c['id'] for c in configs]
        else:
            print(f"获取配置列表失败：{response.status_code}")
            return
    
    # 批量生成
    for config_id in config_ids:
        print(f"生成配置 {config_id} 的数据...")
        
        try:
            # 生成数据
            response = requests.post(f'{API_BASE}/api/generate/', json={
                'config_id': config_id
            })
            
            if response.status_code == 200:
                result = response.json()
                print(f"  成功：共 {len(result.get('data', {}).get('full', []))} 行数据")
            else:
                print(f"  失败：{response.status_code} - {response.text}")
            
            # 导出数据
            response = requests.get(f'{API_BASE}/api/export/{config_id}?type=full')
            if response.status_code == 200:
                output_file = f'output/config_{config_id}_full.csv'
                with open(output_file, 'wb') as f:
                    f.write(response.content)
                print(f"  数据已导出：{output_file}")
            
        except Exception as e:
            print(f"  处理失败：{e}")
            continue
    
    print("批量生成完成")

if __name__ == '__main__':
    # 生成所有配置的数据
    batch_generate_via_api()
    
    # 或指定配置ID
    # batch_generate_via_api([1, 2, 3])
```

运行：

```bash
# 确保后端服务已启动
python webserver/app.py

# 在另一个终端运行
python scripts/api_batch_generate.py
```

---

## 配置文件格式

### ExpressionTemplate 配置示例

```yaml
generator:
  time_interval: 5.0  # 时间间隔（秒）
  history_points: 10000  # 历史数据点数
  future_points: 120  # 未来数据点数
  start_time: "2024-01-01 00:00:00"  # 开始时间
  
  templates:
    # 独立生成（只使用时间t）
    - type: ExpressionTemplate
      name: sine_wave
      config:
        output_name: F.sine
        calculation:
          expression: "50 + 100 * sin(2 * pi * t / 3600)"  # t从0开始（秒）
        noise_level: 0.05
    
    # 依赖生成（使用其他位号）
    - type: ExpressionTemplate
      name: dependent_template
      config:
        output_name: F.result
        sources:
          - source_name: F.sine
            lag_seconds: 30  # 滞后30秒
        calculation:
          expression: "x1 * 0.5 + 10"  # x1对应第一个source
        noise_level: 0.05

template:
  time_format: datetime  # 时间格式：datetime 或 timestamp
  has_title_row: true  # 是否有标题行
  has_description_row: true  # 是否有描述行
  hide_parameter_descriptions: true  # 是否隐藏参数描述
  column_descriptions:
    timeStamp: "时间戳"
    F.sine: "正弦波数据"
    F.result: "计算结果"
```

### 表达式语法

- **变量**：
  - `t`: 时间（秒），从0开始
  - `x1, x2, x3, ...`: 依赖位号（已应用滞后）
  
- **函数**：
  - `sqrt(x)`: 平方根
  - `log(x)`: 自然对数
  - `exp(x)`: 指数函数
  - `sin(x)`, `cos(x)`, `tan(x)`: 三角函数
  - `abs(x)`: 绝对值
  - `max(x1, x2)`, `min(x1, x2)`: 最大值/最小值
  - `power(x, n)`: 幂函数
  - `sign(x)`: 符号函数
  - `random()`: 随机数（0-1）
  - `random_normal(mean, std_dev)`: 正态分布随机数
  
- **常量**：
  - `pi`: 圆周率
  - `e`: 自然常数

---

## 常见问题

### 1. 如何查看数据库中的配置？

```bash
cd webserver
sqlite3 database.db
SELECT id, name, description FROM configs;
```

### 2. 如何备份数据库？

```bash
cp webserver/database.db webserver/database_backup.db
```

### 3. 如何清空所有配置？

```bash
cd webserver
sqlite3 database.db
DELETE FROM configs;
```

### 4. 如何查看生成的数据？

- 使用 `main.py` 的 `preview=True` 参数打开预览窗口
- 或直接打开生成的CSV文件

---

## 总结

后端提供了多种方式来管理配置和生成数据：

1. **命令行工具** (`main.py`)：最简单直接，适合单次生成
2. **API接口**：适合集成到其他系统或自动化脚本
3. **数据库操作**：适合批量管理或数据迁移
4. **Python脚本**：适合复杂的批量处理任务

根据你的需求选择合适的方式即可。

