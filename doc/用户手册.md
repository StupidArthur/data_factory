# 数据工厂 - 用户手册

## 1. 安装部署

### 1.1 环境要求

- Python 3.13
- Windows/Linux/macOS

### 1.2 安装步骤

1. **克隆或下载项目**
```bash
git clone <repository_url>
cd data_factory
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **验证安装**
```bash
python -c "import pandas, scipy, PyQt6, pyqtgraph; print('安装成功')"
```

### 1.3 目录结构

安装后的项目目录结构：
```
data_factory/
├── core/              # 核心模块
├── template/          # 模板管理
├── output/            # 数据输出
├── visualization/     # 可视化工具
├── utils/             # 工具函数
├── config/            # 配置文件
├── logs/              # 日志文件（自动创建）
├── main.py            # 主程序
├── requirements.txt   # 依赖列表
└── README.md          # 说明文档
```

## 2. 快速开始

### 2.1 生成数据

使用示例配置文件生成数据：

```bash
python main.py --config config/example_config.json --output output/data.csv
```

### 2.2 预览数据

生成数据并预览（不导出）：

```bash
python main.py --config config/example_config.json --preview
```

### 2.3 查看已生成的数据

使用可视化工具查看CSV文件：

```python
from visualization import show_data_viewer
import pandas as pd

# 加载CSV文件
df = pd.read_csv('output/data.csv')
viewer = show_data_viewer(df)
```

或直接运行可视化工具：

```bash
python -m visualization.data_viewer
```

## 3. 配置文件说明

### 3.1 配置文件结构

配置文件采用JSON格式，包含两个主要部分：

- `generator`: 数据生成器配置
- `template`: 模板管理配置

### 3.2 数据生成器配置

```json
{
  "generator": {
    "time_interval": 5.0,        // 时间间隔（秒）
    "history_points": 10000,      // 历史数据点数
    "future_points": 120,         // 未来数据点数
    "start_time": "2024-01-01 00:00:00",  // 起始时间
    "templates": [...]           // 能力模板列表
  }
}
```

### 3.3 能力模板配置

#### 时间规律变化模板

```json
{
  "type": "TimePatternTemplate",
  "name": "light_pattern",
  "config": {
    "output_name": "F.light",
    "pattern_type": "sinusoidal",  // sinusoidal, linear, exponential
    "amplitude": 100.0,            // 振幅
    "period": 86400.0,             // 周期（秒）
    "phase": 0.0,                  // 相位
    "offset": 50.0,                // 偏移量
    "noise_level": 0.05            // 噪声水平
  }
}
```

#### 滞后线性跟随模板

```json
{
  "type": "LagFollowTemplate",
  "name": "temperature_follow",
  "config": {
    "output_name": "F.temperature",
    "source_name": "F.power",      // 跟随的数据名称
    "lag_seconds": 30,             // 滞后时间（秒）
    "sensitivity": 0.5,            // 敏感度
    "initial_value": 20.0,         // 初始值
    "decay_rate": 0.01,            // 衰减率
    "noise_level": 0.02            // 噪声水平
  }
}
```

#### 多项式关系模板

```json
{
  "type": "PolynomialTemplate",
  "name": "combined_value",
  "config": {
    "output_name": "F.combined",
    "source_names": ["F.light", "F.power", "F.temperature"],
    "coefficients": {
      "constant": 10.0,            // 常数项
      "F.light": 0.1,              // 线性项系数
      "F.power": 0.2,
      "F.temperature": 0.3,
      "F.light*F.power": 0.001     // 交叉项系数
    },
    "noise_level": 0.05
  }
}
```

### 3.4 模板管理配置

```json
{
  "template": {
    "time_format": "datetime",     // timestamp, datetime, datetime_slash
    "has_title_row": true,         // 是否有标题行
    "has_description_row": true,   // 是否有描述行
    "column_descriptions": {       // 列描述
      "timeStamp": "时间戳",
      "F.light": "光照强度",
      "F.power": "电功率"
    }
  }
}
```

## 4. 使用示例

### 4.1 示例1：生成光照强度数据

创建配置文件 `config/light_config.json`:

```json
{
  "generator": {
    "time_interval": 5.0,
    "history_points": 10000,
    "future_points": 120,
    "start_time": "2024-01-01 00:00:00",
    "templates": [
      {
        "type": "TimePatternTemplate",
        "name": "light",
        "config": {
          "output_name": "F.light",
          "pattern_type": "sinusoidal",
          "amplitude": 100.0,
          "period": 86400.0,
          "offset": 50.0,
          "noise_level": 0.05
        }
      }
    ]
  },
  "template": {
    "time_format": "datetime",
    "has_title_row": true,
    "has_description_row": true
  }
}
```

运行：

```bash
python main.py --config config/light_config.json --output output/light_data.csv
```

### 4.2 示例2：生成滞后跟随数据

创建配置文件 `config/temperature_config.json`:

```json
{
  "generator": {
    "time_interval": 5.0,
    "history_points": 10000,
    "future_points": 120,
    "start_time": "2024-01-01 00:00:00",
    "templates": [
      {
        "type": "TimePatternTemplate",
        "name": "power",
        "config": {
          "output_name": "F.power",
          "pattern_type": "sinusoidal",
          "amplitude": 50.0,
          "period": 86400.0,
          "offset": 100.0
        }
      },
      {
        "type": "LagFollowTemplate",
        "name": "temperature",
        "config": {
          "output_name": "F.temperature",
          "source_name": "F.power",
          "lag_seconds": 30,
          "sensitivity": 0.5,
          "initial_value": 20.0
        }
      }
    ]
  },
  "template": {
    "time_format": "datetime",
    "has_title_row": true,
    "has_description_row": true
  }
}
```

运行：

```bash
python main.py --config config/temperature_config.json --output output/temperature_data.csv
```

## 5. 可视化工具使用

### 5.1 启动可视化工具

方法1：通过命令行参数预览
```bash
python main.py --config config/example_config.json --preview
```

方法2：直接运行可视化工具
```bash
python -m visualization.data_viewer
```

### 5.2 界面操作

**加载数据**
- 点击"加载CSV文件"按钮选择文件
- 或使用"加载DataFrame"（需要代码调用）

**显示控制**
- **起始索引**: 设置显示数据的起始位置
- **显示点数**: 设置一次显示的数据点数
- **显示列**: 选择要显示的列

**缩放控制**
- **放大**: 缩小显示范围，显示更少的数据点
- **缩小**: 扩大显示范围，显示更多的数据点
- **重置视图**: 恢复到默认视图

**交互操作**
- 鼠标拖拽：在图表上拖拽可以平移视图
- 鼠标滚轮：缩放视图

## 6. 常见问题

### 6.1 依赖关系错误

**问题**: 提示"缺少依赖数据"或"循环依赖"

**解决**: 
- 检查能力模板的依赖关系
- 确保被依赖的模板在依赖它的模板之前定义
- 检查`source_name`是否正确

### 6.2 时间格式错误

**问题**: 时间格式不正确

**解决**:
- 检查`start_time`格式是否为 "YYYY-MM-DD HH:MM:SS"
- 检查`time_format`配置是否正确

### 6.3 可视化工具无法启动

**问题**: PyQt6相关错误

**解决**:
- 确保已安装PyQt6: `pip install PyQt6`
- 检查系统是否支持GUI（Linux可能需要X11）

### 6.4 内存不足

**问题**: 生成大数据集时内存不足

**解决**:
- 使用增量导出功能
- 减少`history_points`和`future_points`
- 分批生成数据

## 7. 高级功能

### 7.1 自定义能力模板

1. 创建新的模板类，继承`CapabilityTemplate`
2. 实现`validate_config()`和`generate()`方法
3. 注册模板类型：
```python
from core.relationships import register_template
register_template('CustomTemplate', CustomTemplateClass)
```

### 7.2 组合能力模板

使用`CompositeCapabilityTemplate`组合多个模板：

```json
{
  "type": "CompositeCapabilityTemplate",
  "name": "composite",
  "config": {
    "combination_mode": "linear",  // linear 或 multiply
    "templates": [
      {
        "type": "TimePatternTemplate",
        "config": {...},
        "weight": 1.0
      },
      {
        "type": "LagFollowTemplate",
        "config": {...},
        "weight": 0.5
      }
    ]
  }
}
```

### 7.3 日志配置

日志文件自动保存在`logs/`目录下，文件名包含时间戳。

可以通过代码配置日志：

```python
from utils.logger import get_logger

logger = get_logger(
    name='my_logger',
    log_dir='custom_logs',
    level=logging.DEBUG,
    console_output=True,
    file_output=True
)
```

## 8. 技术支持

如有问题，请查看：
- 项目文档：`doc/`目录
- 日志文件：`logs/`目录
- 示例配置：`config/example_config.json`

