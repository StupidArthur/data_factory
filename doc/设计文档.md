# 数据工厂 - 设计文档

## 1. 系统架构

### 1.1 整体架构

数据工厂采用模块化架构，主要分为以下模块：

```
data_factory/
├── core/              # 核心数据生成逻辑
│   ├── generators/    # 数据生成器
│   └── relationships/ # 能力模板（数据关系）
├── template/          # 模板管理模块
├── output/            # 数据输出模块
├── visualization/     # 可视化工具（PyQt6）
├── webserver/         # Web应用
│   ├── api/           # API路由
│   ├── static/        # 前端静态文件
│   ├── models.py      # 数据库模型
│   └── app.py         # Web应用入口
├── utils/             # 工具函数（日志等）
├── config/            # 配置文件
└── main.py            # 主程序入口
```

### 1.2 模块职责

**core模块**
- `relationships/`: 定义能力模板基类和接口，实现各种数据关系的能力模板
- `generators/`: 数据生成器核心，协调多个能力模板生成数据

**template模块**
- 管理CSV输出模板配置
- 处理时间格式转换
- 管理列名和描述

**output模块**
- 负责数据导出逻辑
- 与模板管理模块分离
- 支持标准导出和增量导出

**visualization模块**
- PyQt6实现的数据可视化工具
- 支持数据预览和展示
- 支持时间窗口拖拽和缩放

**utils模块**
- 日志管理
- 其他工具函数

**webserver模块**
- `api/`: RESTful API路由（配置管理、数据生成、数据导出）
- `static/`: 前端静态文件（HTML、CSS、JavaScript）
- `models.py`: 数据库模型（SQLAlchemy）
- `app.py`: Sanic Web应用入口

## 2. 核心设计

### 2.1 能力模板系统

#### 2.1.1 设计理念

能力模板系统采用插件化架构，每个能力模板都是一个独立的数据生成能力单元。通过组合不同的能力模板，可以生成复杂的数据关系。

#### 2.1.2 类设计

**CapabilityTemplate（基类）**
```python
class CapabilityTemplate(ABC):
    - config: 配置字典
    - name: 模板名称
    - validate_config(): 验证配置
    - generate(): 生成数据（抽象方法）
    - get_dependencies(): 获取依赖
    - get_output_name(): 获取输出名称
```

**具体模板类**
- `TimePatternTemplate`: 时间规律变化模板
- `LagFollowTemplate`: 滞后线性跟随模板
- `PolynomialTemplate`: 多项式关系模板
- `CompositeCapabilityTemplate`: 组合能力模板

#### 2.1.3 模板注册机制

使用注册表模式管理模板类型：
```python
_TEMPLATE_REGISTRY = {
    'TimePatternTemplate': TimePatternTemplate,
    'LagFollowTemplate': LagFollowTemplate,
    ...
}
```

支持动态注册新模板：
```python
register_template('CustomTemplate', CustomTemplateClass)
```

### 2.2 数据生成器

#### 2.2.1 依赖解析

数据生成器需要解析能力模板之间的依赖关系，确定生成顺序。使用拓扑排序算法解决依赖问题。

#### 2.2.2 生成流程

1. 加载能力模板配置
2. 解析依赖关系，确定生成顺序
3. 按顺序生成数据
4. 构建DataFrame
5. 返回结果

### 2.3 模板管理

#### 2.3.1 时间格式处理

支持三种时间格式：
- `timestamp`: Unix时间戳
- `datetime`: 2024-1-1 00:00:00
- `datetime_slash`: 2024/1/1 00:00:05

#### 2.3.2 CSV格式生成

根据配置生成CSV文件：
- 可选标题行（变量名）
- 可选描述行（变量描述）
- 数据行

### 2.4 数据输出

#### 2.4.1 标准导出

一次性将数据写入CSV文件，适用于中小型数据集。

#### 2.4.2 增量导出

分块写入数据，适用于大型数据集，避免内存溢出。

### 2.5 可视化工具

#### 2.5.1 架构设计

使用PyQt6 + pyqtgraph实现：
- PyQt6: 主界面框架
- pyqtgraph: 高性能图表绘制

#### 2.5.2 功能实现

- **数据加载**: 支持CSV文件和DataFrame
- **显示控制**: 起始索引、显示点数、列选择
- **缩放功能**: 放大、缩小、重置视图
- **交互功能**: 鼠标拖拽、缩放

## 3. 数据流设计

### 3.1 数据生成流程

```
配置文件 → 数据生成器 → 能力模板 → 数据数组 → DataFrame
```

### 3.2 数据导出流程

```
DataFrame → 模板管理器（格式化） → 数据导出器 → CSV文件
```

### 3.3 数据可视化流程

```
CSV文件/DataFrame → 数据查看器 → 图表显示
```

## 4. 配置设计

### 4.1 配置文件结构

```json
{
  "generator": {
    "time_interval": 5.0,
    "history_points": 10000,
    "future_points": 120,
    "start_time": "2024-01-01 00:00:00",
    "templates": [...]
  },
  "template": {
    "time_format": "datetime",
    "has_title_row": true,
    "has_description_row": true,
    "column_descriptions": {...}
  }
}
```

### 4.2 能力模板配置

每个能力模板的配置包含：
- `type`: 模板类型
- `name`: 模板名称
- `config`: 模板特定配置

## 5. 扩展性设计

### 5.1 添加新能力模板

1. 继承`CapabilityTemplate`基类
2. 实现`validate_config()`和`generate()`方法
3. 注册模板类型
4. 在配置文件中使用

### 5.2 添加新时间格式

1. 在`TemplateManager`中添加新格式常量
2. 在`format_timestamp()`方法中添加格式化逻辑

### 5.3 添加新输出格式

1. 创建新的导出器类
2. 实现导出接口
3. 在主程序中集成

## 6. 性能优化

### 6.1 数据生成优化

- 使用NumPy数组操作，避免Python循环
- 批量处理数据点

### 6.2 内存优化

- 增量导出支持大数据集
- 及时释放不需要的数据

### 6.3 可视化优化

- 使用pyqtgraph高性能绘图
- 只渲染可见区域的数据点

## 7. 错误处理

### 7.1 配置验证

- 能力模板配置验证
- 依赖关系检查
- 参数范围检查

### 7.2 运行时错误

- 数据生成错误处理
- 文件操作错误处理
- 可视化错误处理

### 7.3 日志记录

- 记录所有关键操作
- 记录错误和警告
- 支持日志级别控制

## 8. 测试策略

### 8.1 单元测试

- 能力模板测试
- 数据生成器测试
- 模板管理测试

### 8.2 集成测试

- 端到端数据生成测试
- 配置加载测试
- 导出功能测试

### 8.3 可视化测试

- 界面功能测试
- 数据加载测试
- 交互功能测试

## 9. Web应用设计

### 9.1 架构设计

Web应用采用前后端分离架构：
- **后端**: Sanic异步Web框架
- **前端**: Vue.js 3 + Element Plus + ECharts
- **数据库**: SQLite + SQLAlchemy ORM

### 9.2 API设计

#### 9.2.1 RESTful API

**配置管理API**
- `GET /api/configs/` - 获取配置列表
- `GET /api/configs/:id` - 获取单个配置
- `POST /api/configs/` - 创建新配置
- `PUT /api/configs/:id` - 更新配置
- `DELETE /api/configs/:id` - 删除配置

**数据生成API**
- `POST /api/generate/` - 生成数据（返回JSON）
- `GET /api/preview/:id` - 预览数据（返回JSON，用于图表）

**数据导出API**
- `GET /api/export/:id?type=history` - 导出历史数据
- `GET /api/export/:id?type=full` - 导出完整数据

#### 9.2.2 数据库模型

**Config表**
- `id`: 主键
- `name`: 配置名称
- `config_yaml`: YAML配置内容
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 9.3 前端设计

#### 9.3.1 页面结构

- **配置列表页**: 显示所有保存的配置，支持增删改查
- **配置编辑页**: 可视化编辑YAML配置
- **数据预览页**: 图表展示生成的数据，支持导出

#### 9.3.2 技术栈

- **Vue.js 3**: 前端框架
- **Element Plus**: UI组件库
- **ECharts**: 数据可视化图表库

#### 9.3.3 功能实现

- **配置管理**: 完整的CRUD操作
- **数据预览**: 实时生成数据并图表展示
- **数据导出**: CSV文件下载
- **响应式设计**: 支持不同屏幕尺寸

### 9.4 数据流设计

#### 9.4.1 配置保存流程

```
前端表单 → POST /api/configs/ → 数据库存储 → 返回配置ID
```

#### 9.4.2 数据预览流程

```
配置ID → GET /api/preview/:id → 生成数据 → 返回JSON → ECharts渲染
```

#### 9.4.3 数据导出流程

```
配置ID → GET /api/export/:id → 生成数据 → 导出CSV → 文件下载
```

### 9.5 性能优化

- **异步处理**: Sanic异步框架提高并发性能
- **数据分页**: 预览数据只返回前1000点
- **临时文件**: 导出文件使用临时目录，下载后自动清理
- **前端优化**: 图表数据缩放，避免渲染过多数据点

