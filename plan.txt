# æ¨¡æ¿åº“åç«¯è®¾è®¡ä¸å‰ç«¯åŒæ­¥æ–¹æ¡ˆ

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 æ ¸å¿ƒæ€è·¯
- **å…ƒæ•°æ®å­˜å‚¨**ï¼šæ¨¡æ¿å…ƒæ•°æ®ï¼ˆåç§°ã€æè¿°ã€å›¾æ ‡ã€è¯¦æƒ…ç­‰ï¼‰å­˜å‚¨åœ¨ä»£ç æ–‡ä»¶ä¸­ï¼ˆ`core/relationships/metadata.py`ï¼‰
- **æ•°æ®åº“åŒæ­¥**ï¼šé€šè¿‡åŒæ­¥è„šæœ¬å°†å…ƒæ•°æ®åŒæ­¥åˆ°æ•°æ®åº“
- **APIæŸ¥è¯¢**ï¼šå‰ç«¯é€šè¿‡APIä»æ•°æ®åº“è¯»å–æ¨¡æ¿åˆ—è¡¨ï¼Œæ€§èƒ½å¥½
- **ç‰ˆæœ¬ç®¡ç†**ï¼šä½¿ç”¨å¤§ç‰ˆæœ¬å·ç®¡ç†æ¨¡æ¿æ›´æ–°
- **ä¸æ”¯æŒåˆ é™¤**ï¼šç®€åŒ–é€»è¾‘ï¼Œæ¨¡æ¿åªæ”¯æŒæ–°å¢å’Œæ›´æ–°ï¼Œä¸æ”¯æŒåˆ é™¤

### 1.2 å·¥ä½œæµç¨‹
1. ç®¡ç†å‘˜ä¿®æ”¹æ¨¡æ¿ä»£ç å’Œå…ƒæ•°æ®é…ç½®æ–‡ä»¶
2. æ‰§è¡ŒåŒæ­¥è„šæœ¬ï¼š`python webserver/sync_templates.py`
3. é‡å¯WebæœåŠ¡
4. å‰ç«¯è‡ªåŠ¨ä»æ•°æ®åº“è·å–æœ€æ–°æ¨¡æ¿åˆ—è¡¨

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„

```python
class Template(Base):
    """
    æ¨¡æ¿å…ƒæ•°æ®æ¨¡å‹
    
    å­˜å‚¨æ¨¡æ¿çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä»æ–‡ä»¶åŒæ­¥è€Œæ¥ã€‚
    ä¸æ”¯æŒåˆ é™¤ï¼Œåªæ”¯æŒæ–°å¢å’Œæ›´æ–°ã€‚
    """
    __tablename__ = 'templates'
    
    id = Column(Integer, primary_key=True, index=True)
    type = Column(String(100), nullable=False, unique=True, comment='æ¨¡æ¿ç±»å‹ï¼ˆå¦‚TimePatternTemplateï¼‰')
    name = Column(String(255), nullable=False, comment='æ¨¡æ¿ä¸­æ–‡åç§°')
    description = Column(Text, comment='æ¨¡æ¿ç®€çŸ­æè¿°')
    detail = Column(Text, comment='æ¨¡æ¿è¯¦ç»†è¯´æ˜')
    icon = Column(String(50), comment='å›¾æ ‡ï¼ˆemojiæˆ–å›¾æ ‡ä»£ç ï¼‰')
    category = Column(String(50), comment='åˆ†ç±»ï¼ˆå¦‚ï¼šåŸºç¡€æ¨¡æ¿ã€é«˜çº§æ¨¡æ¿ï¼‰')
    version = Column(String(50), nullable=False, comment='æ¨¡æ¿ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0, 2.0ï¼‰')
    created_at = Column(DateTime, default=datetime.now, comment='åˆ›å»ºæ—¶é—´')
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now, comment='æ›´æ–°æ—¶é—´')
```

### 2.2 å­—æ®µè¯´æ˜
- `type`: æ¨¡æ¿ç±»å‹æ ‡è¯†ç¬¦ï¼Œå”¯ä¸€ï¼Œå¯¹åº”æ¨¡æ¿æ³¨å†Œè¡¨ä¸­çš„key
- `name`: æ¨¡æ¿ä¸­æ–‡åç§°ï¼Œç”¨äºå‰ç«¯æ˜¾ç¤º
- `description`: ç®€çŸ­æè¿°ï¼Œç”¨äºæ¨¡æ¿å¡ç‰‡
- `detail`: è¯¦ç»†è¯´æ˜ï¼Œç”¨äºè¯¦æƒ…å±•ç¤ºåŒº
- `icon`: å›¾æ ‡ï¼ˆemojiæˆ–å›¾æ ‡ä»£ç ï¼‰
- `category`: åˆ†ç±»ï¼Œç”¨äºåˆ†ç»„æ˜¾ç¤º
- `version`: ç‰ˆæœ¬å·ï¼Œæ ¼å¼ï¼šä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š1.0, 2.0ï¼‰
- `created_at`: åˆ›å»ºæ—¶é—´ï¼ˆé¦–æ¬¡åŒæ­¥æ—¶ï¼‰
- `updated_at`: æ›´æ–°æ—¶é—´ï¼ˆæ¯æ¬¡åŒæ­¥æ—¶ï¼‰

## ä¸‰ã€å…ƒæ•°æ®é…ç½®æ–‡ä»¶è®¾è®¡

### 3.1 æ–‡ä»¶ä½ç½®
`core/relationships/metadata.py`

### 3.2 ç»“æ„è®¾è®¡

```python
# æ¨¡æ¿ç³»ç»Ÿç‰ˆæœ¬ï¼ˆå…¨å±€ç‰ˆæœ¬å·ï¼‰
TEMPLATE_SYSTEM_VERSION = '1.0'

TEMPLATE_METADATA = {
    'TimePatternTemplate': {
        'name': 'æ—¶é—´æ¨¡å¼æ¨¡æ¿',
        'description': 'ç”ŸæˆåŸºäºæ—¶é—´æ¨¡å¼çš„æ•°æ®ï¼ˆæ­£å¼¦æ³¢ã€æ–¹æ³¢ã€ä¸‰è§’æ³¢ç­‰ï¼‰',
        'icon': 'ğŸ“Š',
        'category': 'åŸºç¡€æ¨¡æ¿',
        'version': '1.0',  # æ¨¡æ¿ç‰ˆæœ¬å·
        'detail': '''æ—¶é—´æ¨¡å¼æ¨¡æ¿ç”¨äºç”Ÿæˆå…·æœ‰å‘¨æœŸæ€§è§„å¾‹çš„æ—¶é—´åºåˆ—æ•°æ®ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š
â€¢ æ”¯æŒå¤šç§æ³¢å½¢æ¨¡å¼ï¼šæ­£å¼¦æ³¢ã€æ–¹æ³¢ã€ä¸‰è§’æ³¢
â€¢ å¯é…ç½®æŒ¯å¹…ã€å‘¨æœŸã€ç›¸ä½ã€åç§»é‡ç­‰å‚æ•°
â€¢ æ”¯æŒæ·»åŠ å™ªå£°ä»¥æ¨¡æ‹ŸçœŸå®åœºæ™¯
â€¢ é€‚ç”¨äºæ¨¡æ‹Ÿå‘¨æœŸæ€§å˜åŒ–çš„æ•°æ®ï¼Œå¦‚å…‰ç…§å¼ºåº¦ã€æ¸©åº¦å˜åŒ–ç­‰

å¸¸ç”¨å‚æ•°ï¼š
- æŒ¯å¹…ï¼ˆamplitudeï¼‰ï¼šæ³¢å½¢çš„æœ€å¤§åç§»é‡
- å‘¨æœŸï¼ˆperiodï¼‰ï¼šä¸€ä¸ªå®Œæ•´æ³¢å½¢çš„æ—¶é—´é•¿åº¦ï¼ˆç§’ï¼‰
- ç›¸ä½ï¼ˆphaseï¼‰ï¼šæ³¢å½¢çš„èµ·å§‹ç›¸ä½ï¼ˆç§’ï¼‰
- åç§»é‡ï¼ˆoffsetï¼‰ï¼šæ³¢å½¢çš„åŸºå‡†å€¼
- å™ªå£°æ°´å¹³ï¼ˆnoise_levelï¼‰ï¼šéšæœºå™ªå£°çš„å¼ºåº¦ï¼ˆ0-1ï¼‰''',
    },
    # ... å…¶ä»–æ¨¡æ¿
}
```

### 3.3 å…ƒæ•°æ®å­—æ®µè¯´æ˜
- `name`: æ¨¡æ¿ä¸­æ–‡åç§°
- `description`: ç®€çŸ­æè¿°ï¼ˆä¸€è¡Œï¼‰
- `icon`: å›¾æ ‡ï¼ˆemojiï¼‰
- `category`: åˆ†ç±»
- `version`: æ¨¡æ¿ç‰ˆæœ¬å·
- `detail`: è¯¦ç»†è¯´æ˜ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼‰

## å››ã€åŒæ­¥æ¨¡å—è®¾è®¡

### 4.1 æ–‡ä»¶ä½ç½®
`webserver/sync_templates.py`

### 4.2 æ ¸å¿ƒé€»è¾‘

#### 4.2.1 åŒæ­¥æµç¨‹
1. è¯»å–æ¨¡æ¿æ³¨å†Œè¡¨ï¼ˆ`_TEMPLATE_REGISTRY`ï¼‰ï¼Œè·å–æ‰€æœ‰æ¨¡æ¿ç±»å‹
2. è¯»å–å…ƒæ•°æ®é…ç½®ï¼ˆ`TEMPLATE_METADATA`ï¼‰
3. æŸ¥è¯¢æ•°æ®åº“ä¸­çš„æ¨¡æ¿è®°å½•
4. å¯¹æ¯”å¤„ç†ï¼š
   - **æ–°å¢**ï¼šæ–‡ä»¶ä¸­å­˜åœ¨ä½†æ•°æ®åº“ä¸­ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°è®°å½•
   - **æ›´æ–°**ï¼šæ–‡ä»¶ä¸­å­˜åœ¨ä¸”æ•°æ®åº“ä¸­ä¹Ÿå­˜åœ¨ï¼š
     - ç‰ˆæœ¬å·ä¸åŒ â†’ æ›´æ–°æ‰€æœ‰å­—æ®µ
     - ç‰ˆæœ¬å·ç›¸åŒ â†’ æ£€æŸ¥å…¶ä»–å­—æ®µæ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰åˆ™æ›´æ–°
   - **ç¼ºå¤±**ï¼šæ•°æ®åº“ä¸­å­˜åœ¨ä½†æ–‡ä»¶ä¸­ä¸å­˜åœ¨ â†’ ä»…æç¤ºè­¦å‘Šï¼Œä¸åˆ é™¤

#### 4.2.2 ç‰ˆæœ¬å·æ£€æŸ¥
- ç‰ˆæœ¬å·å˜åŒ– â†’ æ›´æ–°æ‰€æœ‰å…ƒæ•°æ®å­—æ®µ
- ç‰ˆæœ¬å·ç›¸åŒ â†’ åªæ›´æ–°å…ƒæ•°æ®å­—æ®µï¼ˆç”¨äºä¿®å¤å…ƒæ•°æ®é”™è¯¯ï¼‰

#### 4.2.3 å‘½ä»¤è¡Œå‚æ•°
```bash
python webserver/sync_templates.py [--version VERSION]
```
- `--version`: æŒ‡å®šæ¨¡æ¿ç³»ç»Ÿç‰ˆæœ¬å·ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä»metadata.pyè¯»å–ï¼‰

### 4.3 è¾“å‡ºä¿¡æ¯
- âœ“ æ–°å¢æ¨¡æ¿ï¼šæ˜¾ç¤ºæ¨¡æ¿ç±»å‹å’Œç‰ˆæœ¬å·
- âœ“ æ›´æ–°æ¨¡æ¿ï¼šæ˜¾ç¤ºç‰ˆæœ¬å·å˜åŒ–ï¼ˆv1.0 -> v2.0ï¼‰
- âœ“ æ›´æ–°æ¨¡æ¿å…ƒæ•°æ®ï¼šç‰ˆæœ¬å·ä¸å˜ä½†å…ƒæ•°æ®æœ‰å˜åŒ–
- âš  è­¦å‘Šï¼šæ•°æ®åº“ä¸­å­˜åœ¨ä½†ä»£ç ä¸­ä¸å­˜åœ¨çš„æ¨¡æ¿ï¼ˆä¿ç•™ä¸å˜ï¼‰

## äº”ã€APIè®¾è®¡

### 5.1 æ–‡ä»¶ä½ç½®
`webserver/api/templates.py`

### 5.2 APIç«¯ç‚¹

#### 5.2.1 è·å–æ¨¡æ¿åˆ—è¡¨
```
GET /api/templates
```

**Query Parameters:**
- `category`: æŒ‰åˆ†ç±»ç­›é€‰ï¼ˆå¯é€‰ï¼‰

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "type": "TimePatternTemplate",
      "name": "æ—¶é—´æ¨¡å¼æ¨¡æ¿",
      "description": "ç”ŸæˆåŸºäºæ—¶é—´æ¨¡å¼çš„æ•°æ®ï¼ˆæ­£å¼¦æ³¢ã€æ–¹æ³¢ã€ä¸‰è§’æ³¢ç­‰ï¼‰",
      "detail": "...",
      "icon": "ğŸ“Š",
      "category": "åŸºç¡€æ¨¡æ¿",
      "version": "1.0",
      "created_at": "2025-01-01T00:00:00",
      "updated_at": "2025-01-01T00:00:00"
    },
    ...
  ]
}
```

#### 5.2.2 è·å–å•ä¸ªæ¨¡æ¿è¯¦æƒ…
```
GET /api/templates/<template_type>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "type": "TimePatternTemplate",
    "name": "æ—¶é—´æ¨¡å¼æ¨¡æ¿",
      ...
  }
}
```

## å…­ã€ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

### 6.1 ç‰ˆæœ¬å·è§„åˆ™
- æ ¼å¼ï¼š`ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·`ï¼ˆå¦‚ï¼š`1.0`, `2.0`ï¼‰
- **ä¸»ç‰ˆæœ¬å·**ï¼šæ¨¡æ¿è¡Œä¸ºå‘ç”Ÿé‡å¤§å˜åŒ–æ—¶é€’å¢
- **æ¬¡ç‰ˆæœ¬å·**ï¼šæ¨¡æ¿è¡Œä¸ºå°å¹…è°ƒæ•´æˆ–bugä¿®å¤æ—¶é€’å¢

### 6.2 ç‰ˆæœ¬æ›´æ–°åœºæ™¯

#### åœºæ™¯1ï¼šæ–°å¢æ¨¡æ¿
- åœ¨æ³¨å†Œè¡¨ä¸­æ·»åŠ æ–°æ¨¡æ¿
- åœ¨å…ƒæ•°æ®é…ç½®ä¸­æ·»åŠ å…ƒæ•°æ®ï¼Œè®¾ç½®ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š`1.0`ï¼‰
- æ‰§è¡ŒåŒæ­¥è„šæœ¬
- æ•°æ®åº“æ–°å¢è®°å½•

#### åœºæ™¯2ï¼šä¿®æ”¹æ¨¡æ¿ä»£ç ï¼ˆbugä¿®å¤ï¼‰
- ä¿®æ”¹æ¨¡æ¿ä»£ç æ–‡ä»¶
- å…ƒæ•°æ®ç‰ˆæœ¬å·ä¸å˜ï¼ˆå¦‚ä»ä¸º `1.0`ï¼‰
- æ‰§è¡ŒåŒæ­¥è„šæœ¬
- æ•°æ®åº“è®°å½•ä¸å˜ï¼ˆç‰ˆæœ¬å·ç›¸åŒï¼‰

#### åœºæ™¯3ï¼šæ¨¡æ¿è¡Œä¸ºå˜åŒ–ï¼ˆå¤§ç‰ˆæœ¬æ›´æ–°ï¼‰
- ä¿®æ”¹æ¨¡æ¿ä»£ç ï¼Œè¡Œä¸ºå‘ç”Ÿå˜åŒ–
- æ›´æ–°å…ƒæ•°æ®ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š`1.0` -> `2.0`ï¼‰
- æ‰§è¡ŒåŒæ­¥è„šæœ¬ï¼š`python sync_templates.py --version 2.0`
- æ•°æ®åº“è®°å½•æ›´æ–°ï¼Œç‰ˆæœ¬å·å˜ä¸º `2.0`
- å†å²é…ç½®ä»ä½¿ç”¨æ—§ç‰ˆæœ¬æ¨¡æ¿ï¼ˆå‘åå…¼å®¹ï¼‰

#### åœºæ™¯4ï¼šä¿®æ”¹å…ƒæ•°æ®ï¼ˆåç§°ã€æè¿°ç­‰ï¼‰
- ä¿®æ”¹å…ƒæ•°æ®é…ç½®
- ç‰ˆæœ¬å·ä¸å˜
- æ‰§è¡ŒåŒæ­¥è„šæœ¬
- æ•°æ®åº“è®°å½•æ›´æ–°å…ƒæ•°æ®å­—æ®µ

## ä¸ƒã€å‰ç«¯æ”¹é€ 

### 7.1 æ–‡ä»¶ä½ç½®
`webserver/frontend/src/components/TemplateLibrary.jsx`

### 7.2 æ”¹é€ å†…å®¹

#### 7.2.1 ç§»é™¤ç¡¬ç¼–ç 
- åˆ é™¤ç¡¬ç¼–ç çš„ `TEMPLATE_LIBRARY` å¸¸é‡
- ç§»é™¤æ¨¡æ¿å…ƒæ•°æ®çš„ç¡¬ç¼–ç 

#### 7.2.2 æ·»åŠ APIè°ƒç”¨
- æ·»åŠ  `useState` ç®¡ç†æ¨¡æ¿åˆ—è¡¨
- æ·»åŠ  `useEffect` åœ¨ç»„ä»¶åŠ è½½æ—¶è°ƒç”¨API
- ä½¿ç”¨ `getTemplates` APIè·å–æ¨¡æ¿åˆ—è¡¨

#### 7.2.3 APIå°è£…
åœ¨ `webserver/frontend/src/api/templates.js` ä¸­æ·»åŠ ï¼š
```javascript
export const getTemplates = (category = null) => {
  const params = category ? { category } : {}
  return api.get('/templates', { params })
}

export const getTemplate = (templateType) => {
  return api.get(`/templates/${templateType}`)
}
```

## å…«ã€å·¥ä½œæµç¨‹

### 8.1 æ—¥å¸¸æ›´æ–°æ¨¡æ¿
1. ä¿®æ”¹æ¨¡æ¿ä»£ç æ–‡ä»¶ï¼ˆ`core/relationships/*.py`ï¼‰
2. æ›´æ–°å…ƒæ•°æ®é…ç½®ï¼ˆ`core/relationships/metadata.py`ï¼Œå¦‚éœ€è¦ï¼‰
3. æ‰§è¡ŒåŒæ­¥ï¼š`python webserver/sync_templates.py`
4. é‡å¯WebæœåŠ¡ï¼š`python webserver/app.py`
5. å‰ç«¯è‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°æ¨¡æ¿

### 8.2 å¤§ç‰ˆæœ¬æ›´æ–°
1. ä¿®æ”¹æ¨¡æ¿ä»£ç ï¼ˆè¡Œä¸ºå˜åŒ–ï¼‰
2. æ›´æ–°å…ƒæ•°æ®ç‰ˆæœ¬å·ï¼ˆå¦‚ï¼š`1.0` -> `2.0`ï¼‰
3. æ‰§è¡ŒåŒæ­¥ï¼š`python webserver/sync_templates.py --version 2.0`
4. é‡å¯WebæœåŠ¡
5. æ–°é…ç½®ä½¿ç”¨æ–°ç‰ˆæœ¬æ¨¡æ¿ï¼Œå†å²é…ç½®ä¿æŒå…¼å®¹

### 8.3 æ–°å¢æ¨¡æ¿
1. åˆ›å»ºæ¨¡æ¿ä»£ç æ–‡ä»¶ï¼ˆ`core/relationships/new_template.py`ï¼‰
2. åœ¨æ³¨å†Œè¡¨ä¸­æ³¨å†Œï¼ˆ`core/relationships/__init__.py`ï¼‰
3. åœ¨å…ƒæ•°æ®é…ç½®ä¸­æ·»åŠ å…ƒæ•°æ®ï¼ˆ`core/relationships/metadata.py`ï¼‰
4. æ‰§è¡ŒåŒæ­¥è„šæœ¬
5. é‡å¯WebæœåŠ¡

## ä¹ã€ä¼˜åŠ¿æ€»ç»“

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šAPIä»æ•°æ®åº“è¯»å–ï¼Œå“åº”é€Ÿåº¦å¿«
2. **å¯æ§æ€§å¼º**ï¼šæ‰‹åŠ¨åŒæ­¥ï¼Œç®¡ç†å‘˜æ§åˆ¶æ›´æ–°æ—¶æœº
3. **å‘åå…¼å®¹**ï¼šå†å²é…ç½®ç»§ç»­æœ‰æ•ˆï¼Œä¸å—æ¨¡æ¿æ›´æ–°å½±å“
4. **ä»£ç å³æ–‡æ¡£**ï¼šå…ƒæ•°æ®åœ¨ä»£ç ä¸­ç»´æŠ¤ï¼Œæ˜“äºç®¡ç†
5. **å¢é‡æ›´æ–°**ï¼šåªæ›´æ–°å˜åŒ–çš„æ¨¡æ¿ï¼Œæ•ˆç‡é«˜
6. **å¯è¿½æº¯æ€§**ï¼šè®°å½•ç‰ˆæœ¬å·å’Œæ›´æ–°æ—¶é—´ï¼Œä¾¿äºè¿½è¸ª
7. **ç®€åŒ–é€»è¾‘**ï¼šä¸æ”¯æŒåˆ é™¤ï¼Œé¿å…å¤æ‚çš„åºŸå¼ƒå¤„ç†

## åã€å®ç°æ–‡ä»¶æ¸…å•

### 10.1 éœ€è¦åˆ›å»ºçš„æ–‡ä»¶
1. `core/relationships/metadata.py` - æ¨¡æ¿å…ƒæ•°æ®é…ç½®
2. `webserver/sync_templates.py` - æ¨¡æ¿åŒæ­¥è„šæœ¬
3. `webserver/api/templates.py` - æ¨¡æ¿API
4. `webserver/frontend/src/api/templates.js` - å‰ç«¯APIå°è£…

### 10.2 éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `webserver/models.py` - æ·»åŠ Templateæ¨¡å‹
2. `webserver/frontend/src/components/TemplateLibrary.jsx` - æ”¹ä¸ºä»APIè·å–
3. `webserver/app.py` - æ³¨å†Œtemplatesè“å›¾

### 10.3 æ•°æ®åº“è¿ç§»
- æ‰§è¡Œ `init_db()` æ—¶ä¼šè‡ªåŠ¨åˆ›å»º `templates` è¡¨
- é¦–æ¬¡åŒæ­¥æ—¶å¡«å……æ•°æ®

## åä¸€ã€æ³¨æ„äº‹é¡¹

1. **ç‰ˆæœ¬å·ç®¡ç†**ï¼šç¡®ä¿ç‰ˆæœ¬å·æ ¼å¼ä¸€è‡´ï¼ˆä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·ï¼‰
2. **åŒæ­¥æ—¶æœº**ï¼šæ¨¡æ¿ä»£ç ä¿®æ”¹åå¿…é¡»æ‰§è¡ŒåŒæ­¥è„šæœ¬
3. **æœåŠ¡é‡å¯**ï¼šåŒæ­¥åéœ€è¦é‡å¯WebæœåŠ¡æ‰èƒ½ç”Ÿæ•ˆ
4. **å†å²é…ç½®**ï¼šå·²å­˜åœ¨çš„é…ç½®ä¸­ä½¿ç”¨æ—§ç‰ˆæœ¬æ¨¡æ¿ä»ç„¶æœ‰æ•ˆ
5. **å…ƒæ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å…ƒæ•°æ®é…ç½®ä¸æ¨¡æ¿æ³¨å†Œè¡¨åŒæ­¥

## åäºŒã€æœªæ¥æ‰©å±•ï¼ˆå¯é€‰ï¼‰

### 12.1 é…ç½®æ–‡ä»¶å‡çº§æœºåˆ¶
å¦‚æœéœ€è¦æ”¯æŒé…ç½®æ–‡ä»¶çš„ç‰ˆæœ¬å‡çº§ï¼Œå¯ä»¥æ·»åŠ ï¼š
- `webserver/migrations/config_migrator.py` - é…ç½®è¿ç§»æ¨¡å—
- å½“æ¨¡æ¿ç³»ç»Ÿç‰ˆæœ¬å‡çº§æ—¶ï¼Œå‡çº§ç°æœ‰é…ç½®æ–‡ä»¶

### 12.2 æ¨¡æ¿åˆ†ç±»ç®¡ç†
- æ”¯æŒåŠ¨æ€åˆ†ç±»
- åˆ†ç±»çš„å¢åˆ æ”¹æŸ¥API

### 12.3 æ¨¡æ¿ä½¿ç”¨ç»Ÿè®¡
- è®°å½•æ¨¡æ¿ä½¿ç”¨æ¬¡æ•°
- ç»Ÿè®¡æœ€å¸¸ç”¨çš„æ¨¡æ¿

## åä¸‰ã€æµ‹è¯•è¦ç‚¹

1. **åŒæ­¥è„šæœ¬æµ‹è¯•**
   - æ–°å¢æ¨¡æ¿çš„åŒæ­¥
   - æ›´æ–°æ¨¡æ¿çš„åŒæ­¥
   - ç‰ˆæœ¬å·å˜åŒ–çš„å¤„ç†
   - å…ƒæ•°æ®å­—æ®µå˜åŒ–çš„å¤„ç†

2. **APIæµ‹è¯•**
   - è·å–æ¨¡æ¿åˆ—è¡¨
   - æŒ‰åˆ†ç±»ç­›é€‰
   - è·å–å•ä¸ªæ¨¡æ¿è¯¦æƒ…

3. **å‰ç«¯æµ‹è¯•**
   - æ¨¡æ¿åˆ—è¡¨åŠ è½½
   - æ¨¡æ¿è¯¦æƒ…æ˜¾ç¤º
   - æ‹–æ‹½åŠŸèƒ½æ­£å¸¸

4. **ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•**
   - å†å²é…ç½®ä½¿ç”¨æ—§ç‰ˆæœ¬æ¨¡æ¿
   - æ–°é…ç½®ä½¿ç”¨æ–°ç‰ˆæœ¬æ¨¡æ¿

---

## åå››ã€å½“å‰æ¨¡æ¿æƒ…å†µåˆ†æ

### 14.1 ç›®å‰æ”¯æŒçš„æ¨¡æ¿

#### åç«¯æ³¨å†Œè¡¨ï¼ˆ6ä¸ªæ¨¡æ¿ï¼‰
1. **TimePatternTemplate** - æ—¶é—´æ¨¡å¼æ¨¡æ¿
   - æ–‡ä»¶ï¼š`core/relationships/time_pattern.py`
   - åŠŸèƒ½ï¼šç”ŸæˆåŸºäºæ—¶é—´æ¨¡å¼çš„æ•°æ®ï¼ˆæ­£å¼¦æ³¢ã€æ–¹æ³¢ã€ä¸‰è§’æ³¢ç­‰ï¼‰
   - ä¾èµ–ï¼šæ— 
   - Configæ ¼å¼ï¼šåŒ…å«pattern_type, amplitude, period, phase, offset, trend, noise_level

2. **LagFollowTemplate** - æ»åè·Ÿéšæ¨¡æ¿
   - æ–‡ä»¶ï¼š`core/relationships/lag_follow.py`
   - åŠŸèƒ½ï¼šç”Ÿæˆè·Ÿéšå…¶ä»–å‚æ•°ä½†å­˜åœ¨æ»åçš„æ•°æ®
   - ä¾èµ–ï¼šsource_name
   - Configæ ¼å¼ï¼šåŒ…å«source_name, lag_seconds, sensitivity, initial_value, decay_rate, noise_level

3. **PolynomialTemplate** - å¤šé¡¹å¼æ¨¡æ¿
   - æ–‡ä»¶ï¼š`core/relationships/polynomial.py`
   - åŠŸèƒ½ï¼šç”ŸæˆåŸºäºå¤šé¡¹å¼å…³ç³»çš„æ•°æ®
   - ä¾èµ–ï¼šsource_namesï¼ˆå¤šä¸ªï¼‰
   - Configæ ¼å¼ï¼šåŒ…å«source_names, coefficients, lag_seconds, noise_level

4. **RandomPatternTemplate** - éšæœºæ•°æ¨¡æ¿
   - æ–‡ä»¶ï¼š`core/relationships/random_pattern.py`
   - åŠŸèƒ½ï¼šç”Ÿæˆéšæœºæ•°æ•°æ®
   - ä¾èµ–ï¼šæ— 
   - Configæ ¼å¼ï¼šåŒ…å«distribution, min_value, max_value, mean, std, step_range, seed

5. **NonlinearLagTemplate** - éçº¿æ€§æ»åæ¨¡æ¿
   - æ–‡ä»¶ï¼š`core/relationships/nonlinear_lag.py`
   - åŠŸèƒ½ï¼šæ”¯æŒå¤šä¸ªæ•°æ®ä¹‹é—´çš„éçº¿æ€§å…³ç³»ï¼Œå¹¶æ”¯æŒæ»å
   - ä¾èµ–ï¼šsource_namesï¼ˆå¤šä¸ªï¼‰
   - Configæ ¼å¼ï¼šåŒ…å«source_names, function, function_params, lag_seconds, noise_level

6. **CompositeCapabilityTemplate** - ç»„åˆæ¨¡æ¿
   - æ–‡ä»¶ï¼š`core/relationships/base.py`
   - åŠŸèƒ½ï¼šå°†å¤šä¸ªèƒ½åŠ›æ¨¡æ¿ç»„åˆåœ¨ä¸€èµ·
   - ä¾èµ–ï¼šåŠ¨æ€ï¼ˆå–å†³äºå­æ¨¡æ¿ï¼‰
   - Configæ ¼å¼ï¼šåŒ…å«templatesï¼ˆå­æ¨¡æ¿åˆ—è¡¨ï¼‰, combination_mode

#### å‰ç«¯ç¡¬ç¼–ç ï¼ˆ3ä¸ªæ¨¡æ¿ï¼‰
- TimePatternTemplate
- LagFollowTemplate
- PolynomialTemplate

**é—®é¢˜**ï¼šå‰ç«¯åªæ˜¾ç¤ºäº†3ä¸ªæ¨¡æ¿ï¼Œç¼ºå°‘äº†3ä¸ªæ¨¡æ¿ï¼ˆRandomPatternTemplate, NonlinearLagTemplate, CompositeCapabilityTemplateï¼‰

### 14.2 å½“å‰å­˜å‚¨æ–¹å¼å’Œä¿¡æ¯

#### åç«¯å­˜å‚¨æ–¹å¼
1. **ä»£ç æ–‡ä»¶**ï¼šæ¯ä¸ªæ¨¡æ¿ä¸€ä¸ªç‹¬ç«‹çš„Pythonæ–‡ä»¶
   - ä½ç½®ï¼š`core/relationships/*.py`
   - ç»“æ„ï¼š
     - æ–‡ä»¶çº§docstringï¼šæ¨¡å—è¯´æ˜
     - ç±»çº§docstringï¼šåŒ…å«Configæ ¼å¼è¯´æ˜
     - ç±»æ–¹æ³•ï¼švalidate_config(), generate(), get_dependencies()

2. **æ³¨å†Œè¡¨**ï¼š`core/relationships/__init__.py`
   - `_TEMPLATE_REGISTRY` å­—å…¸ï¼šæ˜ å°„æ¨¡æ¿ç±»å‹ååˆ°æ¨¡æ¿ç±»
   - æä¾› `get_template_class()` å’Œ `register_template()` å‡½æ•°

3. **å…ƒæ•°æ®å­˜å‚¨**ï¼š**ç›®å‰æ²¡æœ‰ç»Ÿä¸€çš„å…ƒæ•°æ®é…ç½®æ–‡ä»¶**
   - æ¨¡æ¿çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ˆåç§°ã€æè¿°ã€å›¾æ ‡ã€è¯¦æƒ…ï¼‰åˆ†æ•£åœ¨å‰ç«¯ç¡¬ç¼–ç 
   - åç«¯åªæœ‰ä»£ç å’Œdocstringï¼Œæ²¡æœ‰ç»“æ„åŒ–çš„å…ƒæ•°æ®

#### å‰ç«¯å­˜å‚¨æ–¹å¼
1. **ç¡¬ç¼–ç å¸¸é‡**ï¼š`webserver/frontend/src/components/TemplateLibrary.jsx`
   - `TEMPLATE_LIBRARY` æ•°ç»„ï¼šç¡¬ç¼–ç äº†3ä¸ªæ¨¡æ¿çš„å…ƒæ•°æ®
   - åŒ…å«å­—æ®µï¼štype, name, description, icon, detail

2. **é—®é¢˜**ï¼š
   - å‰åç«¯ä¸åŒæ­¥ï¼ˆåç«¯6ä¸ªï¼Œå‰ç«¯3ä¸ªï¼‰
   - å…ƒæ•°æ®ç¡¬ç¼–ç ï¼Œæ— æ³•åŠ¨æ€æ›´æ–°
   - æ–°å¢æ¨¡æ¿éœ€è¦æ‰‹åŠ¨ä¿®æ”¹å‰ç«¯ä»£ç 

### 14.3 æ¨¡æ¿ä»£ç ç»“æ„åˆ†æ

#### æ ‡å‡†æ¨¡æ¿ç±»ç»“æ„
```python
class TemplateName(CapabilityTemplate):
    """
    æ¨¡æ¿è¯´æ˜
    
    Configæ ¼å¼ï¼š
    {
        'name': '...',
        'output_name': '...',
        'param1': ...,
        'param2': ...,
    }
    """
    
    def validate_config(self):
        """éªŒè¯é…ç½®å‚æ•°"""
        pass
    
    def get_dependencies(self) -> List[str]:
        """è¿”å›ä¾èµ–çš„æ•°æ®åç§°åˆ—è¡¨"""
        return []
    
    def generate(self, time_points, other_data=None):
        """ç”Ÿæˆæ•°æ®"""
        pass
```

#### æ¨¡æ¿ä¿¡æ¯æå–ç‚¹
1. **ç±»å**ï¼šæ¨¡æ¿ç±»å‹ï¼ˆå¦‚ï¼šTimePatternTemplateï¼‰
2. **docstring**ï¼šåŒ…å«Configæ ¼å¼è¯´æ˜
3. **validate_configæ–¹æ³•**ï¼šå¯ä»¥æ¨æ–­å¿…éœ€å‚æ•°
4. **get_dependenciesæ–¹æ³•**ï¼šå¯ä»¥è·å–ä¾èµ–å…³ç³»

### 14.4 åç»­å»ºè®®

#### å»ºè®®1ï¼šåˆ›å»ºç»Ÿä¸€çš„å…ƒæ•°æ®é…ç½®æ–‡ä»¶
**æ–‡ä»¶ä½ç½®**ï¼š`core/relationships/metadata.py`

**ç»“æ„è®¾è®¡**ï¼š
```python
# æ¨¡æ¿ç³»ç»Ÿç‰ˆæœ¬
TEMPLATE_SYSTEM_VERSION = '1.0'

# æ¨¡æ¿å…ƒæ•°æ®é…ç½®
TEMPLATE_METADATA = {
    'TimePatternTemplate': {
        'name': 'æ—¶é—´æ¨¡å¼æ¨¡æ¿',
        'description': 'ç”ŸæˆåŸºäºæ—¶é—´æ¨¡å¼çš„æ•°æ®ï¼ˆæ­£å¼¦æ³¢ã€æ–¹æ³¢ã€ä¸‰è§’æ³¢ç­‰ï¼‰',
        'icon': 'ğŸ“Š',
        'category': 'åŸºç¡€æ¨¡æ¿',
        'version': '1.0',
        'detail': '''è¯¦ç»†è¯´æ˜...''',
        # å¯é€‰ï¼šå‚æ•°è¯´æ˜
        'parameters': {
            'pattern_type': {
                'type': 'select',
                'label': 'æ¨¡å¼ç±»å‹',
                'options': ['sinusoidal', 'linear', 'exponential'],
                'default': 'sinusoidal',
                'description': 'é€‰æ‹©æ—¶é—´æ¨¡å¼ç±»å‹',
            },
            'amplitude': {
                'type': 'number',
                'label': 'æŒ¯å¹…',
                'default': 100.0,
                'description': 'æ³¢å½¢çš„æœ€å¤§åç§»é‡',
            },
            # ... å…¶ä»–å‚æ•°
        },
    },
    # ... å…¶ä»–æ¨¡æ¿
}
```

#### å»ºè®®2ï¼šæ¨¡æ¿ä»£ç è§„èŒƒ

**æ–‡ä»¶ç»“æ„è§„èŒƒ**ï¼š
```python
"""
æ¨¡å—çº§æ–‡æ¡£å­—ç¬¦ä¸²
- ç®€è¦è¯´æ˜æ¨¡æ¿ç”¨é€”
- é€‚ç”¨åœºæ™¯
"""

import numpy as np
from typing import Dict, Any, Optional
from core.relationships.base import CapabilityTemplate


class TemplateName(CapabilityTemplate):
    """
    ç±»çº§æ–‡æ¡£å­—ç¬¦ä¸²ï¼ˆå¿…éœ€ï¼‰
    
    åŒ…å«ï¼š
    1. æ¨¡æ¿åŠŸèƒ½è¯´æ˜
    2. Configæ ¼å¼è¯´æ˜ï¼ˆå¿…éœ€ï¼‰
    3. å‚æ•°è¯´æ˜ï¼ˆå¯é€‰ï¼‰
    4. ä½¿ç”¨ç¤ºä¾‹ï¼ˆå¯é€‰ï¼‰
    
    Configæ ¼å¼ï¼š
    {
        'name': 'template_name',
        'output_name': 'F.output',
        'param1': value1,
        'param2': value2,
    }
    """
    
    def validate_config(self):
        """
        éªŒè¯é…ç½®å‚æ•°ï¼ˆå¿…éœ€ï¼‰
        
        åº”è¯¥ï¼š
        1. æ£€æŸ¥å¿…éœ€å‚æ•°æ˜¯å¦å­˜åœ¨
        2. æ£€æŸ¥å‚æ•°ç±»å‹æ˜¯å¦æ­£ç¡®
        3. æ£€æŸ¥å‚æ•°å€¼æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
        4. æŠ›å‡ºValueErrorå¼‚å¸¸è¯´æ˜é”™è¯¯
        """
        pass
    
    def get_dependencies(self) -> List[str]:
        """
        è·å–ä¾èµ–çš„æ•°æ®åç§°åˆ—è¡¨ï¼ˆå¿…éœ€ï¼‰
        
        è¿”å›ï¼š
        - ç©ºåˆ—è¡¨ï¼šæ— ä¾èµ–ï¼ˆå¦‚TimePatternTemplateï¼‰
        - åˆ—è¡¨ï¼šä¾èµ–çš„æ•°æ®åç§°ï¼ˆå¦‚LagFollowTemplateè¿”å›[source_name]ï¼‰
        """
        return []
    
    def generate(self, time_points: np.ndarray, 
                 other_data: Optional[Dict[str, np.ndarray]] = None) -> np.ndarray:
        """
        ç”Ÿæˆæ•°æ®ï¼ˆå¿…éœ€ï¼‰
        
        Args:
            time_points: æ—¶é—´ç‚¹æ•°ç»„ï¼ˆç§’ä¸ºå•ä½çš„æ—¶é—´æˆ³ï¼‰
            other_data: å…¶ä»–æ•°æ®å­—å…¸ï¼ˆå¦‚æœæœ‰ä¾èµ–ï¼‰
        
        Returns:
            ç”Ÿæˆçš„æ•°æ®æ•°ç»„ï¼Œé•¿åº¦ä¸time_pointsç›¸åŒ
        """
        pass
```

#### å»ºè®®3ï¼šå…ƒæ•°æ®é…ç½®è§„èŒƒ

**å¿…éœ€å­—æ®µ**ï¼š
- `name`: æ¨¡æ¿ä¸­æ–‡åç§°
- `description`: ç®€çŸ­æè¿°ï¼ˆä¸€è¡Œï¼‰
- `icon`: å›¾æ ‡ï¼ˆemojiï¼‰
- `category`: åˆ†ç±»
- `version`: ç‰ˆæœ¬å·

**å¯é€‰å­—æ®µ**ï¼š
- `detail`: è¯¦ç»†è¯´æ˜ï¼ˆå¤šè¡Œæ–‡æœ¬ï¼‰
- `parameters`: å‚æ•°è¯´æ˜å­—å…¸ï¼ˆç”¨äºå‰ç«¯è¡¨å•ç”Ÿæˆï¼‰

**åˆ†ç±»å»ºè®®**ï¼š
- `åŸºç¡€æ¨¡æ¿`ï¼šTimePatternTemplate, RandomPatternTemplate
- `å…³ç³»æ¨¡æ¿`ï¼šLagFollowTemplate, PolynomialTemplate, NonlinearLagTemplate
- `ç»„åˆæ¨¡æ¿`ï¼šCompositeCapabilityTemplate

#### å»ºè®®4ï¼šæ–°å¢æ¨¡æ¿çš„å·¥ä½œæµç¨‹

1. **åˆ›å»ºæ¨¡æ¿ä»£ç æ–‡ä»¶**
   - åœ¨ `core/relationships/` ç›®å½•ä¸‹åˆ›å»ºæ–°æ–‡ä»¶
   - ç»§æ‰¿ `CapabilityTemplate`
   - å®ç°å¿…éœ€æ–¹æ³•

2. **æ³¨å†Œæ¨¡æ¿**
   - åœ¨ `core/relationships/__init__.py` ä¸­å¯¼å…¥
   - æ·»åŠ åˆ° `_TEMPLATE_REGISTRY`

3. **æ·»åŠ å…ƒæ•°æ®**
   - åœ¨ `core/relationships/metadata.py` ä¸­æ·»åŠ å…ƒæ•°æ®é…ç½®
   - è®¾ç½®ç‰ˆæœ¬å·ä¸º `1.0`ï¼ˆæ–°æ¨¡æ¿ï¼‰

4. **æ‰§è¡ŒåŒæ­¥**
   - è¿è¡Œ `python webserver/sync_templates.py`
   - é‡å¯WebæœåŠ¡

5. **å‰ç«¯è‡ªåŠ¨æ˜¾ç¤º**
   - å‰ç«¯ä»APIè·å–æ¨¡æ¿åˆ—è¡¨
   - è‡ªåŠ¨æ˜¾ç¤ºæ–°æ¨¡æ¿

#### å»ºè®®5ï¼šæ¨¡æ¿ä»£ç å’Œé…ç½®æ–‡ä»¶çš„ç»„ç»‡æ–¹å¼

**å½“å‰æ–¹å¼**ï¼š
- ä»£ç æ–‡ä»¶ï¼š`core/relationships/template_name.py`
- å…ƒæ•°æ®ï¼šåˆ†æ•£åœ¨å‰ç«¯ï¼ˆéœ€è¦æ”¹ä¸ºç»Ÿä¸€é…ç½®æ–‡ä»¶ï¼‰

**æ¨èæ–¹å¼**ï¼š
```
core/relationships/
â”œâ”€â”€ __init__.py              # æ³¨å†Œè¡¨
â”œâ”€â”€ base.py                  # åŸºç±»
â”œâ”€â”€ metadata.py              # å…ƒæ•°æ®é…ç½®ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ time_pattern.py          # æ—¶é—´æ¨¡å¼æ¨¡æ¿
â”œâ”€â”€ lag_follow.py            # æ»åè·Ÿéšæ¨¡æ¿
â”œâ”€â”€ polynomial.py            # å¤šé¡¹å¼æ¨¡æ¿
â”œâ”€â”€ random_pattern.py        # éšæœºæ•°æ¨¡æ¿
â”œâ”€â”€ nonlinear_lag.py         # éçº¿æ€§æ»åæ¨¡æ¿
â””â”€â”€ ...                      # æœªæ¥æ–°å¢çš„æ¨¡æ¿
```

**å…ƒæ•°æ®é…ç½®æ–‡ä»¶ç»“æ„**ï¼š
```python
# core/relationships/metadata.py

TEMPLATE_SYSTEM_VERSION = '1.0'

TEMPLATE_METADATA = {
    # æ¯ä¸ªæ¨¡æ¿çš„å…ƒæ•°æ®
    'TemplateType': {
        'name': '...',
        'description': '...',
        'icon': '...',
        'category': '...',
        'version': '1.0',
        'detail': '''...''',
    },
}
```

#### å»ºè®®6ï¼šå‚æ•°è¯´æ˜çš„å¯é€‰æ‰©å±•

**å½“å‰**ï¼šå‚æ•°è¯´æ˜åœ¨docstringä¸­ï¼Œéš¾ä»¥ç»“æ„åŒ–æå–

**å»ºè®®**ï¼šåœ¨å…ƒæ•°æ®é…ç½®ä¸­æ·»åŠ  `parameters` å­—æ®µï¼ˆå¯é€‰ï¼‰
```python
'parameters': {
    'param_name': {
        'type': 'number|select|text|boolean',
        'label': 'å‚æ•°æ ‡ç­¾',
        'default': é»˜è®¤å€¼,
        'description': 'å‚æ•°è¯´æ˜',
        'options': [...],  # å¦‚æœæ˜¯selectç±»å‹
        'min': æœ€å°å€¼,      # å¦‚æœæ˜¯numberç±»å‹
        'max': æœ€å¤§å€¼,
    },
}
```

**ä¼˜åŠ¿**ï¼š
- å‰ç«¯å¯ä»¥æ ¹æ®parametersè‡ªåŠ¨ç”Ÿæˆè¡¨å•
- å‚æ•°éªŒè¯æ›´è§„èŒƒ
- ç”¨æˆ·ä½“éªŒæ›´å¥½

**æ³¨æ„**ï¼šè¿™æ˜¯å¯é€‰åŠŸèƒ½ï¼Œå¯ä»¥å…ˆå®ç°åŸºç¡€ç‰ˆæœ¬ï¼Œåç»­å†æ‰©å±•

### 14.5 æ€»ç»“

**å½“å‰çŠ¶æ€**ï¼š
- âœ… åç«¯æœ‰å®Œæ•´çš„æ¨¡æ¿ä»£ç å’Œæ³¨å†Œæœºåˆ¶
- âœ… æ¨¡æ¿ç±»æœ‰æ¸…æ™°çš„docstringè¯´æ˜
- âŒ ç¼ºå°‘ç»Ÿä¸€çš„å…ƒæ•°æ®é…ç½®æ–‡ä»¶
- âŒ å‰ç«¯ç¡¬ç¼–ç ï¼Œå‰åç«¯ä¸åŒæ­¥
- âŒ ç¼ºå°‘3ä¸ªæ¨¡æ¿çš„å‰ç«¯æ˜¾ç¤º

**æ¨èæ–¹æ¡ˆ**ï¼š
1. åˆ›å»º `core/relationships/metadata.py` ç»Ÿä¸€ç®¡ç†å…ƒæ•°æ®
2. æ‰€æœ‰6ä¸ªæ¨¡æ¿éƒ½è¦æ·»åŠ å…ƒæ•°æ®é…ç½®
3. å…ƒæ•°æ®åŒ…å«ï¼šname, description, icon, category, version, detail
4. å¯é€‰ï¼šæ·»åŠ parameterså­—æ®µç”¨äºå‰ç«¯è¡¨å•ç”Ÿæˆ
5. é€šè¿‡åŒæ­¥è„šæœ¬å°†å…ƒæ•°æ®åŒæ­¥åˆ°æ•°æ®åº“
6. å‰ç«¯ä»APIè·å–æ¨¡æ¿åˆ—è¡¨ï¼Œç§»é™¤ç¡¬ç¼–ç 

---

## åäº”ã€æ¨¡æ¿æ¶æ„ä¼˜åŒ–å»ºè®®

### 15.1 å½“å‰æ¨¡æ¿è®¾è®¡é—®é¢˜åˆ†æ

#### é—®é¢˜1ï¼šåŠŸèƒ½é‡å å’Œæ··ä¹±
**å½“å‰6ä¸ªæ¨¡æ¿çš„åŠŸèƒ½åˆ†å¸ƒ**ï¼š
1. **TimePatternTemplate** - æ—¶é—´æ¨¡å¼ï¼ˆç‹¬ç«‹ç”Ÿæˆï¼Œä¸ä¾èµ–å…¶ä»–æ•°æ®ï¼‰
2. **LagFollowTemplate** - æ»åè·Ÿéšï¼ˆä¾èµ–1ä¸ªæ•°æ®æºï¼Œæœ‰æ»åï¼Œçº¿æ€§å…³ç³»ï¼‰
3. **PolynomialTemplate** - å¤šé¡¹å¼ï¼ˆä¾èµ–å¤šä¸ªæ•°æ®æºï¼Œçº¿æ€§å…³ç³»ï¼Œå¯é€‰æ»åï¼‰
4. **RandomPatternTemplate** - éšæœºæ•°ï¼ˆç‹¬ç«‹ç”Ÿæˆï¼Œä¸ä¾èµ–å…¶ä»–æ•°æ®ï¼‰
5. **NonlinearLagTemplate** - éçº¿æ€§æ»åï¼ˆä¾èµ–å¤šä¸ªæ•°æ®æºï¼Œéçº¿æ€§å…³ç³»ï¼Œæœ‰æ»åï¼‰
6. **CompositeCapabilityTemplate** - ç»„åˆæ¨¡æ¿ï¼ˆç»„åˆå…¶ä»–æ¨¡æ¿ï¼‰

**é—®é¢˜åˆ†æ**ï¼š
- **åŠŸèƒ½é‡å **ï¼š
  - `LagFollowTemplate` å’Œ `NonlinearLagTemplate` éƒ½æœ‰æ»ååŠŸèƒ½
  - `PolynomialTemplate` å’Œ `NonlinearLagTemplate` éƒ½æ”¯æŒå¤šæ•°æ®æº
  - `PolynomialTemplate` å’Œ `NonlinearLagTemplate` éƒ½æœ‰éçº¿æ€§å…³ç³»ï¼ˆå¤šé¡¹å¼ä¹Ÿæ˜¯éçº¿æ€§çš„ä¸€ç§ï¼‰
  - `PolynomialTemplate` å·²ç»æœ‰ `lag_seconds` å‚æ•°ï¼Œä¸ `NonlinearLagTemplate` çš„æ»ååŠŸèƒ½é‡å 

- **åˆ†ç±»ä¸æ¸…æ™°**ï¼š
  - ç‹¬ç«‹ç”Ÿæˆ vs ä¾èµ–å…¶ä»–æ•°æ®
  - çº¿æ€§å…³ç³» vs éçº¿æ€§å…³ç³»
  - æœ‰æ»å vs æ— æ»å
  - å•æ•°æ®æº vs å¤šæ•°æ®æº

- **å‘½åæ··ä¹±**ï¼š
  - `LagFollowTemplate` å¼ºè°ƒ"æ»åè·Ÿéš"
  - `NonlinearLagTemplate` å¼ºè°ƒ"éçº¿æ€§æ»å"
  - ä½†å®é™…ä¸Š `PolynomialTemplate` ä¹Ÿå¯ä»¥æœ‰æ»åï¼ˆ`lag_seconds`å‚æ•°ï¼‰

- **æ¶æ„é—®é¢˜**ï¼š
  - æ²¡æœ‰æ¸…æ™°çš„å±‚æ¬¡ç»“æ„
  - åŠŸèƒ½åˆ†æ•£ï¼Œéš¾ä»¥ç†è§£
  - æ‰©å±•æ€§å·®

### 15.2 ä¼˜åŒ–æ–¹æ¡ˆï¼šåˆ†å±‚æ¶æ„è®¾è®¡

#### æ–¹æ¡ˆAï¼šæŒ‰æ•°æ®æºåˆ†ç±»ï¼ˆæ¨èï¼‰

**ç¬¬ä¸€å±‚ï¼šæ•°æ®æºç±»å‹**
- **ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼ˆIndependentTemplateï¼‰ï¼šä¸ä¾èµ–å…¶ä»–æ•°æ®
  - TimePatternTemplateï¼ˆæ—¶é—´æ¨¡å¼ï¼‰
  - RandomPatternTemplateï¼ˆéšæœºæ•°ï¼‰

- **ä¾èµ–å…³ç³»æ¨¡æ¿**ï¼ˆDependentTemplateï¼‰ï¼šä¾èµ–å…¶ä»–æ•°æ®
  - æ‰€æœ‰éœ€è¦å…¶ä»–æ•°æ®æºçš„æ¨¡æ¿

**ç¬¬äºŒå±‚ï¼šå…³ç³»ç±»å‹**
- **çº¿æ€§å…³ç³»æ¨¡æ¿**ï¼ˆLinearRelationTemplateï¼‰
  - LagFollowTemplateï¼ˆå•æ•°æ®æºï¼Œçº¿æ€§ï¼Œæœ‰æ»åï¼‰
  - PolynomialTemplateï¼ˆå¤šæ•°æ®æºï¼Œçº¿æ€§ï¼Œå¯é€‰æ»åï¼‰

- **éçº¿æ€§å…³ç³»æ¨¡æ¿**ï¼ˆNonlinearRelationTemplateï¼‰
  - NonlinearLagTemplateï¼ˆå¤šæ•°æ®æºï¼Œéçº¿æ€§ï¼Œæœ‰æ»åï¼‰

**ç¬¬ä¸‰å±‚ï¼šç»„åˆæ¨¡æ¿**
- CompositeCapabilityTemplateï¼ˆç»„åˆå…¶ä»–æ¨¡æ¿ï¼‰

**é—®é¢˜**ï¼šè¿™ä¸ªæ–¹æ¡ˆä»ç„¶æœ‰é‡å ï¼ŒPolynomialTemplateå’ŒNonlinearLagTemplateçš„åŒºåˆ«ä¸å¤Ÿæ¸…æ™°ã€‚

#### æ–¹æ¡ˆBï¼šæŒ‰åŠŸèƒ½ç»´åº¦ç»„åˆï¼ˆæ›´æ¸…æ™°ï¼‰

**ç»´åº¦1ï¼šæ•°æ®æºæ•°é‡**
- å•æ•°æ®æºï¼ˆSingleSourceï¼‰
- å¤šæ•°æ®æºï¼ˆMultiSourceï¼‰
- æ— æ•°æ®æºï¼ˆIndependentï¼‰

**ç»´åº¦2ï¼šå…³ç³»ç±»å‹**
- çº¿æ€§ï¼ˆLinearï¼‰
- éçº¿æ€§ï¼ˆNonlinearï¼‰

**ç»´åº¦3ï¼šæ»å**
- æ— æ»åï¼ˆNoLagï¼‰
- æœ‰æ»åï¼ˆWithLagï¼‰

**ç»„åˆç»“æœ**ï¼š
1. **ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼ˆIndependentï¼‰
   - TimePatternTemplateï¼ˆæ—¶é—´æ¨¡å¼ï¼‰
   - RandomPatternTemplateï¼ˆéšæœºæ•°ï¼‰

2. **å•æ•°æ®æºçº¿æ€§æ— æ»å**ï¼ˆSingleSource + Linear + NoLagï¼‰
   - å½“å‰æ²¡æœ‰ï¼Œä½†å¯ä»¥æ·»åŠ ï¼š`LinearFollowTemplate`

3. **å•æ•°æ®æºçº¿æ€§æœ‰æ»å**ï¼ˆSingleSource + Linear + WithLagï¼‰
   - LagFollowTemplate

4. **å¤šæ•°æ®æºçº¿æ€§æ— æ»å**ï¼ˆMultiSource + Linear + NoLagï¼‰
   - PolynomialTemplateï¼ˆlag_seconds=0æ—¶ï¼‰

5. **å¤šæ•°æ®æºçº¿æ€§æœ‰æ»å**ï¼ˆMultiSource + Linear + WithLagï¼‰
   - PolynomialTemplateï¼ˆlag_seconds>0æ—¶ï¼‰

6. **å¤šæ•°æ®æºéçº¿æ€§æœ‰æ»å**ï¼ˆMultiSource + Nonlinear + WithLagï¼‰
   - NonlinearLagTemplate

7. **ç»„åˆæ¨¡æ¿**
   - CompositeCapabilityTemplate

**é—®é¢˜**ï¼šè¿™ä¸ªæ–¹æ¡ˆä¼šå¯¼è‡´æ¨¡æ¿æ•°é‡å¢åŠ ï¼Œè€Œä¸”PolynomialTemplateéœ€è¦æ‹†åˆ†æˆä¸¤ä¸ªæ¨¡æ¿ã€‚

#### æ–¹æ¡ˆCï¼šç»Ÿä¸€å…³ç³»æ¨¡æ¿ + å‚æ•°åŒ–ï¼ˆæœ€ä¼˜é›…ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šå°†å…³ç³»æ¨¡æ¿ç»Ÿä¸€ä¸ºä¸€ä¸ªæ¨¡æ¿ï¼Œé€šè¿‡å‚æ•°æ§åˆ¶è¡Œä¸ºã€‚

**æ–°æ¶æ„**ï¼š

1. **ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼ˆIndependentTemplateï¼‰
   - TimePatternTemplateï¼ˆæ—¶é—´æ¨¡å¼ï¼‰
   - RandomPatternTemplateï¼ˆéšæœºæ•°ï¼‰

2. **ç»Ÿä¸€å…³ç³»æ¨¡æ¿**ï¼ˆRelationTemplateï¼‰
   - æ”¯æŒå•æ•°æ®æºæˆ–å¤šæ•°æ®æº
   - æ”¯æŒçº¿æ€§æˆ–éçº¿æ€§å…³ç³»
   - æ”¯æŒæœ‰æ»åæˆ–æ— æ»å
   - é€šè¿‡å‚æ•°æ§åˆ¶ï¼š
     - `source_names`: æ•°æ®æºåˆ—è¡¨ï¼ˆå•/å¤šï¼‰
     - `relation_type`: å…³ç³»ç±»å‹ï¼ˆlinear/polynomial/nonlinearï¼‰
     - `lag_seconds`: æ»åæ—¶é—´ï¼ˆ0è¡¨ç¤ºæ— æ»åï¼‰
     - `function`: éçº¿æ€§å‡½æ•°ç±»å‹ï¼ˆsqrt/log/exp/powerï¼‰
     - `coefficients`: ç³»æ•°é…ç½®ï¼ˆç”¨äºå¤šé¡¹å¼ï¼‰

3. **ç»„åˆæ¨¡æ¿**ï¼ˆCompositeTemplateï¼‰
   - CompositeCapabilityTemplate

**ä¼˜åŠ¿**ï¼š
- ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºç†è§£
- å‡å°‘æ¨¡æ¿æ•°é‡
- å‚æ•°åŒ–è®¾è®¡ï¼Œçµæ´»æ€§å¼º
- é¿å…åŠŸèƒ½é‡å 

**é—®é¢˜**ï¼š
- éœ€è¦é‡æ„ç°æœ‰æ¨¡æ¿
- é…ç½®å¯èƒ½å˜å¾—å¤æ‚

#### æ–¹æ¡ˆDï¼šä¿æŒç°çŠ¶ + æ¸…æ™°åˆ†ç±»ï¼ˆæœ€å®ç”¨ï¼‰

**ä¿æŒç°æœ‰6ä¸ªæ¨¡æ¿ï¼Œä½†é‡æ–°åˆ†ç±»å’Œå‘½å**ï¼š

**åˆ†ç±»1ï¼šç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼ˆIndependent Generationï¼‰
- TimePatternTemplate â†’ **TimePatternTemplate**ï¼ˆæ—¶é—´æ¨¡å¼æ¨¡æ¿ï¼‰
- RandomPatternTemplate â†’ **RandomPatternTemplate**ï¼ˆéšæœºæ•°æ¨¡æ¿ï¼‰

**åˆ†ç±»2ï¼šçº¿æ€§å…³ç³»æ¨¡æ¿**ï¼ˆLinear Relationsï¼‰
- LagFollowTemplate â†’ **LinearLagFollowTemplate**ï¼ˆçº¿æ€§æ»åè·Ÿéšæ¨¡æ¿ï¼‰
  - å•æ•°æ®æºï¼Œçº¿æ€§å…³ç³»ï¼Œæœ‰æ»å
- PolynomialTemplate â†’ **PolynomialTemplate**ï¼ˆå¤šé¡¹å¼æ¨¡æ¿ï¼‰
  - å¤šæ•°æ®æºï¼Œçº¿æ€§å…³ç³»ï¼ˆå¤šé¡¹å¼æ˜¯çº¿æ€§çš„ï¼‰ï¼Œå¯é€‰æ»å

**åˆ†ç±»3ï¼šéçº¿æ€§å…³ç³»æ¨¡æ¿**ï¼ˆNonlinear Relationsï¼‰
- NonlinearLagTemplate â†’ **NonlinearLagTemplate**ï¼ˆéçº¿æ€§æ»åæ¨¡æ¿ï¼‰
  - å¤šæ•°æ®æºï¼Œéçº¿æ€§å…³ç³»ï¼ˆsqrt/log/exp/powerï¼‰ï¼Œæœ‰æ»å

**åˆ†ç±»4ï¼šç»„åˆæ¨¡æ¿**ï¼ˆCompositeï¼‰
- CompositeCapabilityTemplate â†’ **CompositeTemplate**ï¼ˆç»„åˆæ¨¡æ¿ï¼‰

**ä¼˜åŒ–ç‚¹**ï¼š
1. **é‡å‘½å**ï¼š`LagFollowTemplate` â†’ `LinearLagFollowTemplate`ï¼Œæ˜ç¡®æ˜¯çº¿æ€§å…³ç³»
2. **æ–‡æ¡£è¯´æ˜**ï¼šæ˜ç¡®æ¯ä¸ªæ¨¡æ¿çš„é€‚ç”¨åœºæ™¯å’ŒåŒºåˆ«
3. **å…ƒæ•°æ®åˆ†ç±»**ï¼š
   - `ç‹¬ç«‹ç”Ÿæˆ`ï¼šTimePatternTemplate, RandomPatternTemplate
   - `çº¿æ€§å…³ç³»`ï¼šLinearLagFollowTemplate, PolynomialTemplate
   - `éçº¿æ€§å…³ç³»`ï¼šNonlinearLagTemplate
   - `ç»„åˆæ¨¡æ¿`ï¼šCompositeTemplate

### 15.3 æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆDï¼ˆä¿æŒç°çŠ¶ + æ¸…æ™°åˆ†ç±»ï¼‰

**ç†ç”±**ï¼š
1. **æœ€å°æ”¹åŠ¨**ï¼šä¸éœ€è¦é‡æ„ç°æœ‰ä»£ç 
2. **æ¸…æ™°åˆ†ç±»**ï¼šé€šè¿‡åˆ†ç±»å’Œå‘½åæ˜ç¡®æ¯ä¸ªæ¨¡æ¿çš„å®šä½
3. **æ˜“äºç†è§£**ï¼šç”¨æˆ·å¯ä»¥æ ¹æ®åˆ†ç±»å¿«é€Ÿæ‰¾åˆ°åˆé€‚çš„æ¨¡æ¿
4. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰æ¨¡æ¿ç±»å‹åä¸å˜ï¼ˆå†…éƒ¨é‡å‘½åå¯é€‰ï¼‰

**å®æ–½æ­¥éª¤**ï¼š
1. **å…ƒæ•°æ®åˆ†ç±»**ï¼š
   - `ç‹¬ç«‹ç”Ÿæˆ`ï¼šTimePatternTemplate, RandomPatternTemplate
   - `çº¿æ€§å…³ç³»`ï¼šLagFollowTemplate, PolynomialTemplate
   - `éçº¿æ€§å…³ç³»`ï¼šNonlinearLagTemplate
   - `ç»„åˆæ¨¡æ¿`ï¼šCompositeCapabilityTemplate

2. **æ–‡æ¡£å®Œå–„**ï¼š
   - æ˜ç¡®æ¯ä¸ªæ¨¡æ¿çš„é€‚ç”¨åœºæ™¯
   - è¯´æ˜æ¨¡æ¿ä¹‹é—´çš„åŒºåˆ«
   - æä¾›é€‰æ‹©æŒ‡å—

3. **å¯é€‰é‡å‘½å**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   - `LagFollowTemplate` â†’ `LinearLagFollowTemplate`ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç å’Œé…ç½®ï¼‰
   - æˆ–è€…ä¿æŒåŸåï¼Œåœ¨å…ƒæ•°æ®ä¸­è¯´æ˜æ˜¯"çº¿æ€§æ»åè·Ÿéš"

### 15.4 æ¨¡æ¿é€‰æ‹©æŒ‡å—ï¼ˆç»™ç”¨æˆ·çš„å»ºè®®ï¼‰

**å¦‚ä½•é€‰æ‹©æ¨¡æ¿**ï¼š

1. **éœ€è¦ç‹¬ç«‹ç”Ÿæˆæ•°æ®ï¼Œä¸ä¾èµ–å…¶ä»–å‚æ•°**ï¼š
   - æ—¶é—´æ¨¡å¼ â†’ `TimePatternTemplate`
   - éšæœºæ•° â†’ `RandomPatternTemplate`

2. **éœ€è¦è·Ÿéšå…¶ä»–å‚æ•°ï¼Œçº¿æ€§å…³ç³»**ï¼š
   - å•æ•°æ®æº + æœ‰æ»å â†’ `LagFollowTemplate`
   - å¤šæ•°æ®æº + å¯é€‰æ»å â†’ `PolynomialTemplate`

3. **éœ€è¦éçº¿æ€§å…³ç³»**ï¼š
   - å¤šæ•°æ®æº + éçº¿æ€§å‡½æ•°ï¼ˆsqrt/log/exp/powerï¼‰ â†’ `NonlinearLagTemplate`

4. **éœ€è¦ç»„åˆå¤šä¸ªæ¨¡æ¿**ï¼š
   - ç»„åˆå¤šä¸ªæ¨¡æ¿ â†’ `CompositeCapabilityTemplate`

### 15.5 æœªæ¥æ‰©å±•å»ºè®®

**å¦‚æœéœ€è¦æ–°å¢æ¨¡æ¿ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹ç»´åº¦è€ƒè™‘**ï¼š

1. **æ•°æ®æºç»´åº¦**ï¼šå•æ•°æ®æº vs å¤šæ•°æ®æº
2. **å…³ç³»ç»´åº¦**ï¼šçº¿æ€§ vs éçº¿æ€§
3. **æ»åç»´åº¦**ï¼šæ— æ»å vs æœ‰æ»å
4. **å‡½æ•°ç»´åº¦**ï¼šä¸åŒçš„æ•°å­¦å‡½æ•°

**é¿å…åˆ›å»ºåŠŸèƒ½é‡å çš„æ¨¡æ¿**ï¼Œä¼˜å…ˆè€ƒè™‘ï¼š
- å‚æ•°åŒ–ç°æœ‰æ¨¡æ¿
- ç»„åˆç°æœ‰æ¨¡æ¿
- åªæœ‰åœ¨ç°æœ‰æ¨¡æ¿æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶æ‰åˆ›å»ºæ–°æ¨¡æ¿

### 15.6 æ€»ç»“

**å½“å‰é—®é¢˜**ï¼š
- æ¨¡æ¿åŠŸèƒ½æœ‰é‡å 
- åˆ†ç±»ä¸æ¸…æ™°
- å‘½åä¸å¤Ÿæ˜ç¡®

**æ¨èæ–¹æ¡ˆ**ï¼š
- ä¿æŒç°æœ‰6ä¸ªæ¨¡æ¿
- é€šè¿‡æ¸…æ™°çš„åˆ†ç±»å’Œæ–‡æ¡£è¯´æ˜æ¯ä¸ªæ¨¡æ¿çš„å®šä½
- åœ¨å…ƒæ•°æ®ä¸­æ˜ç¡®åˆ†ç±»ï¼šç‹¬ç«‹ç”Ÿæˆã€çº¿æ€§å…³ç³»ã€éçº¿æ€§å…³ç³»ã€ç»„åˆæ¨¡æ¿
- æä¾›æ¨¡æ¿é€‰æ‹©æŒ‡å—

**ä¼˜åŠ¿**ï¼š
- æœ€å°æ”¹åŠ¨
- æ¸…æ™°æ˜“æ‡‚
- å‘åå…¼å®¹
- æ˜“äºæ‰©å±•

---

## åå…­ã€æ¨¡æ¿æ¶æ„é‡æ–°è®¾è®¡ï¼ˆåŸºäºæ–°æ´å¯Ÿï¼‰

### 16.1 æ ¸å¿ƒæ´å¯Ÿ

**æ¨¡æ¿åˆ†ç±»çš„æœ¬è´¨**ï¼š
1. **ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼šåªå’Œæ—¶é—´åºåˆ—å’Œç”Ÿæˆç®—æ³•æœ‰å…³ï¼Œä¸ä¾èµ–å…¶ä»–æ•°æ®
2. **ä¾èµ–ç”Ÿæˆæ¨¡æ¿**ï¼šä½¿ç”¨å…¶ä»–æ•°æ®ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè¿›è¡Œå„ç§è®¡ç®—

**æ»åçš„æœ¬è´¨**ï¼š
- æ»åä¸æ˜¯ä¸€ç§ç®—æ³•æ¨¡æ¿ï¼Œè€Œæ˜¯ä¸€ç§**é…ç½®å‚æ•°**
- åœ¨ä½¿ç”¨å…¶ä»–å‚æ•°æ—¶ï¼Œé€‰æ‹©ä½¿ç”¨ `x[index]` è¿˜æ˜¯ `x[index - delay]` çš„é—®é¢˜
- åº”è¯¥ä½œä¸ºæ‰€æœ‰ä¾èµ–ç”Ÿæˆæ¨¡æ¿çš„é€šç”¨é…ç½®å‚æ•°

### 16.2 é‡æ–°è®¾è®¡çš„æ¨¡æ¿æ¶æ„

#### æ¶æ„1ï¼šä¸¤ç±»æ¨¡æ¿ + æ»åä½œä¸ºé…ç½®å‚æ•°

**ç¬¬ä¸€ç±»ï¼šç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿ï¼ˆIndependentTemplateï¼‰**
- **TimePatternTemplate** - æ—¶é—´æ¨¡å¼æ¨¡æ¿
  - åŠŸèƒ½ï¼šåŸºäºæ—¶é—´ç”Ÿæˆæ•°æ®ï¼ˆæ­£å¼¦æ³¢ã€çº¿æ€§ã€æŒ‡æ•°ç­‰ï¼‰
  - å‚æ•°ï¼špattern_type, amplitude, period, phase, offset, trend, noise_level
  - æ»åï¼šä¸é€‚ç”¨ï¼ˆæ— ä¾èµ–æ•°æ®ï¼‰

- **RandomPatternTemplate** - éšæœºæ•°æ¨¡æ¿
  - åŠŸèƒ½ï¼šç”Ÿæˆéšæœºæ•°æ•°æ®
  - å‚æ•°ï¼šdistribution, min_value, max_value, mean, std, step_range, seed
  - æ»åï¼šä¸é€‚ç”¨ï¼ˆæ— ä¾èµ–æ•°æ®ï¼‰

**ç¬¬äºŒç±»ï¼šä¾èµ–ç”Ÿæˆæ¨¡æ¿ï¼ˆDependentTemplateï¼‰**
- **FollowTemplate** - è·Ÿéšæ¨¡æ¿ï¼ˆç»Ÿä¸€çš„å…³ç³»æ¨¡æ¿ï¼‰
  - åŠŸèƒ½ï¼šåŸºäºå…¶ä»–æ•°æ®ç”Ÿæˆæ•°æ®
  - æ”¯æŒï¼š
    - å•æ•°æ®æºæˆ–å¤šæ•°æ®æº
    - çº¿æ€§å…³ç³»ï¼ˆè·Ÿéšã€å¤šé¡¹å¼ï¼‰
    - éçº¿æ€§å…³ç³»ï¼ˆsqrt, log, exp, powerç­‰ï¼‰
  - å‚æ•°ï¼š
    - `source_names`: æ•°æ®æºåˆ—è¡¨ï¼ˆå•/å¤šï¼‰
    - `relation_type`: å…³ç³»ç±»å‹ï¼ˆlinear/polynomial/nonlinearï¼‰
    - `lag_seconds`: **æ»åæ—¶é—´ï¼ˆé€šç”¨é…ç½®å‚æ•°ï¼‰**
    - `coefficients`: ç³»æ•°é…ç½®ï¼ˆç”¨äºå¤šé¡¹å¼ï¼‰
    - `function`: éçº¿æ€§å‡½æ•°ç±»å‹ï¼ˆç”¨äºéçº¿æ€§å…³ç³»ï¼‰
    - `sensitivity`: æ•æ„Ÿåº¦ï¼ˆç”¨äºçº¿æ€§è·Ÿéšï¼‰
    - `decay_rate`: è¡°å‡ç‡ï¼ˆç”¨äºçº¿æ€§è·Ÿéšï¼‰
    - `noise_level`: å™ªå£°æ°´å¹³

**ç¬¬ä¸‰ç±»ï¼šç»„åˆæ¨¡æ¿ï¼ˆCompositeTemplateï¼‰**
- **CompositeCapabilityTemplate** - ç»„åˆæ¨¡æ¿
  - åŠŸèƒ½ï¼šç»„åˆå¤šä¸ªæ¨¡æ¿

#### æ¶æ„2ï¼šä¿æŒç°çŠ¶ä½†æ˜ç¡®æ»åæ˜¯é…ç½®å‚æ•°

**ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼š
- TimePatternTemplate
- RandomPatternTemplate

**ä¾èµ–ç”Ÿæˆæ¨¡æ¿**ï¼ˆéƒ½æ”¯æŒæ»åé…ç½®ï¼‰ï¼š
- **LagFollowTemplate** â†’ é‡å‘½åä¸º **LinearFollowTemplate**
  - å•æ•°æ®æºï¼Œçº¿æ€§å…³ç³»
  - `lag_seconds`: æ»åé…ç½®å‚æ•°

- **PolynomialTemplate**
  - å¤šæ•°æ®æºï¼Œçº¿æ€§å…³ç³»ï¼ˆå¤šé¡¹å¼ï¼‰
  - `lag_seconds`: æ»åé…ç½®å‚æ•°ï¼ˆå·²å­˜åœ¨ï¼‰

- **NonlinearLagTemplate** â†’ é‡å‘½åä¸º **NonlinearTemplate**
  - å¤šæ•°æ®æºï¼Œéçº¿æ€§å…³ç³»
  - `lag_seconds`: æ»åé…ç½®å‚æ•°ï¼ˆå·²å­˜åœ¨ï¼‰

**ç»„åˆæ¨¡æ¿**ï¼š
- CompositeCapabilityTemplate

### 16.3 æ¨èæ–¹æ¡ˆï¼šæ¶æ„2ï¼ˆä¿æŒç°çŠ¶ + æ˜ç¡®æ»åæ˜¯é…ç½®ï¼‰

**ç†ç”±**ï¼š
1. **æœ€å°æ”¹åŠ¨**ï¼šä¸éœ€è¦é‡æ„ç°æœ‰ä»£ç 
2. **æ¦‚å¿µæ¸…æ™°**ï¼šæ˜ç¡®æ»åæ˜¯é…ç½®å‚æ•°ï¼Œä¸æ˜¯æ¨¡æ¿ç±»å‹
3. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰æ¨¡æ¿ç±»å‹åï¼ˆå¯é€‰é‡å‘½åï¼‰

**å®æ–½å»ºè®®**ï¼š

#### 1. æ¨¡æ¿åˆ†ç±»ï¼ˆå…ƒæ•°æ®ï¼‰
```python
TEMPLATE_METADATA = {
    # ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿
    'TimePatternTemplate': {
        'category': 'ç‹¬ç«‹ç”Ÿæˆ',
        'has_dependencies': False,
        'supports_lag': False,
        ...
    },
    'RandomPatternTemplate': {
        'category': 'ç‹¬ç«‹ç”Ÿæˆ',
        'has_dependencies': False,
        'supports_lag': False,
        ...
    },
    
    # ä¾èµ–ç”Ÿæˆæ¨¡æ¿ï¼ˆéƒ½æ”¯æŒæ»åï¼‰
    'LagFollowTemplate': {
        'category': 'ä¾èµ–ç”Ÿæˆ',
        'has_dependencies': True,
        'supports_lag': True,  # æ»åæ˜¯é…ç½®å‚æ•°
        'relation_type': 'linear',
        'source_count': 'single',
        ...
    },
    'PolynomialTemplate': {
        'category': 'ä¾èµ–ç”Ÿæˆ',
        'has_dependencies': True,
        'supports_lag': True,  # æ»åæ˜¯é…ç½®å‚æ•°
        'relation_type': 'linear',
        'source_count': 'multiple',
        ...
    },
    'NonlinearLagTemplate': {
        'category': 'ä¾èµ–ç”Ÿæˆ',
        'has_dependencies': True,
        'supports_lag': True,  # æ»åæ˜¯é…ç½®å‚æ•°
        'relation_type': 'nonlinear',
        'source_count': 'multiple',
        ...
    },
    
    # ç»„åˆæ¨¡æ¿
    'CompositeCapabilityTemplate': {
        'category': 'ç»„åˆæ¨¡æ¿',
        'has_dependencies': True,  # åŠ¨æ€
        'supports_lag': False,  # ç”±å­æ¨¡æ¿å†³å®š
        ...
    },
}
```

#### 2. æ–‡æ¡£è¯´æ˜
- **ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿**ï¼šåªå’Œæ—¶é—´åºåˆ—å’Œç”Ÿæˆç®—æ³•æœ‰å…³ï¼Œä¸ä¾èµ–å…¶ä»–æ•°æ®
- **ä¾èµ–ç”Ÿæˆæ¨¡æ¿**ï¼šä½¿ç”¨å…¶ä»–æ•°æ®ä½œä¸ºè¾“å…¥å‚æ•°
  - æ‰€æœ‰ä¾èµ–ç”Ÿæˆæ¨¡æ¿éƒ½æ”¯æŒ `lag_seconds` é…ç½®å‚æ•°
  - æ»åå‚æ•°æ§åˆ¶ä½¿ç”¨ `x[index]` è¿˜æ˜¯ `x[index - delay]`

#### 3. å¯é€‰é‡å‘½åï¼ˆå¦‚æœéœ€è¦æ›´æ¸…æ™°ï¼‰
- `LagFollowTemplate` â†’ `LinearFollowTemplate`ï¼ˆå»æ‰Lagï¼Œå› ä¸ºæ»åæ˜¯é…ç½®å‚æ•°ï¼‰
- `NonlinearLagTemplate` â†’ `NonlinearTemplate`ï¼ˆå»æ‰Lagï¼Œå› ä¸ºæ»åæ˜¯é…ç½®å‚æ•°ï¼‰

### 16.4 æ¨¡æ¿å‚æ•°è®¾è®¡è§„èŒƒ

#### ç‹¬ç«‹ç”Ÿæˆæ¨¡æ¿
- **ä¸æ”¯æŒ** `lag_seconds` å‚æ•°ï¼ˆæ— ä¾èµ–æ•°æ®ï¼‰
- **æ”¯æŒ** `noise_level` å‚æ•°ï¼ˆé€šç”¨ï¼‰

#### ä¾èµ–ç”Ÿæˆæ¨¡æ¿
- **å¿…é¡»æ”¯æŒ** `lag_seconds` å‚æ•°ï¼ˆé€šç”¨é…ç½®ï¼‰
  - é»˜è®¤å€¼ï¼š0ï¼ˆæ— æ»åï¼‰
  - å•ä½ï¼šç§’
  - è¯´æ˜ï¼šæ§åˆ¶ä½¿ç”¨ `source[index]` è¿˜æ˜¯ `source[index - delay]`
- **å¿…é¡»æ”¯æŒ** `noise_level` å‚æ•°ï¼ˆé€šç”¨ï¼‰
- **å¿…é¡»æ”¯æŒ** `source_names` æˆ– `source_name` å‚æ•°ï¼ˆæŒ‡å®šæ•°æ®æºï¼‰

### 16.5 æ¨¡æ¿é€‰æ‹©æŒ‡å—ï¼ˆæ›´æ–°ç‰ˆï¼‰

**å¦‚ä½•é€‰æ‹©æ¨¡æ¿**ï¼š

1. **éœ€è¦ç‹¬ç«‹ç”Ÿæˆæ•°æ®ï¼Œä¸ä¾èµ–å…¶ä»–å‚æ•°**ï¼š
   - æ—¶é—´æ¨¡å¼ â†’ `TimePatternTemplate`
   - éšæœºæ•° â†’ `RandomPatternTemplate`

2. **éœ€è¦åŸºäºå…¶ä»–å‚æ•°ç”Ÿæˆæ•°æ®**ï¼š
   - **å•æ•°æ®æº + çº¿æ€§å…³ç³»** â†’ `LagFollowTemplate`
     - é…ç½® `lag_seconds` æ§åˆ¶æ»å
   - **å¤šæ•°æ®æº + çº¿æ€§å…³ç³»ï¼ˆå¤šé¡¹å¼ï¼‰** â†’ `PolynomialTemplate`
     - é…ç½® `lag_seconds` æ§åˆ¶æ»å
   - **å¤šæ•°æ®æº + éçº¿æ€§å…³ç³»** â†’ `NonlinearLagTemplate`
     - é…ç½® `lag_seconds` æ§åˆ¶æ»å

3. **éœ€è¦ç»„åˆå¤šä¸ªæ¨¡æ¿**ï¼š
   - ç»„åˆå¤šä¸ªæ¨¡æ¿ â†’ `CompositeCapabilityTemplate`

**å…³é”®ç‚¹**ï¼š
- æ»åä¸æ˜¯æ¨¡æ¿ç±»å‹ï¼Œè€Œæ˜¯æ‰€æœ‰ä¾èµ–ç”Ÿæˆæ¨¡æ¿çš„é€šç”¨é…ç½®å‚æ•°
- é€‰æ‹©æ¨¡æ¿æ—¶ï¼Œä¸»è¦è€ƒè™‘ï¼šæ•°æ®æºæ•°é‡ã€å…³ç³»ç±»å‹ï¼ˆçº¿æ€§/éçº¿æ€§ï¼‰
- æ»åé€šè¿‡ `lag_seconds` å‚æ•°é…ç½®

### 16.6 æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**ä¿æŒç°æœ‰6ä¸ªæ¨¡æ¿ï¼Œä½†æ˜ç¡®æ¶æ„**ï¼š

1. **ä¸¤ç±»æ¨¡æ¿**ï¼š
   - ç‹¬ç«‹ç”Ÿæˆï¼šTimePatternTemplate, RandomPatternTemplate
   - ä¾èµ–ç”Ÿæˆï¼šLagFollowTemplate, PolynomialTemplate, NonlinearLagTemplate

2. **æ»åæ˜¯é…ç½®å‚æ•°**ï¼š
   - æ‰€æœ‰ä¾èµ–ç”Ÿæˆæ¨¡æ¿éƒ½æ”¯æŒ `lag_seconds` å‚æ•°
   - åœ¨æ–‡æ¡£å’Œå…ƒæ•°æ®ä¸­æ˜ç¡®è¯´æ˜

3. **å…ƒæ•°æ®åˆ†ç±»**ï¼š
   - `ç‹¬ç«‹ç”Ÿæˆ`ï¼šTimePatternTemplate, RandomPatternTemplate
   - `ä¾èµ–ç”Ÿæˆ`ï¼šLagFollowTemplate, PolynomialTemplate, NonlinearLagTemplate
   - `ç»„åˆæ¨¡æ¿`ï¼šCompositeCapabilityTemplate

4. **å¯é€‰ä¼˜åŒ–**ï¼š
   - é‡å‘½åå»æ‰"Lag"å­—æ ·ï¼ˆLagFollowTemplate â†’ LinearFollowTemplateï¼‰
   - ä½†éœ€è¦ä¿®æ”¹ä»£ç å’Œé…ç½®ï¼Œå½±å“å‘åå…¼å®¹

### 16.7 ä¼˜åŠ¿æ€»ç»“

**æ–°æ¶æ„çš„ä¼˜åŠ¿**ï¼š
1. **æ¦‚å¿µæ¸…æ™°**ï¼šä¸¤ç±»æ¨¡æ¿ï¼Œæ»åæ˜¯é…ç½®å‚æ•°
2. **æ˜“äºç†è§£**ï¼šç”¨æˆ·åªéœ€ç†è§£ä¸¤ç±»æ¨¡æ¿çš„åŒºåˆ«
3. **ç»Ÿä¸€é…ç½®**ï¼šæ‰€æœ‰ä¾èµ–ç”Ÿæˆæ¨¡æ¿éƒ½æ”¯æŒæ»åé…ç½®
4. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ä¾èµ–ç”Ÿæˆæ¨¡æ¿æ—¶ï¼Œè‡ªåŠ¨æ”¯æŒæ»åé…ç½®
5. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰æ¨¡æ¿ç±»å‹åï¼ˆå¯é€‰é‡å‘½åï¼‰

---

## åä¸ƒã€æ¨¡æ¿æ¶æ„é‡æ–°è®¾è®¡ï¼ˆç®€å•æ¨¡æ¿ + äºŒæ¬¡æ¨¡æ¿ï¼‰

### 17.1 æ–°çš„æ¨¡æ¿åˆ†ç±»

#### ç¬¬ä¸€ç±»ï¼šç®€å•æ¨¡æ¿ï¼ˆSimpleTemplateï¼‰
**ç‰¹ç‚¹**ï¼šåªå’Œæ—¶é—´åºåˆ—å’Œç”Ÿæˆç®—æ³•æœ‰å…³ï¼Œä¸ä¾èµ–å…¶ä»–æ•°æ®

**åŒ…å«æ¨¡æ¿**ï¼š
1. **ConstantTemplate** - å¸¸æ•°æ¨¡æ¿
   - åŠŸèƒ½ï¼šç”Ÿæˆå›ºå®šå¸¸æ•°
   - å‚æ•°ï¼švalueï¼ˆå¸¸æ•°å€¼ï¼‰

2. **RandomTemplate** - éšæœºæ•°æ¨¡æ¿
   - åŠŸèƒ½ï¼šç”Ÿæˆéšæœºæ•°
   - å‚æ•°ï¼šdistribution, min_value, max_value, mean, std, seed

3. **SinusoidalTemplate** - æ­£å¼¦æ³¢æ¨¡æ¿
   - åŠŸèƒ½ï¼šç”Ÿæˆæ­£å¼¦æ³¢
   - å‚æ•°ï¼šamplitude, period, phase, offset, noise_level

4. **TriangleTemplate** - ä¸‰è§’æ³¢æ¨¡æ¿
   - åŠŸèƒ½ï¼šç”Ÿæˆä¸‰è§’æ³¢
   - å‚æ•°ï¼šamplitude, period, phase, offset, noise_level

5. **SquareTemplate** - æ–¹æ³¢æ¨¡æ¿
   - åŠŸèƒ½ï¼šç”Ÿæˆæ–¹æ³¢
   - å‚æ•°ï¼šamplitude, period, phase, offset, duty_cycle, noise_level

#### ç¬¬äºŒç±»ï¼šäºŒæ¬¡æ¨¡æ¿ï¼ˆCompositeTemplateï¼‰
**ç‰¹ç‚¹**ï¼šå¯ä»¥æ·»åŠ Nä¸ªä¾èµ–ä½å·ï¼Œæ¯ä¸ªä½å·å¯ä»¥ç‹¬ç«‹é…ç½®æ»åå’Œç®€å•æ¨¡æ¿ï¼Œç„¶åå¯¹è¿™äº›å¤„ç†åçš„ä½å·è¿›è¡Œè®¡ç®—

**æ ¸å¿ƒè®¾è®¡**ï¼š
- **ä¾èµ–ä½å·é…ç½®**ï¼šæ¯ä¸ªä½å·å¯ä»¥é…ç½®
  - `source_name`: ä½å·åç§°
  - `lag_seconds`: æ»åæ—¶é—´ï¼ˆç‹¬ç«‹é…ç½®ï¼‰
  - `simple_template`: ç®€å•æ¨¡æ¿é…ç½®ï¼ˆå¯¹ä½å·è¿›è¡Œé¢„å¤„ç†ï¼‰
    - å¯é€‰ï¼šconstant, random, sinusoidal, triangle, square
    - å¦‚æœé…ç½®äº†ç®€å•æ¨¡æ¿ï¼Œå…ˆå¯¹ä½å·åº”ç”¨ç®€å•æ¨¡æ¿ï¼Œå†åº”ç”¨æ»å
- **è®¡ç®—æ–¹å¼**ï¼šå¯¹å¤„ç†åçš„ä½å·è¿›è¡Œè®¡ç®—

### 17.2 äºŒæ¬¡æ¨¡æ¿çš„Configæ ¼å¼è®¾è®¡

#### æ–¹æ¡ˆAï¼šè¡¨è¾¾å¼æ–¹å¼ï¼ˆæ¨èï¼‰

```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'sources': [
        {
            'source_name': 'F.power',
            'lag_seconds': 30,  # æ»å30ç§’
            'simple_template': None,  # ä¸ä½¿ç”¨ç®€å•æ¨¡æ¿
        },
        {
            'source_name': 'F.temperature',
            'lag_seconds': 60,  # æ»å60ç§’
            'simple_template': {
                'type': 'sinusoidal',  # å¯¹æ¸©åº¦åº”ç”¨æ­£å¼¦æ³¢
                'amplitude': 10.0,
                'period': 3600.0,
            },
        },
        {
            'source_name': 'F.pressure',
            'lag_seconds': 0,  # æ— æ»å
            'simple_template': {
                'type': 'constant',  # å¯¹å‹åŠ›åº”ç”¨å¸¸æ•°åç§»
                'value': 100.0,
            },
        },
    ],
    'calculation': {
        'type': 'expression',  # è¡¨è¾¾å¼æ–¹å¼
        'expression': 'x1 * 0.5 + x2 * 0.3 + x3 * 0.2 + 10',  # x1å¯¹åº”sources[0], x2å¯¹åº”sources[1], x3å¯¹åº”sources[2]
    },
    'noise_level': 0.05,
}
```

**ä¼˜åŠ¿**ï¼š
- çµæ´»ï¼Œæ”¯æŒä»»æ„è¡¨è¾¾å¼
- æ˜“äºç†è§£ï¼ˆæ•°å­¦è¡¨è¾¾å¼ï¼‰

**é—®é¢˜**ï¼š
- UIé…ç½®å¤æ‚ï¼Œéœ€è¦è¡¨è¾¾å¼ç¼–è¾‘å™¨
- éœ€è¦è¡¨è¾¾å¼è§£æå’ŒéªŒè¯

#### æ–¹æ¡ˆBï¼šç³»æ•°æ–¹å¼ï¼ˆå¤šé¡¹å¼ï¼‰

```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'sources': [
        {
            'source_name': 'F.power',
            'lag_seconds': 30,
            'simple_template': None,
        },
        {
            'source_name': 'F.temperature',
            'lag_seconds': 60,
            'simple_template': {
                'type': 'sinusoidal',
                'amplitude': 10.0,
                'period': 3600.0,
            },
        },
    ],
    'calculation': {
        'type': 'polynomial',  # å¤šé¡¹å¼æ–¹å¼
        'coefficients': {
            'constant': 10.0,
            'x1': 0.5,  # x1çš„ç³»æ•°
            'x2': 0.3,  # x2çš„ç³»æ•°
            'x1*x2': 0.1,  # äº¤å‰é¡¹
        },
    },
    'noise_level': 0.05,
}
```

**ä¼˜åŠ¿**ï¼š
- UIé…ç½®ç®€å•ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
- é€‚åˆçº¿æ€§å…³ç³»

**é—®é¢˜**ï¼š
- åªæ”¯æŒå¤šé¡¹å¼ï¼Œä¸æ”¯æŒå…¶ä»–å‡½æ•°

#### æ–¹æ¡ˆCï¼šå‡½æ•°æ–¹å¼ï¼ˆé¢„å®šä¹‰å‡½æ•°ï¼‰

```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'sources': [
        {
            'source_name': 'F.power',
            'lag_seconds': 30,
            'simple_template': None,
        },
        {
            'source_name': 'F.temperature',
            'lag_seconds': 60,
            'simple_template': {
                'type': 'sinusoidal',
                'amplitude': 10.0,
                'period': 3600.0,
            },
        },
    ],
    'calculation': {
        'type': 'function',  # å‡½æ•°æ–¹å¼
        'function': 'sqrt',  # sqrt, log, exp, power, linear
        'operation': 'multiply',  # multiplyæˆ–addï¼ˆç”¨äºsqrtç­‰å‡½æ•°ï¼‰
        'coefficients': {
            'x1': 1.0,
            'x2': 1.0,
        },
        'function_params': {
            'power': 2.0,  # ç”¨äºpowerå‡½æ•°
        },
    },
    'noise_level': 0.05,
}
```

**ä¼˜åŠ¿**ï¼š
- UIé…ç½®ç®€å•ï¼ˆä¸‹æ‹‰é€‰æ‹©å‡½æ•°ï¼‰
- æ”¯æŒå¸¸è§éçº¿æ€§å‡½æ•°

**é—®é¢˜**ï¼š
- å‡½æ•°ç±»å‹æœ‰é™
- çµæ´»æ€§ä¸å¦‚è¡¨è¾¾å¼

#### æ–¹æ¡ˆDï¼šæ··åˆæ–¹å¼ï¼ˆæ¨èï¼‰

**ç»“åˆæ–¹æ¡ˆBå’Œæ–¹æ¡ˆCï¼Œæ”¯æŒå¤šç§è®¡ç®—ç±»å‹**ï¼š

```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'sources': [
        {
            'source_name': 'F.power',
            'lag_seconds': 30,
            'simple_template': None,
        },
        {
            'source_name': 'F.temperature',
            'lag_seconds': 60,
            'simple_template': {
                'type': 'sinusoidal',
                'amplitude': 10.0,
                'period': 3600.0,
            },
        },
    ],
    'calculation': {
        'type': 'linear',  # linear, polynomial, sqrt, log, exp, power, custom
        # çº¿æ€§æ–¹å¼
        'coefficients': {
            'constant': 10.0,
            'x1': 0.5,
            'x2': 0.3,
            'x1*x2': 0.1,  # äº¤å‰é¡¹ï¼ˆå¯é€‰ï¼‰
        },
        # æˆ–è€…éçº¿æ€§æ–¹å¼
        # 'function': 'sqrt',
        # 'operation': 'multiply',  # multiplyæˆ–add
        # 'function_params': {},
    },
    'noise_level': 0.05,
}
```

**æ”¯æŒçš„è®¡ç®—ç±»å‹**ï¼š
- `linear`: çº¿æ€§ç»„åˆï¼ˆç³»æ•°æ–¹å¼ï¼‰
- `polynomial`: å¤šé¡¹å¼ï¼ˆæ”¯æŒäº¤å‰é¡¹ï¼‰
- `sqrt`: å¹³æ–¹æ ¹å‡½æ•°
- `log`: å¯¹æ•°å‡½æ•°
- `exp`: æŒ‡æ•°å‡½æ•°
- `power`: å¹‚å‡½æ•°
- `custom`: è‡ªå®šä¹‰è¡¨è¾¾å¼ï¼ˆå¯é€‰ï¼Œé«˜çº§åŠŸèƒ½ï¼‰

### 17.3 UIé…ç½®è®¾è®¡

#### 17.3.1 äºŒæ¬¡æ¨¡æ¿é…ç½®ç•Œé¢

**å¸ƒå±€è®¾è®¡**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äºŒæ¬¡æ¨¡æ¿é…ç½®                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å‡ºåç§°: [F.composite          ]        â”‚
â”‚                                         â”‚
â”‚ ä¾èµ–ä½å·åˆ—è¡¨:                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [+ æ·»åŠ ä½å·]                          â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ä½å·1: [F.power â–¼]                   â”‚ â”‚
â”‚ â”‚   æ»å: [30] ç§’                       â”‚ â”‚
â”‚ â”‚   ç®€å•æ¨¡æ¿: [æ—  â–¼] [æ­£å¼¦] [éšæœº] ... â”‚ â”‚
â”‚ â”‚   [åˆ é™¤]                              â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ä½å·2: [F.temperature â–¼]             â”‚ â”‚
â”‚ â”‚   æ»å: [60] ç§’                       â”‚ â”‚
â”‚ â”‚   ç®€å•æ¨¡æ¿: [æ­£å¼¦ â–¼]                  â”‚ â”‚
â”‚ â”‚   æ¨¡æ¿å‚æ•°:                            â”‚ â”‚
â”‚ â”‚     æŒ¯å¹…: [10.0]                      â”‚ â”‚
â”‚ â”‚     å‘¨æœŸ: [3600.0] ç§’                 â”‚ â”‚
â”‚ â”‚   [åˆ é™¤]                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ è®¡ç®—æ–¹å¼:                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç±»å‹: [çº¿æ€§ â–¼]                       â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ ç³»æ•°é…ç½®:                            â”‚ â”‚
â”‚ â”‚   å¸¸æ•°é¡¹: [10.0]                     â”‚ â”‚
â”‚ â”‚   x1ç³»æ•°: [0.5]                     â”‚ â”‚
â”‚ â”‚   x2ç³»æ•°: [0.3]                     â”‚ â”‚
â”‚ â”‚   [+ æ·»åŠ äº¤å‰é¡¹]                     â”‚ â”‚
â”‚ â”‚   x1*x2ç³»æ•°: [0.1]                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ å™ªå£°æ°´å¹³: [0.05]                        â”‚
â”‚                                         â”‚
â”‚ [ä¿å­˜] [å–æ¶ˆ]                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 17.3.2 UIç»„ä»¶è®¾è®¡

**1. ä¾èµ–ä½å·åˆ—è¡¨ç»„ä»¶**
```jsx
<SourceList
  sources={sources}
  availableOutputs={availableOutputs}
  simpleTemplates={SIMPLE_TEMPLATES}
  onChange={handleSourcesChange}
/>
```

**åŠŸèƒ½**ï¼š
- æ·»åŠ /åˆ é™¤ä½å·
- é€‰æ‹©ä½å·åç§°ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
- é…ç½®æ»åæ—¶é—´ï¼ˆæ•°å­—è¾“å…¥ï¼‰
- é€‰æ‹©ç®€å•æ¨¡æ¿ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
- å¦‚æœé€‰æ‹©äº†ç®€å•æ¨¡æ¿ï¼Œæ˜¾ç¤ºæ¨¡æ¿å‚æ•°é…ç½®è¡¨å•

**2. è®¡ç®—æ–¹å¼é…ç½®ç»„ä»¶**
```jsx
<CalculationConfig
  type={calculationType}
  sources={sources}
  onChange={handleCalculationChange}
/>
```

**åŠŸèƒ½**ï¼š
- é€‰æ‹©è®¡ç®—ç±»å‹ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼šçº¿æ€§ã€å¤šé¡¹å¼ã€sqrtã€logã€expã€powerï¼‰
- æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„é…ç½®ç•Œé¢ï¼š
  - çº¿æ€§/å¤šé¡¹å¼ï¼šç³»æ•°è¡¨æ ¼
  - sqrt/log/exp/powerï¼šå‡½æ•°å‚æ•°é…ç½®

**3. ç³»æ•°é…ç½®ç»„ä»¶ï¼ˆçº¿æ€§/å¤šé¡¹å¼ï¼‰**
```jsx
<CoefficientConfig
  sources={sources}
  coefficients={coefficients}
  onChange={handleCoefficientsChange}
/>
```

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºå¸¸æ•°é¡¹è¾“å…¥
- æ˜¾ç¤ºæ¯ä¸ªä½å·çš„ç³»æ•°è¾“å…¥ï¼ˆx1, x2, ...ï¼‰
- æ”¯æŒæ·»åŠ äº¤å‰é¡¹ï¼ˆx1*x2, x1*x3, ...ï¼‰
- åŠ¨æ€ç”Ÿæˆè¾“å…¥æ¡†ï¼ˆæ ¹æ®sourcesæ•°é‡ï¼‰

### 17.4 åç«¯å®ç°è®¾è®¡

#### 17.4.1 äºŒæ¬¡æ¨¡æ¿ç±»è®¾è®¡

```python
class CompositeTemplate(CapabilityTemplate):
    """
    äºŒæ¬¡æ¨¡æ¿
    
    æ”¯æŒæ·»åŠ Nä¸ªä¾èµ–ä½å·ï¼Œæ¯ä¸ªä½å·å¯ä»¥ç‹¬ç«‹é…ç½®æ»åå’Œç®€å•æ¨¡æ¿ã€‚
    
    Configæ ¼å¼ï¼š
    {
        'name': 'composite_output',
        'output_name': 'F.composite',
        'sources': [
            {
                'source_name': 'F.power',
                'lag_seconds': 30,
                'simple_template': None,  # æˆ–ç®€å•æ¨¡æ¿é…ç½®
            },
            ...
        ],
        'calculation': {
            'type': 'linear',  # linear, polynomial, sqrt, log, exp, power
            'coefficients': {...},  # ç”¨äºlinear/polynomial
            'function': 'sqrt',  # ç”¨äºéçº¿æ€§å‡½æ•°
            'operation': 'multiply',  # multiplyæˆ–add
            'function_params': {},  # å‡½æ•°å‚æ•°
        },
        'noise_level': 0.05,
    }
    """
    
    def validate_config(self):
        """éªŒè¯é…ç½®"""
        if 'sources' not in self.config:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦'sources'é…ç½®")
        if not isinstance(self.config['sources'], list):
            raise ValueError("'sources'å¿…é¡»æ˜¯ä¸€ä¸ªåˆ—è¡¨")
        if len(self.config['sources']) == 0:
            raise ValueError("'sources'ä¸èƒ½ä¸ºç©º")
        
        # éªŒè¯æ¯ä¸ªsourceé…ç½®
        for i, source in enumerate(self.config['sources']):
            if 'source_name' not in source:
                raise ValueError(f"source[{i}]ç¼ºå°‘'source_name'")
            if 'lag_seconds' not in source:
                raise ValueError(f"source[{i}]ç¼ºå°‘'lag_seconds'")
            # éªŒè¯simple_templateï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if 'simple_template' in source and source['simple_template']:
                self._validate_simple_template(source['simple_template'])
        
        # éªŒè¯calculationé…ç½®
        if 'calculation' not in self.config:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦'calculation'é…ç½®")
        calc = self.config['calculation']
        calc_type = calc.get('type')
        valid_types = ['linear', 'polynomial', 'sqrt', 'log', 'exp', 'power']
        if calc_type not in valid_types:
            raise ValueError(f"calculation.typeå¿…é¡»æ˜¯ä»¥ä¸‹ä¹‹ä¸€: {valid_types}")
    
    def get_dependencies(self) -> List[str]:
        """è·å–ä¾èµ–çš„æ•°æ®åç§°åˆ—è¡¨"""
        return [source['source_name'] for source in self.config['sources']]
    
    def generate(self, time_points: np.ndarray, 
                 other_data: Optional[Dict[str, np.ndarray]] = None) -> np.ndarray:
        """
        ç”Ÿæˆæ•°æ®
        
        æµç¨‹ï¼š
        1. å¯¹æ¯ä¸ªsourceï¼š
           a. ä»other_dataè·å–åŸå§‹æ•°æ®
           b. åº”ç”¨ç®€å•æ¨¡æ¿ï¼ˆå¦‚æœé…ç½®ï¼‰
           c. åº”ç”¨æ»åï¼ˆlag_secondsï¼‰
        2. å¯¹å¤„ç†åçš„æ•°æ®è¿›è¡Œè®¡ç®—
        3. æ·»åŠ å™ªå£°
        """
        if other_data is None:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦other_dataå‚æ•°")
        
        sources = self.config['sources']
        calculation = self.config['calculation']
        
        # æ­¥éª¤1ï¼šå¤„ç†æ¯ä¸ªsource
        processed_sources = []
        for source in sources:
            source_name = source['source_name']
            lag_seconds = source.get('lag_seconds', 0)
            simple_template = source.get('simple_template')
            
            # è·å–åŸå§‹æ•°æ®
            if source_name not in other_data:
                raise ValueError(f"ç¼ºå°‘ä¾èµ–æ•°æ®: {source_name}")
            raw_data = other_data[source_name]
            
            # åº”ç”¨ç®€å•æ¨¡æ¿ï¼ˆå¦‚æœé…ç½®ï¼‰
            if simple_template:
                processed_data = self._apply_simple_template(
                    raw_data, time_points, simple_template
                )
            else:
                processed_data = raw_data.copy()
            
            # åº”ç”¨æ»å
            if lag_seconds > 0:
                processed_data = self._apply_lag(
                    processed_data, time_points, lag_seconds
                )
            
            processed_sources.append(processed_data)
        
        # æ­¥éª¤2ï¼šè®¡ç®—
        calc_type = calculation.get('type')
        if calc_type in ['linear', 'polynomial']:
            data = self._calculate_linear(processed_sources, calculation)
        elif calc_type == 'sqrt':
            data = self._calculate_sqrt(processed_sources, calculation)
        elif calc_type == 'log':
            data = self._calculate_log(processed_sources, calculation)
        elif calc_type == 'exp':
            data = self._calculate_exp(processed_sources, calculation)
        elif calc_type == 'power':
            data = self._calculate_power(processed_sources, calculation)
        
        # æ­¥éª¤3ï¼šæ·»åŠ å™ªå£°
        noise_level = self.config.get('noise_level', 0.0)
        if noise_level > 0:
            noise = np.random.normal(0, abs(data) * noise_level, size=len(data))
            data = data + noise
        
        return data
    
    def _apply_simple_template(self, data, time_points, template_config):
        """åº”ç”¨ç®€å•æ¨¡æ¿"""
        template_type = template_config['type']
        
        if template_type == 'constant':
            # å¸¸æ•°ï¼šdata + value
            value = template_config.get('value', 0.0)
            return data + value
        
        elif template_type == 'random':
            # éšæœºï¼šdata + random
            # è¿™é‡Œéœ€è¦é‡æ–°ç”Ÿæˆéšæœºæ•°ï¼Œä½†ä¿æŒä¸åŸå§‹æ•°æ®çš„å…³è”
            # ç®€åŒ–å¤„ç†ï¼šæ·»åŠ éšæœºå™ªå£°
            distribution = template_config.get('distribution', 'uniform')
            if distribution == 'uniform':
                min_val = template_config.get('min_value', -1.0)
                max_val = template_config.get('max_value', 1.0)
                noise = np.random.uniform(min_val, max_val, size=len(data))
            else:  # normal
                mean = template_config.get('mean', 0.0)
                std = template_config.get('std', 1.0)
                noise = np.random.normal(mean, std, size=len(data))
            return data + noise
        
        elif template_type == 'sinusoidal':
            # æ­£å¼¦æ³¢ï¼šdata + sinusoidal
            amplitude = template_config.get('amplitude', 1.0)
            period = template_config.get('period', 86400.0)
            phase = template_config.get('phase', 0.0)
            angle = 2 * np.pi * (time_points - phase) / period
            sinusoidal = amplitude * np.sin(angle)
            return data + sinusoidal
        
        elif template_type == 'triangle':
            # ä¸‰è§’æ³¢ï¼šdata + triangle
            amplitude = template_config.get('amplitude', 1.0)
            period = template_config.get('period', 86400.0)
            phase = template_config.get('phase', 0.0)
            # ç”Ÿæˆä¸‰è§’æ³¢
            angle = 2 * np.pi * (time_points - phase) / period
            triangle = amplitude * (2 * np.abs(2 * (angle / (2 * np.pi) - np.floor(angle / (2 * np.pi) + 0.5))) - 1)
            return data + triangle
        
        elif template_type == 'square':
            # æ–¹æ³¢ï¼šdata + square
            amplitude = template_config.get('amplitude', 1.0)
            period = template_config.get('period', 86400.0)
            phase = template_config.get('phase', 0.0)
            duty_cycle = template_config.get('duty_cycle', 0.5)
            angle = 2 * np.pi * (time_points - phase) / period
            square = amplitude * np.sign(np.sin(angle) - np.cos(np.pi * duty_cycle))
            return data + square
    
    def _apply_lag(self, data, time_points, lag_seconds):
        """åº”ç”¨æ»å"""
        time_interval = time_points[1] - time_points[0] if len(time_points) > 1 else 5.0
        lag_points = int(round(lag_seconds / time_interval))
        
        lagged_data = np.zeros_like(data)
        for i in range(len(data)):
            source_idx = i - lag_points
            if source_idx < 0:
                source_idx = 0
            lagged_data[i] = data[source_idx]
        
        return lagged_data
    
    def _calculate_linear(self, sources, calculation):
        """çº¿æ€§è®¡ç®—"""
        coefficients = calculation.get('coefficients', {})
        constant = coefficients.get('constant', 0.0)
        
        result = np.full(len(sources[0]), constant)
        
        # çº¿æ€§é¡¹
        for i, source_data in enumerate(sources):
            coeff_key = f'x{i+1}'
            if coeff_key in coefficients:
                result += coefficients[coeff_key] * source_data
        
        # äº¤å‰é¡¹
        for term, coeff in coefficients.items():
            if '*' in term:
                factors = [int(f.strip().replace('x', '')) - 1 for f in term.split('*')]
                if all(0 <= idx < len(sources) for idx in factors):
                    product = np.ones_like(sources[0])
                    for idx in factors:
                        product *= sources[idx]
                    result += coeff * product
        
        return result
    
    def _calculate_sqrt(self, sources, calculation):
        """å¹³æ–¹æ ¹è®¡ç®—"""
        operation = calculation.get('operation', 'multiply')
        coefficients = calculation.get('coefficients', {})
        
        if operation == 'multiply':
            value = np.ones_like(sources[0])
            for i, source_data in enumerate(sources):
                coeff_key = f'x{i+1}'
                coeff = coefficients.get(coeff_key, 1.0)
                value *= (source_data * coeff)
        else:  # add
            value = np.zeros_like(sources[0])
            for i, source_data in enumerate(sources):
                coeff_key = f'x{i+1}'
                coeff = coefficients.get(coeff_key, 1.0)
                value += (source_data * coeff)
        
        return np.sqrt(np.maximum(0, value))  # ç¡®ä¿éè´Ÿ
    
    # ... å…¶ä»–è®¡ç®—å‡½æ•°ç±»ä¼¼
```

### 17.5 UIé…ç½®ç•Œé¢è¯¦ç»†è®¾è®¡

#### 17.5.1 ä¾èµ–ä½å·é…ç½®å¡ç‰‡

```jsx
function SourceConfigCard({ source, index, availableOutputs, simpleTemplates, onChange, onDelete }) {
  const [showTemplateConfig, setShowTemplateConfig] = useState(!!source.simple_template)
  
  return (
    <Card size="small" style={{ marginBottom: 8 }}>
      <Space direction="vertical" style={{ width: '100%' }} size="small">
        <Row gutter={8}>
          <Col span={8}>
            <Select
              value={source.source_name}
              onChange={(value) => onChange(index, { ...source, source_name: value })}
              placeholder="é€‰æ‹©ä½å·"
              style={{ width: '100%' }}
            >
              {availableOutputs.map(output => (
                <Select.Option key={output} value={output}>{output}</Select.Option>
              ))}
            </Select>
          </Col>
          <Col span={8}>
            <InputNumber
              value={source.lag_seconds}
              onChange={(value) => onChange(index, { ...source, lag_seconds: value || 0 })}
              placeholder="æ»åæ—¶é—´ï¼ˆç§’ï¼‰"
              min={0}
              style={{ width: '100%' }}
            />
          </Col>
          <Col span={8}>
            <Space>
              <Select
                value={source.simple_template?.type || 'none'}
                onChange={(value) => {
                  if (value === 'none') {
                    onChange(index, { ...source, simple_template: null })
                    setShowTemplateConfig(false)
                  } else {
                    onChange(index, { 
                      ...source, 
                      simple_template: { type: value, ...getDefaultTemplateConfig(value) }
                    })
                    setShowTemplateConfig(true)
                  }
                }}
                style={{ width: 120 }}
              >
                <Select.Option value="none">æ— </Select.Option>
                {simpleTemplates.map(t => (
                  <Select.Option key={t.type} value={t.type}>{t.name}</Select.Option>
                ))}
              </Select>
              <Button size="small" danger onClick={() => onDelete(index)}>åˆ é™¤</Button>
            </Space>
          </Col>
        </Row>
        
        {showTemplateConfig && source.simple_template && (
          <SimpleTemplateConfig
            template={source.simple_template}
            onChange={(template) => onChange(index, { ...source, simple_template: template })}
          />
        )}
      </Space>
    </Card>
  )
}
```

#### 17.5.2 è®¡ç®—æ–¹å¼é…ç½®ç»„ä»¶

```jsx
function CalculationConfig({ calculation, sources, onChange }) {
  const calcType = calculation?.type || 'linear'
  
  return (
    <Space direction="vertical" style={{ width: '100%' }} size="middle">
      <div>
        <label>è®¡ç®—ç±»å‹ï¼š</label>
        <Select
          value={calcType}
          onChange={(value) => onChange({ ...calculation, type: value })}
          style={{ width: 200 }}
        >
          <Select.Option value="linear">çº¿æ€§</Select.Option>
          <Select.Option value="polynomial">å¤šé¡¹å¼</Select.Option>
          <Select.Option value="sqrt">å¹³æ–¹æ ¹</Select.Option>
          <Select.Option value="log">å¯¹æ•°</Select.Option>
          <Select.Option value="exp">æŒ‡æ•°</Select.Option>
          <Select.Option value="power">å¹‚å‡½æ•°</Select.Option>
        </Select>
      </div>
      
      {calcType === 'linear' || calcType === 'polynomial' ? (
        <CoefficientConfig
          sources={sources}
          coefficients={calculation.coefficients || {}}
          onChange={(coefficients) => onChange({ ...calculation, coefficients })}
        />
      ) : (
        <FunctionConfig
          type={calcType}
          sources={sources}
          calculation={calculation}
          onChange={onChange}
        />
      )}
    </Space>
  )
}
```

#### 17.5.3 ç³»æ•°é…ç½®ç»„ä»¶

```jsx
function CoefficientConfig({ sources, coefficients, onChange }) {
  const updateCoefficient = (key, value) => {
    onChange({ ...coefficients, [key]: value })
  }
  
  return (
    <div>
      <div style={{ marginBottom: 8 }}>
        <label>å¸¸æ•°é¡¹ï¼š</label>
        <InputNumber
          value={coefficients.constant || 0}
          onChange={(value) => updateCoefficient('constant', value || 0)}
          style={{ width: 150 }}
        />
      </div>
      
      <div style={{ marginBottom: 8 }}>
        <label>çº¿æ€§é¡¹ç³»æ•°ï¼š</label>
        {sources.map((source, index) => (
          <div key={index} style={{ marginTop: 4 }}>
            <span>x{index + 1} ({source.source_name})ï¼š</span>
            <InputNumber
              value={coefficients[`x${index + 1}`] || 0}
              onChange={(value) => updateCoefficient(`x${index + 1}`, value || 0)}
              style={{ width: 150 }}
            />
          </div>
        ))}
      </div>
      
      {/* äº¤å‰é¡¹é…ç½®ï¼ˆå¯é€‰ï¼‰ */}
      <div>
        <Button size="small" onClick={() => {/* æ·»åŠ äº¤å‰é¡¹ */}}>
          + æ·»åŠ äº¤å‰é¡¹
        </Button>
        {/* æ˜¾ç¤ºå·²æœ‰çš„äº¤å‰é¡¹ */}
      </div>
    </div>
  )
}
```

### 17.6 ç®€å•æ¨¡æ¿çš„æ‹†åˆ†

**å½“å‰TimePatternTemplateéœ€è¦æ‹†åˆ†ä¸º**ï¼š
- SinusoidalTemplateï¼ˆæ­£å¼¦æ³¢ï¼‰
- TriangleTemplateï¼ˆä¸‰è§’æ³¢ï¼‰
- SquareTemplateï¼ˆæ–¹æ³¢ï¼‰
- LinearTemplateï¼ˆçº¿æ€§è¶‹åŠ¿ï¼Œå¯é€‰ï¼‰
- ExponentialTemplateï¼ˆæŒ‡æ•°è¶‹åŠ¿ï¼Œå¯é€‰ï¼‰

**æ–°å¢**ï¼š
- ConstantTemplateï¼ˆå¸¸æ•°ï¼‰

**ä¿ç•™**ï¼š
- RandomTemplateï¼ˆéšæœºæ•°ï¼Œä»RandomPatternTemplateé‡å‘½åï¼‰

### 17.7 ä¼˜åŠ¿æ€»ç»“

**æ–°æ¶æ„çš„ä¼˜åŠ¿**ï¼š
1. **æ¦‚å¿µæ¸…æ™°**ï¼šç®€å•æ¨¡æ¿ vs äºŒæ¬¡æ¨¡æ¿
2. **çµæ´»æ€§å¼º**ï¼šäºŒæ¬¡æ¨¡æ¿å¯ä»¥ç»„åˆä»»æ„ç®€å•æ¨¡æ¿å’Œè®¡ç®—æ–¹å¼
3. **é…ç½®ç›´è§‚**ï¼šUIç•Œé¢æ¸…æ™°ï¼Œæ˜“äºç†è§£
4. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ç®€å•æ¨¡æ¿æˆ–è®¡ç®—æ–¹å¼éƒ½å¾ˆå®¹æ˜“
5. **ç»Ÿä¸€æ»å**ï¼šæ»åä½œä¸ºé…ç½®å‚æ•°ï¼Œç»Ÿä¸€å¤„ç†

### 17.8 å®æ–½å»ºè®®

**é˜¶æ®µ1ï¼šç®€å•æ¨¡æ¿æ‹†åˆ†**
1. æ‹†åˆ†TimePatternTemplateä¸ºå¤šä¸ªç®€å•æ¨¡æ¿
2. åˆ›å»ºConstantTemplate
3. é‡å‘½åRandomPatternTemplateä¸ºRandomTemplate

**é˜¶æ®µ2ï¼šäºŒæ¬¡æ¨¡æ¿å®ç°**
1. åˆ›å»ºCompositeTemplateç±»
2. å®ç°ç®€å•æ¨¡æ¿åº”ç”¨é€»è¾‘
3. å®ç°æ»ååº”ç”¨é€»è¾‘
4. å®ç°å„ç§è®¡ç®—æ–¹å¼

**é˜¶æ®µ3ï¼šUIå®ç°**
1. å®ç°ä¾èµ–ä½å·é…ç½®ç»„ä»¶
2. å®ç°è®¡ç®—æ–¹å¼é…ç½®ç»„ä»¶
3. å®ç°ç³»æ•°é…ç½®ç»„ä»¶
4. é›†æˆåˆ°VisualConfigEditor

**é˜¶æ®µ4ï¼šè¿ç§»ç°æœ‰æ¨¡æ¿**
1. å°†LagFollowTemplateè¿ç§»ä¸ºäºŒæ¬¡æ¨¡æ¿çš„ç‰¹æ®Šæƒ…å†µ
2. å°†PolynomialTemplateè¿ç§»ä¸ºäºŒæ¬¡æ¨¡æ¿çš„ç‰¹æ®Šæƒ…å†µ
3. å°†NonlinearLagTemplateè¿ç§»ä¸ºäºŒæ¬¡æ¨¡æ¿çš„ç‰¹æ®Šæƒ…å†µ

---

## åå…«ã€äºŒæ¬¡æ¨¡æ¿è®¡ç®—æ–¹å¼ä¼˜åŒ–ï¼šPythonè¡¨è¾¾å¼æ–¹æ¡ˆ

### 18.1 é—®é¢˜åˆ†æ

**å½“å‰æ–¹æ¡ˆçš„é—®é¢˜**ï¼š
- éœ€è¦æ”¯æŒå¤šç§è®¡ç®—ç±»å‹ï¼ˆlinear, polynomial, sqrt, log, exp, powerï¼‰
- æ¯ç§ç±»å‹éœ€è¦ä¸åŒçš„é…ç½®ç•Œé¢
- ç³»æ•°é…ç½®ã€å‡½æ•°å‚æ•°é…ç½®ç­‰ï¼ŒUIå¤æ‚
- æ‰©å±•æ€§å·®ï¼šæ–°å¢è®¡ç®—æ–¹å¼éœ€è¦ä¿®æ”¹ä»£ç å’ŒUI

**Pythonè¡¨è¾¾å¼æ–¹æ¡ˆçš„ä¼˜åŠ¿**ï¼š
- **ç®€æ´**ï¼šä¸€ä¸ªè¡¨è¾¾å¼è¾“å…¥æ¡†å³å¯
- **çµæ´»**ï¼šæ”¯æŒä»»æ„ç»„åˆï¼Œä¸å—é™åˆ¶
- **ç›´è§‚**ï¼šæ•°å­¦è¡¨è¾¾å¼æ˜“äºç†è§£
- **æ˜“æ‰©å±•**ï¼šæ–°å¢å‡½æ•°åªéœ€åœ¨è¡¨è¾¾å¼è§£æå™¨ä¸­æ”¯æŒ

### 18.2 Pythonè¡¨è¾¾å¼æ–¹æ¡ˆè®¾è®¡

#### 18.2.1 Configæ ¼å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'sources': [
        {
            'source_name': 'F.power',
            'lag_seconds': 30,
            'simple_template': None,
        },
        {
            'source_name': 'F.temperature',
            'lag_seconds': 60,
            'simple_template': {
                'type': 'sinusoidal',
                'amplitude': 10.0,
                'period': 3600.0,
            },
        },
        {
            'source_name': 'F.pressure',
            'lag_seconds': 0,
            'simple_template': {
                'type': 'constant',
                'value': 100.0,
            },
        },
    ],
    'calculation': {
        'expression': 'x1 * 0.5 + x2 * 0.3 + x3 * 0.2 + 10',  # Pythonè¡¨è¾¾å¼
        # æˆ–è€…æ›´å¤æ‚çš„è¡¨è¾¾å¼ï¼š
        # 'expression': 'sqrt(x1 * x2) + log(x3 + 1) + x1 * x2 * 0.1',
    },
    'noise_level': 0.05,
}
```

**è¡¨è¾¾å¼è§„åˆ™**ï¼š
- `x1, x2, x3, ...` å¯¹åº” `sources[0], sources[1], sources[2], ...`
- æ”¯æŒPythonæ•°å­¦è¡¨è¾¾å¼è¯­æ³•
- æ”¯æŒå¸¸ç”¨æ•°å­¦å‡½æ•°ï¼š`sqrt`, `log`, `exp`, `sin`, `cos`, `abs`, `max`, `min`, `power`ç­‰
- æ”¯æŒè¿ç®—ç¬¦ï¼š`+`, `-`, `*`, `/`, `**`ï¼ˆå¹‚ï¼‰, `%`ï¼ˆå–æ¨¡ï¼‰

#### 18.2.2 è¡¨è¾¾å¼è§£æå’Œå®‰å…¨æ‰§è¡Œ

**æ–¹æ¡ˆAï¼šä½¿ç”¨numexpråº“ï¼ˆæ¨èï¼‰**

```python
import numexpr as ne
import numpy as np

def evaluate_expression(expression, variables):
    """
    å®‰å…¨åœ°æ‰§è¡Œæ•°å­¦è¡¨è¾¾å¼
    
    Args:
        expression: Pythonæ•°å­¦è¡¨è¾¾å¼å­—ç¬¦ä¸²
        variables: å˜é‡å­—å…¸ï¼Œå¦‚ {'x1': array1, 'x2': array2, ...}
    
    Returns:
        è®¡ç®—ç»“æœæ•°ç»„
    """
    # numexpræ”¯æŒnumpyæ•°ç»„è¿ç®—ï¼Œæ€§èƒ½å¥½ä¸”ç›¸å¯¹å®‰å…¨
    # åªæ”¯æŒæ•°å­¦è¿ç®—ï¼Œä¸æ”¯æŒPythonä»£ç æ‰§è¡Œ
    try:
        result = ne.evaluate(expression, variables)
        return result
    except Exception as e:
        raise ValueError(f"è¡¨è¾¾å¼è®¡ç®—é”™è¯¯: {str(e)}")
```

**ä¼˜åŠ¿**ï¼š
- æ€§èƒ½å¥½ï¼ˆä¼˜åŒ–è¿‡çš„è¡¨è¾¾å¼æ±‚å€¼ï¼‰
- ç›¸å¯¹å®‰å…¨ï¼ˆä¸æ”¯æŒPythonä»£ç æ‰§è¡Œï¼‰
- æ”¯æŒnumpyæ•°ç»„è¿ç®—

**æ–¹æ¡ˆBï¼šä½¿ç”¨astè§£æ + è‡ªå®šä¹‰æ‰§è¡Œå™¨**

```python
import ast
import numpy as np
import math

class SafeExpressionEvaluator:
    """å®‰å…¨çš„è¡¨è¾¾å¼æ±‚å€¼å™¨"""
    
    # å…è®¸çš„å‡½æ•°
    ALLOWED_FUNCTIONS = {
        'sqrt': np.sqrt,
        'log': np.log,
        'exp': np.exp,
        'sin': np.sin,
        'cos': np.cos,
        'abs': np.abs,
        'max': np.maximum,
        'min': np.minimum,
        'power': np.power,
    }
    
    # å…è®¸çš„è¿ç®—ç¬¦
    ALLOWED_OPS = {
        ast.Add: np.add,
        ast.Sub: np.subtract,
        ast.Mult: np.multiply,
        ast.Div: np.true_divide,
        ast.Pow: np.power,
        ast.Mod: np.mod,
        ast.USub: np.negative,
    }
    
    def evaluate(self, expression, variables):
        """å®‰å…¨åœ°æ‰§è¡Œè¡¨è¾¾å¼"""
        try:
            # è§£æAST
            tree = ast.parse(expression, mode='eval')
            # éªŒè¯ASTï¼ˆåªå…è®¸æ•°å­¦è¿ç®—ï¼‰
            self._validate_ast(tree)
            # æ‰§è¡ŒAST
            result = self._eval_ast(tree.body, variables)
            return result
        except Exception as e:
            raise ValueError(f"è¡¨è¾¾å¼é”™è¯¯: {str(e)}")
    
    def _validate_ast(self, node):
        """éªŒè¯ASTèŠ‚ç‚¹ï¼Œç¡®ä¿åªåŒ…å«å®‰å…¨çš„æ“ä½œ"""
        if isinstance(node, ast.Expression):
            self._validate_ast(node.body)
        elif isinstance(node, ast.BinOp):
            if type(node.op) not in self.ALLOWED_OPS:
                raise ValueError(f"ä¸å…è®¸çš„è¿ç®—ç¬¦: {type(node.op).__name__}")
            self._validate_ast(node.left)
            self._validate_ast(node.right)
        elif isinstance(node, ast.UnaryOp):
            if type(node.op) not in self.ALLOWED_OPS:
                raise ValueError(f"ä¸å…è®¸çš„è¿ç®—ç¬¦: {type(node.op).__name__}")
            self._validate_ast(node.operand)
        elif isinstance(node, ast.Call):
            if not isinstance(node.func, ast.Name):
                raise ValueError("å‡½æ•°è°ƒç”¨å¿…é¡»æ˜¯å‡½æ•°å")
            if node.func.id not in self.ALLOWED_FUNCTIONS:
                raise ValueError(f"ä¸å…è®¸çš„å‡½æ•°: {node.func.id}")
            for arg in node.args:
                self._validate_ast(arg)
        elif isinstance(node, ast.Name):
            # å˜é‡åï¼Œå…è®¸
            pass
        elif isinstance(node, ast.Constant):
            # å¸¸é‡ï¼Œå…è®¸
            pass
        else:
            raise ValueError(f"ä¸å…è®¸çš„ASTèŠ‚ç‚¹: {type(node).__name__}")
    
    def _eval_ast(self, node, variables):
        """æ‰§è¡ŒASTèŠ‚ç‚¹"""
        if isinstance(node, ast.Constant):
            return node.value
        elif isinstance(node, ast.Name):
            if node.id not in variables:
                raise ValueError(f"æœªå®šä¹‰çš„å˜é‡: {node.id}")
            return variables[node.id]
        elif isinstance(node, ast.BinOp):
            left = self._eval_ast(node.left, variables)
            right = self._eval_ast(node.right, variables)
            op = self.ALLOWED_OPS[type(node.op)]
            return op(left, right)
        elif isinstance(node, ast.UnaryOp):
            operand = self._eval_ast(node.operand, variables)
            op = self.ALLOWED_OPS[type(node.op)]
            return op(operand)
        elif isinstance(node, ast.Call):
            func_name = node.func.id
            if func_name not in self.ALLOWED_FUNCTIONS:
                raise ValueError(f"ä¸å…è®¸çš„å‡½æ•°: {func_name}")
            func = self.ALLOWED_FUNCTIONS[func_name]
            args = [self._eval_ast(arg, variables) for arg in node.args]
            return func(*args)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„ASTèŠ‚ç‚¹: {type(node).__name__}")
```

**ä¼˜åŠ¿**ï¼š
- å®Œå…¨æ§åˆ¶å…è®¸çš„æ“ä½œ
- å®‰å…¨æ€§é«˜
- å¯ä»¥è‡ªå®šä¹‰é”™è¯¯æç¤º

**æ¨èæ–¹æ¡ˆ**ï¼šä½¿ç”¨ `numexpr` åº“ï¼ˆæ–¹æ¡ˆAï¼‰
- æ€§èƒ½å¥½
- ç›¸å¯¹å®‰å…¨
- å®ç°ç®€å•
- æ”¯æŒnumpyæ•°ç»„è¿ç®—

#### 18.2.3 åç«¯å®ç°ï¼ˆä½¿ç”¨numexprï¼‰

```python
import numexpr as ne
import numpy as np

class CompositeTemplate(CapabilityTemplate):
    """
    äºŒæ¬¡æ¨¡æ¿ï¼ˆä½¿ç”¨Pythonè¡¨è¾¾å¼ï¼‰
    
    Configæ ¼å¼ï¼š
    {
        'sources': [
            {
                'source_name': 'F.power',
                'lag_seconds': 30,
                'simple_template': None,
            },
            ...
        ],
        'calculation': {
            'expression': 'x1 * 0.5 + x2 * 0.3 + sqrt(x1 * x2) + 10',
        },
        'noise_level': 0.05,
    }
    """
    
    def generate(self, time_points: np.ndarray, 
                 other_data: Optional[Dict[str, np.ndarray]] = None) -> np.ndarray:
        """ç”Ÿæˆæ•°æ®"""
        if other_data is None:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦other_dataå‚æ•°")
        
        sources = self.config['sources']
        expression = self.config['calculation']['expression']
        
        # æ­¥éª¤1ï¼šå¤„ç†æ¯ä¸ªsource
        processed_sources = []
        for source in sources:
            source_name = source['source_name']
            lag_seconds = source.get('lag_seconds', 0)
            simple_template = source.get('simple_template')
            
            # è·å–åŸå§‹æ•°æ®
            if source_name not in other_data:
                raise ValueError(f"ç¼ºå°‘ä¾èµ–æ•°æ®: {source_name}")
            raw_data = other_data[source_name]
            
            # åº”ç”¨ç®€å•æ¨¡æ¿
            if simple_template:
                processed_data = self._apply_simple_template(
                    raw_data, time_points, simple_template
                )
            else:
                processed_data = raw_data.copy()
            
            # åº”ç”¨æ»å
            if lag_seconds > 0:
                processed_data = self._apply_lag(
                    processed_data, time_points, lag_seconds
                )
            
            processed_sources.append(processed_data)
        
        # æ­¥éª¤2ï¼šæ„å»ºå˜é‡å­—å…¸ï¼ˆx1, x2, x3, ...ï¼‰
        variables = {}
        for i, data in enumerate(processed_sources):
            variables[f'x{i+1}'] = data
        
        # æ·»åŠ å¸¸ç”¨æ•°å­¦å‡½æ•°åˆ°å˜é‡å­—å…¸
        variables.update({
            'sqrt': np.sqrt,
            'log': np.log,
            'exp': np.exp,
            'sin': np.sin,
            'cos': np.cos,
            'abs': np.abs,
            'max': np.maximum,
            'min': np.minimum,
            'power': np.power,
        })
        
        # æ­¥éª¤3ï¼šæ‰§è¡Œè¡¨è¾¾å¼
        try:
            # æ³¨æ„ï¼šnumexprä¸æ”¯æŒå‡½æ•°è°ƒç”¨ï¼Œéœ€è¦é¢„å¤„ç†
            # æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰æ‰§è¡Œå™¨
            data = self._evaluate_expression(expression, variables)
        except Exception as e:
            raise ValueError(f"è¡¨è¾¾å¼è®¡ç®—é”™è¯¯: {str(e)}")
        
        # æ­¥éª¤4ï¼šæ·»åŠ å™ªå£°
        noise_level = self.config.get('noise_level', 0.0)
        if noise_level > 0:
            noise = np.random.normal(0, abs(data) * noise_level, size=len(data))
            data = data + noise
        
        return data
    
    def _evaluate_expression(self, expression, variables):
        """æ‰§è¡Œè¡¨è¾¾å¼"""
        # æ–¹æ¡ˆ1ï¼šä½¿ç”¨numexprï¼ˆä¸æ”¯æŒå‡½æ•°è°ƒç”¨ï¼‰
        # éœ€è¦å°†å‡½æ•°è°ƒç”¨è½¬æ¢ä¸ºnumexpræ”¯æŒçš„è¯­æ³•
        # ä¾‹å¦‚ï¼šsqrt(x1) -> sqrt(x1) ä½†numexprä¸æ”¯æŒ
        
        # æ–¹æ¡ˆ2ï¼šä½¿ç”¨è‡ªå®šä¹‰ASTæ‰§è¡Œå™¨ï¼ˆæ¨èï¼‰
        evaluator = SafeExpressionEvaluator()
        return evaluator.evaluate(expression, variables)
```

#### 18.2.4 UIé…ç½®ç•Œé¢ï¼ˆç®€åŒ–ç‰ˆï¼‰

```jsx
function CompositeTemplateConfig({ template, onChange, availableOutputs }) {
  const [expression, setExpression] = useState(template.calculation?.expression || '')
  const [sources, setSources] = useState(template.sources || [])
  
  // å®æ—¶éªŒè¯è¡¨è¾¾å¼
  const validateExpression = (expr) => {
    if (!expr) return { valid: false, error: 'è¡¨è¾¾å¼ä¸èƒ½ä¸ºç©º' }
    
    // æ£€æŸ¥å˜é‡åæ˜¯å¦åŒ¹é…sourcesæ•°é‡
    const varMatches = expr.match(/x\d+/g) || []
    const maxVarIndex = varMatches.length > 0 
      ? Math.max(...varMatches.map(m => parseInt(m.replace('x', ''))))
      : 0
    
    if (maxVarIndex > sources.length) {
      return { 
        valid: false, 
        error: `è¡¨è¾¾å¼ä½¿ç”¨äº†x${maxVarIndex}ï¼Œä½†åªæœ‰${sources.length}ä¸ªä½å·` 
      }
    }
    
    // å¯ä»¥æ·»åŠ æ›´å¤šéªŒè¯é€»è¾‘
    return { valid: true }
  }
  
  return (
    <Space direction="vertical" style={{ width: '100%' }} size="middle">
      {/* ä¾èµ–ä½å·é…ç½® */}
      <div>
        <label>ä¾èµ–ä½å·åˆ—è¡¨ï¼š</label>
        <Button onClick={() => setSources([...sources, { source_name: '', lag_seconds: 0, simple_template: null }])}>
          + æ·»åŠ ä½å·
        </Button>
        {sources.map((source, index) => (
          <SourceConfigCard
            key={index}
            source={source}
            index={index}
            availableOutputs={availableOutputs}
            onChange={(updatedSource) => {
              const newSources = [...sources]
              newSources[index] = updatedSource
              setSources(newSources)
              onChange({ ...template, sources: newSources })
            }}
            onDelete={() => {
              const newSources = sources.filter((_, i) => i !== index)
              setSources(newSources)
              onChange({ ...template, sources: newSources })
            }}
          />
        ))}
      </div>
      
      {/* è¡¨è¾¾å¼é…ç½® */}
      <div>
        <label>è®¡ç®—è¡¨è¾¾å¼ï¼š</label>
        <div style={{ marginTop: 8 }}>
          <TextArea
            value={expression}
            onChange={(e) => {
              const newExpr = e.target.value
              setExpression(newExpr)
              const validation = validateExpression(newExpr)
              if (validation.valid) {
                onChange({
                  ...template,
                  calculation: { expression: newExpr }
                })
              }
            }}
            placeholder="ä¾‹å¦‚: x1 * 0.5 + x2 * 0.3 + sqrt(x1 * x2) + 10"
            rows={3}
            style={{ fontFamily: 'monospace', fontSize: '12px' }}
          />
          <div style={{ marginTop: 4, fontSize: '12px', color: '#666' }}>
            <div>å˜é‡è¯´æ˜ï¼šx1, x2, x3, ... å¯¹åº”ä¸Šé¢çš„ä½å·1, ä½å·2, ä½å·3, ...</div>
            <div>æ”¯æŒçš„å‡½æ•°ï¼šsqrt, log, exp, sin, cos, abs, max, min, power</div>
            <div>æ”¯æŒçš„è¿ç®—ç¬¦ï¼š+, -, *, /, **ï¼ˆå¹‚ï¼‰, %ï¼ˆå–æ¨¡ï¼‰</div>
          </div>
        </div>
      </div>
      
      {/* å™ªå£°é…ç½® */}
      <div>
        <label>å™ªå£°æ°´å¹³ï¼š</label>
        <InputNumber
          value={template.noise_level || 0}
          onChange={(value) => onChange({ ...template, noise_level: value || 0 })}
          min={0}
          max={1}
          step={0.01}
        />
      </div>
    </Space>
  )
}
```

### 18.3 è¡¨è¾¾å¼ç¤ºä¾‹

**ç®€å•çº¿æ€§ç»„åˆ**ï¼š
```
x1 * 0.5 + x2 * 0.3 + x3 * 0.2 + 10
```

**å¤šé¡¹å¼ï¼ˆå¸¦äº¤å‰é¡¹ï¼‰**ï¼š
```
10 + x1 * 2.0 + x2 * 3.0 + x3 * 1.5 + x1 * x2 * 0.1
```

**éçº¿æ€§å‡½æ•°**ï¼š
```
sqrt(x1 * x2) + log(x3 + 1) + exp(x1 * 0.01)
```

**å¤æ‚ç»„åˆ**ï¼š
```
(x1 * 0.5 + x2 * 0.3) ** 2 + sqrt(x1 * x2) * 0.1 + sin(x3) * 10 + 100
```

### 18.4 ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | ç³»æ•°æ–¹å¼ | Pythonè¡¨è¾¾å¼ |
|------|---------|-------------|
| **ç®€æ´æ€§** | âŒ éœ€è¦å¤šç§é…ç½®ç•Œé¢ | âœ… ä¸€ä¸ªè¾“å…¥æ¡† |
| **çµæ´»æ€§** | âŒ å—é™äºé¢„å®šä¹‰ç±»å‹ | âœ… ä»»æ„ç»„åˆ |
| **ç›´è§‚æ€§** | âš ï¸ éœ€è¦ç†è§£ç³»æ•°å«ä¹‰ | âœ… æ•°å­¦è¡¨è¾¾å¼ç›´è§‚ |
| **æ‰©å±•æ€§** | âŒ æ–°å¢ç±»å‹éœ€æ”¹ä»£ç  | âœ… æ–°å¢å‡½æ•°å³å¯ |
| **UIå¤æ‚åº¦** | âŒ é«˜ | âœ… ä½ |
| **å®‰å…¨æ€§** | âœ… é«˜ | âš ï¸ éœ€è¦å®‰å…¨æ‰§è¡Œ |
| **æ€§èƒ½** | âœ… é«˜ | âœ… é«˜ï¼ˆnumexprä¼˜åŒ–ï¼‰ |

### 18.5 å®‰å…¨æ€§è€ƒè™‘

**ä½¿ç”¨numexprçš„ä¼˜åŠ¿**ï¼š
- åªæ”¯æŒæ•°å­¦è¿ç®—ï¼Œä¸æ”¯æŒPythonä»£ç æ‰§è¡Œ
- æ€§èƒ½ä¼˜åŒ–ï¼Œé€‚åˆnumpyæ•°ç»„è¿ç®—
- ä½†å¯èƒ½ä¸æ”¯æŒæ‰€æœ‰å‡½æ•°è°ƒç”¨

**ä½¿ç”¨ASTè§£æçš„ä¼˜åŠ¿**ï¼š
- å®Œå…¨æ§åˆ¶å…è®¸çš„æ“ä½œ
- å¯ä»¥ç²¾ç¡®æ§åˆ¶å®‰å…¨æ€§
- æ”¯æŒå‡½æ•°è°ƒç”¨
- éœ€è¦è‡ªå·±å®ç°æ‰§è¡Œé€»è¾‘

**æ¨è**ï¼šä½¿ç”¨ASTè§£æ + è‡ªå®šä¹‰æ‰§è¡Œå™¨ï¼ˆæ–¹æ¡ˆBï¼‰
- å®‰å…¨æ€§æœ€é«˜
- çµæ´»æ€§å¥½
- å¯ä»¥ç²¾ç¡®æ§åˆ¶æ”¯æŒçš„åŠŸèƒ½

### 18.6 æœ€ç»ˆæ¨èæ–¹æ¡ˆ

**äºŒæ¬¡æ¨¡æ¿ä½¿ç”¨Pythonè¡¨è¾¾å¼**ï¼š

1. **Configæ ¼å¼**ï¼š
   ```python
   {
       'sources': [...],
       'calculation': {
           'expression': 'x1 * 0.5 + x2 * 0.3 + sqrt(x1 * x2) + 10',
       },
   }
   ```

2. **è¡¨è¾¾å¼è§£æ**ï¼š
   - ä½¿ç”¨ASTè§£æ + è‡ªå®šä¹‰æ‰§è¡Œå™¨
   - åªå…è®¸æ•°å­¦è¿ç®—å’Œé¢„å®šä¹‰å‡½æ•°
   - å˜é‡ï¼šx1, x2, x3, ... å¯¹åº”sources

3. **UIé…ç½®**ï¼š
   - ä¾èµ–ä½å·é…ç½®åˆ—è¡¨
   - è¡¨è¾¾å¼è¾“å…¥æ¡†ï¼ˆTextAreaï¼‰
   - è¡¨è¾¾å¼æç¤ºå’ŒéªŒè¯

4. **ä¼˜åŠ¿**ï¼š
   - ç®€æ´ï¼šä¸€ä¸ªè¡¨è¾¾å¼è¾“å…¥æ¡†
   - çµæ´»ï¼šæ”¯æŒä»»æ„ç»„åˆ
   - ç›´è§‚ï¼šæ•°å­¦è¡¨è¾¾å¼æ˜“äºç†è§£
   - æ˜“æ‰©å±•ï¼šæ–°å¢å‡½æ•°åªéœ€æ·»åŠ åˆ°å…è®¸åˆ—è¡¨

### 18.7 å®æ–½å»ºè®®

1. **å®‰è£…ä¾èµ–**ï¼ˆå¦‚æœéœ€è¦numexprï¼‰ï¼š
   ```bash
   pip install numexpr
   ```
   æˆ–è€…ä½¿ç”¨ASTè§£ææ–¹æ¡ˆï¼ˆæ— éœ€é¢å¤–ä¾èµ–ï¼‰

2. **å®ç°SafeExpressionEvaluator**ï¼š
   - ASTè§£æ
   - å®‰å…¨éªŒè¯
   - è¡¨è¾¾å¼æ‰§è¡Œ

3. **UIå®ç°**ï¼š
   - è¡¨è¾¾å¼è¾“å…¥æ¡†
   - å®æ—¶éªŒè¯
   - é”™è¯¯æç¤º

4. **æµ‹è¯•**ï¼š
   - è¡¨è¾¾å¼è¯­æ³•éªŒè¯
   - å®‰å…¨æ€§æµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

---

## åä¹ã€äºŒæ¬¡æ¨¡æ¿æ¶æ„ç®€åŒ–ï¼ˆå»é™¤ç®€å•æ¨¡æ¿æ¦‚å¿µï¼‰

### 19.1 ç”¨æˆ·åé¦ˆåˆ†æ

**ç”¨æˆ·æå‡ºçš„é—®é¢˜**ï¼š
1. **delayå¦‚ä½•å†™**ï¼šåœ¨Pythonè¡¨è¾¾å¼ä¸­ï¼Œå¦‚ä½•è¡¨ç¤ºæ»åï¼Ÿ
2. **æ¨¡æ¿ä¸éœ€è¦äº†**ï¼šå¦‚æœè¡¨è¾¾å¼å¯ä»¥ç›´æ¥å†™å‡½æ•°ï¼Œå°±ä¸éœ€è¦"ç®€å•æ¨¡æ¿"çš„æ¦‚å¿µäº†ï¼Œç›´æ¥å±•ç¤ºæ”¯æŒçš„ç®—æ³•å‡½æ•°å³å¯

### 19.2 æ¶æ„é‡æ–°è®¾è®¡

#### 19.2.1 æ ¸å¿ƒæ€è·¯

**å»é™¤"ç®€å•æ¨¡æ¿"æ¦‚å¿µ**ï¼š
- ä¸éœ€è¦å¯¹æ¯ä¸ªä½å·é…ç½®"ç®€å•æ¨¡æ¿"
- å‡½æ•°ç›´æ¥åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œå¦‚ï¼š`sin(x1) + sqrt(x2) + x3 * 0.5`
- åªéœ€è¦å±•ç¤ºæ”¯æŒçš„ç®—æ³•å‡½æ•°åˆ—è¡¨

**æ»åå¤„ç†**ï¼š
- æ»åæ˜¯åœ¨æ•°æ®é¢„å¤„ç†é˜¶æ®µåº”ç”¨çš„
- è¡¨è¾¾å¼ä¸­çš„ `x1, x2, x3` å·²ç»æ˜¯æ»ååçš„æ•°æ®
- ç”¨æˆ·ä¸éœ€è¦åœ¨è¡¨è¾¾å¼ä¸­å†™delayï¼Œåªéœ€è¦åœ¨é…ç½®ä¸­æŒ‡å®š `lag_seconds`

#### 19.2.2 æ–°çš„Configæ ¼å¼ï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'sources': [
        {
            'source_name': 'F.power',
            'lag_seconds': 30,  # æ»å30ç§’ï¼Œè¡¨è¾¾å¼ä¸­çš„x1å·²ç»æ˜¯æ»ååçš„æ•°æ®
        },
        {
            'source_name': 'F.temperature',
            'lag_seconds': 60,  # æ»å60ç§’ï¼Œè¡¨è¾¾å¼ä¸­çš„x2å·²ç»æ˜¯æ»ååçš„æ•°æ®
        },
        {
            'source_name': 'F.pressure',
            'lag_seconds': 0,  # æ— æ»åï¼Œè¡¨è¾¾å¼ä¸­çš„x3å°±æ˜¯åŸå§‹æ•°æ®
        },
    ],
    'calculation': {
        'expression': 'x1 * 0.5 + sin(x2) + sqrt(x3) + 10',  # ç›´æ¥ä½¿ç”¨å‡½æ•°
        # x1, x2, x3 å·²ç»æ˜¯æ»ååçš„æ•°æ®ï¼Œå¯ä»¥ç›´æ¥åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨å‡½æ•°
    },
    'noise_level': 0.05,
}
```

**å…³é”®ç‚¹**ï¼š
- `sources` ä¸­åªé…ç½® `source_name` å’Œ `lag_seconds`
- ä¸éœ€è¦ `simple_template` å­—æ®µ
- è¡¨è¾¾å¼ä¸­çš„ `x1, x2, x3` å·²ç»æ˜¯æ»ååçš„æ•°æ®
- å‡½æ•°ç›´æ¥åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼š`sin(x1)`, `sqrt(x2)`, `log(x3)`, ç­‰

#### 19.2.3 å¤„ç†æµç¨‹

```
åŸå§‹æ•°æ® (F.power, F.temperature, F.pressure)
    â†“
åº”ç”¨æ»å (lag_seconds: 30, 60, 0)
    â†“
å¾—åˆ°å¤„ç†åçš„æ•°æ® (x1, x2, x3)
    â†“
æ‰§è¡Œè¡¨è¾¾å¼: 'x1 * 0.5 + sin(x2) + sqrt(x3) + 10'
    â†“
æ·»åŠ å™ªå£°
    â†“
è¾“å‡ºç»“æœ
```

#### 19.2.4 æ”¯æŒçš„å‡½æ•°åˆ—è¡¨

**æ•°å­¦å‡½æ•°**ï¼š
- `sqrt(x)` - å¹³æ–¹æ ¹
- `log(x)` - è‡ªç„¶å¯¹æ•°
- `exp(x)` - æŒ‡æ•°å‡½æ•°
- `sin(x)` - æ­£å¼¦
- `cos(x)` - ä½™å¼¦
- `tan(x)` - æ­£åˆ‡
- `abs(x)` - ç»å¯¹å€¼
- `max(x1, x2, ...)` - æœ€å¤§å€¼
- `min(x1, x2, ...)` - æœ€å°å€¼
- `power(x, n)` - å¹‚å‡½æ•°

**è¿ç®—ç¬¦**ï¼š
- `+`, `-`, `*`, `/` - åŸºæœ¬è¿ç®—
- `**` - å¹‚è¿ç®—
- `%` - å–æ¨¡

**ç¤ºä¾‹è¡¨è¾¾å¼**ï¼š
```
# ç®€å•çº¿æ€§
x1 * 0.5 + x2 * 0.3 + 10

# å¸¦å‡½æ•°
sin(x1) + sqrt(x2) + log(x3 + 1)

# å¤æ‚ç»„åˆ
(x1 * 0.5 + x2 * 0.3) ** 2 + sin(x3) * 10 + sqrt(x1 * x2) * 0.1

# ä½¿ç”¨max/min
max(x1, x2) * 0.5 + min(x3, x4) * 0.3
```

### 19.3 UIé…ç½®ç•Œé¢ï¼ˆç®€åŒ–ç‰ˆï¼‰

#### 19.3.1 ä¾èµ–ä½å·é…ç½®ï¼ˆç®€åŒ–ï¼‰

```jsx
function SourceConfigCard({ source, index, availableOutputs, onChange, onDelete }) {
  return (
    <Card size="small" style={{ marginBottom: 8 }}>
      <Row gutter={8} align="middle">
        <Col span={12}>
          <Select
            value={source.source_name}
            onChange={(value) => onChange(index, { ...source, source_name: value })}
            placeholder="é€‰æ‹©ä½å·"
            style={{ width: '100%' }}
          >
            {availableOutputs.map(output => (
              <Select.Option key={output} value={output}>{output}</Select.Option>
            ))}
          </Select>
        </Col>
        <Col span={8}>
          <InputNumber
            value={source.lag_seconds}
            onChange={(value) => onChange(index, { ...source, lag_seconds: value || 0 })}
            placeholder="æ»åæ—¶é—´ï¼ˆç§’ï¼‰"
            min={0}
            style={{ width: '100%' }}
            addonAfter="ç§’"
          />
        </Col>
        <Col span={4}>
          <Button size="small" danger onClick={() => onDelete(index)}>åˆ é™¤</Button>
        </Col>
      </Row>
    </Card>
  )
}
```

**å…³é”®å˜åŒ–**ï¼š
- ç§»é™¤äº†"ç®€å•æ¨¡æ¿"é€‰æ‹©
- åªä¿ç•™"ä½å·é€‰æ‹©"å’Œ"æ»åæ—¶é—´"
- UIæ›´ç®€æ´

#### 19.3.2 è¡¨è¾¾å¼é…ç½®ï¼ˆå¸¦å‡½æ•°æç¤ºï¼‰

```jsx
function ExpressionConfig({ expression, sources, onChange }) {
  const [showFunctions, setShowFunctions] = useState(false)
  
  // æ”¯æŒçš„å‡½æ•°åˆ—è¡¨
  const supportedFunctions = [
    { name: 'sqrt', desc: 'å¹³æ–¹æ ¹', example: 'sqrt(x1)' },
    { name: 'log', desc: 'è‡ªç„¶å¯¹æ•°', example: 'log(x1 + 1)' },
    { name: 'exp', desc: 'æŒ‡æ•°å‡½æ•°', example: 'exp(x1)' },
    { name: 'sin', desc: 'æ­£å¼¦', example: 'sin(x1)' },
    { name: 'cos', desc: 'ä½™å¼¦', example: 'cos(x1)' },
    { name: 'tan', desc: 'æ­£åˆ‡', example: 'tan(x1)' },
    { name: 'abs', desc: 'ç»å¯¹å€¼', example: 'abs(x1)' },
    { name: 'max', desc: 'æœ€å¤§å€¼', example: 'max(x1, x2)' },
    { name: 'min', desc: 'æœ€å°å€¼', example: 'min(x1, x2)' },
    { name: 'power', desc: 'å¹‚å‡½æ•°', example: 'power(x1, 2)' },
  ]
  
  // æ’å…¥å‡½æ•°åˆ°è¡¨è¾¾å¼
  const insertFunction = (funcName) => {
    const textarea = document.getElementById('expression-input')
    const start = textarea.selectionStart
    const end = textarea.selectionEnd
    const text = expression
    const newText = text.substring(0, start) + `${funcName}()` + text.substring(end)
    onChange(newText)
    // è®¾ç½®å…‰æ ‡ä½ç½®
    setTimeout(() => {
      textarea.focus()
      textarea.setSelectionRange(start + funcName.length + 1, start + funcName.length + 1)
    }, 0)
  }
  
  return (
    <Space direction="vertical" style={{ width: '100%' }} size="small">
      <div>
        <Space>
          <label>è®¡ç®—è¡¨è¾¾å¼ï¼š</label>
          <Button 
            size="small" 
            type="link" 
            onClick={() => setShowFunctions(!showFunctions)}
          >
            {showFunctions ? 'éšè—' : 'æ˜¾ç¤º'}æ”¯æŒçš„å‡½æ•°
          </Button>
        </Space>
      </div>
      
      {showFunctions && (
        <Card size="small" style={{ marginBottom: 8 }}>
          <div style={{ fontSize: '12px' }}>
            <div style={{ marginBottom: 8, fontWeight: 'bold' }}>æ”¯æŒçš„å‡½æ•°ï¼š</div>
            <Row gutter={[8, 8]}>
              {supportedFunctions.map(func => (
                <Col span={8} key={func.name}>
                  <Space>
                    <Button 
                      size="small" 
                      type="link" 
                      onClick={() => insertFunction(func.name)}
                      style={{ padding: 0, height: 'auto' }}
                    >
                      <code>{func.name}</code>
                    </Button>
                    <span style={{ color: '#666' }}>{func.desc}</span>
                  </Space>
                </Col>
              ))}
            </Row>
          </div>
        </Card>
      )}
      
      <TextArea
        id="expression-input"
        value={expression}
        onChange={(e) => onChange(e.target.value)}
        placeholder="ä¾‹å¦‚: x1 * 0.5 + sin(x2) + sqrt(x3) + 10"
        rows={4}
        style={{ fontFamily: 'monospace', fontSize: '12px' }}
      />
      
      <div style={{ fontSize: '12px', color: '#666' }}>
        <div>å˜é‡è¯´æ˜ï¼š</div>
        <ul style={{ margin: '4px 0', paddingLeft: '20px' }}>
          {sources.map((source, index) => (
            <li key={index}>
              <code>x{index + 1}</code> = {source.source_name} 
              {source.lag_seconds > 0 && ` (æ»å${source.lag_seconds}ç§’)`}
            </li>
          ))}
        </ul>
        <div>è¿ç®—ç¬¦ï¼š+, -, *, /, **ï¼ˆå¹‚ï¼‰, %ï¼ˆå–æ¨¡ï¼‰</div>
      </div>
    </Space>
  )
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- æ˜¾ç¤ºæ”¯æŒçš„å‡½æ•°åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
- ç‚¹å‡»å‡½æ•°åå¯æ’å…¥åˆ°è¡¨è¾¾å¼
- æ˜¾ç¤ºå˜é‡è¯´æ˜ï¼ˆx1, x2, x3å¯¹åº”çš„ä½å·å’Œæ»åæ—¶é—´ï¼‰
- å®æ—¶éªŒè¯è¡¨è¾¾å¼

### 19.4 åç«¯å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰

```python
class CompositeTemplate(CapabilityTemplate):
    """
    äºŒæ¬¡æ¨¡æ¿ï¼ˆç®€åŒ–ç‰ˆï¼šå»é™¤ç®€å•æ¨¡æ¿æ¦‚å¿µï¼‰
    
    Configæ ¼å¼ï¼š
    {
        'name': 'composite_output',
        'output_name': 'F.composite',
        'sources': [
            {
                'source_name': 'F.power',
                'lag_seconds': 30,
            },
            {
                'source_name': 'F.temperature',
                'lag_seconds': 60,
            },
        ],
        'calculation': {
            'expression': 'x1 * 0.5 + sin(x2) + sqrt(x3) + 10',
        },
        'noise_level': 0.05,
    }
    """
    
    def validate_config(self):
        """éªŒè¯é…ç½®"""
        if 'sources' not in self.config:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦'sources'é…ç½®")
        if not isinstance(self.config['sources'], list):
            raise ValueError("'sources'å¿…é¡»æ˜¯ä¸€ä¸ªåˆ—è¡¨")
        if len(self.config['sources']) == 0:
            raise ValueError("'sources'ä¸èƒ½ä¸ºç©º")
        
        # éªŒè¯æ¯ä¸ªsourceé…ç½®
        for i, source in enumerate(self.config['sources']):
            if 'source_name' not in source:
                raise ValueError(f"source[{i}]ç¼ºå°‘'source_name'")
            if 'lag_seconds' not in source:
                raise ValueError(f"source[{i}]ç¼ºå°‘'lag_seconds'")
            # ä¸å†éœ€è¦éªŒè¯simple_template
        
        # éªŒè¯calculationé…ç½®
        if 'calculation' not in self.config:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦'calculation'é…ç½®")
        if 'expression' not in self.config['calculation']:
            raise ValueError("calculationéœ€è¦'expression'å­—æ®µ")
    
    def get_dependencies(self) -> List[str]:
        """è·å–ä¾èµ–çš„æ•°æ®åç§°åˆ—è¡¨"""
        return [source['source_name'] for source in self.config['sources']]
    
    def generate(self, time_points: np.ndarray, 
                 other_data: Optional[Dict[str, np.ndarray]] = None) -> np.ndarray:
        """
        ç”Ÿæˆæ•°æ®
        
        æµç¨‹ï¼š
        1. å¯¹æ¯ä¸ªsourceåº”ç”¨æ»åï¼ˆlag_secondsï¼‰
        2. æ„å»ºå˜é‡å­—å…¸ï¼ˆx1, x2, x3, ...ï¼‰
        3. æ‰§è¡Œè¡¨è¾¾å¼
        4. æ·»åŠ å™ªå£°
        """
        if other_data is None:
            raise ValueError("äºŒæ¬¡æ¨¡æ¿éœ€è¦other_dataå‚æ•°")
        
        sources = self.config['sources']
        expression = self.config['calculation']['expression']
        
        # æ­¥éª¤1ï¼šå¤„ç†æ¯ä¸ªsourceï¼ˆåªåº”ç”¨æ»åï¼‰
        processed_sources = []
        for source in sources:
            source_name = source['source_name']
            lag_seconds = source.get('lag_seconds', 0)
            
            # è·å–åŸå§‹æ•°æ®
            if source_name not in other_data:
                raise ValueError(f"ç¼ºå°‘ä¾èµ–æ•°æ®: {source_name}")
            raw_data = other_data[source_name]
            
            # åº”ç”¨æ»åï¼ˆä¸å†éœ€è¦åº”ç”¨ç®€å•æ¨¡æ¿ï¼‰
            if lag_seconds > 0:
                processed_data = self._apply_lag(
                    raw_data, time_points, lag_seconds
                )
            else:
                processed_data = raw_data.copy()
            
            processed_sources.append(processed_data)
        
        # æ­¥éª¤2ï¼šæ„å»ºå˜é‡å­—å…¸ï¼ˆx1, x2, x3, ...ï¼‰
        variables = {}
        for i, data in enumerate(processed_sources):
            variables[f'x{i+1}'] = data
        
        # æ·»åŠ å¸¸ç”¨æ•°å­¦å‡½æ•°åˆ°å˜é‡å­—å…¸
        variables.update({
            'sqrt': np.sqrt,
            'log': np.log,
            'exp': np.exp,
            'sin': np.sin,
            'cos': np.cos,
            'tan': np.tan,
            'abs': np.abs,
            'max': np.maximum,
            'min': np.minimum,
            'power': np.power,
        })
        
        # æ­¥éª¤3ï¼šæ‰§è¡Œè¡¨è¾¾å¼
        try:
            evaluator = SafeExpressionEvaluator()
            data = evaluator.evaluate(expression, variables)
        except Exception as e:
            raise ValueError(f"è¡¨è¾¾å¼è®¡ç®—é”™è¯¯: {str(e)}")
        
        # æ­¥éª¤4ï¼šæ·»åŠ å™ªå£°
        noise_level = self.config.get('noise_level', 0.0)
        if noise_level > 0:
            noise = np.random.normal(0, abs(data) * noise_level, size=len(data))
            data = data + noise
        
        return data
    
    def _apply_lag(self, data, time_points, lag_seconds):
        """åº”ç”¨æ»å"""
        time_interval = time_points[1] - time_points[0] if len(time_points) > 1 else 5.0
        lag_points = int(round(lag_seconds / time_interval))
        
        lagged_data = np.zeros_like(data)
        for i in range(len(data)):
            source_idx = i - lag_points
            if source_idx < 0:
                source_idx = 0
            lagged_data[i] = data[source_idx]
        
        return lagged_data
```

**å…³é”®å˜åŒ–**ï¼š
- ç§»é™¤äº† `_apply_simple_template` æ–¹æ³•
- `generate` æ–¹æ³•ä¸­ä¸å†å¤„ç†ç®€å•æ¨¡æ¿
- åªåº”ç”¨æ»åï¼Œç„¶åç›´æ¥æ‰§è¡Œè¡¨è¾¾å¼

### 19.5 æ¨¡æ¿åˆ†ç±»é‡æ–°å®šä¹‰

#### ç¬¬ä¸€ç±»ï¼šç®€å•æ¨¡æ¿ï¼ˆSimpleTemplateï¼‰
**ç‰¹ç‚¹**ï¼šåªå’Œæ—¶é—´åºåˆ—å’Œç”Ÿæˆç®—æ³•æœ‰å…³ï¼Œä¸ä¾èµ–å…¶ä»–æ•°æ®

**åŒ…å«æ¨¡æ¿**ï¼š
1. **ConstantTemplate** - å¸¸æ•°æ¨¡æ¿
2. **RandomTemplate** - éšæœºæ•°æ¨¡æ¿
3. **SinusoidalTemplate** - æ­£å¼¦æ³¢æ¨¡æ¿
4. **TriangleTemplate** - ä¸‰è§’æ³¢æ¨¡æ¿
5. **SquareTemplate** - æ–¹æ³¢æ¨¡æ¿

**ç”¨é€”**ï¼šç”¨äºç‹¬ç«‹ç”Ÿæˆæ•°æ®ï¼Œä¸ä¾èµ–å…¶ä»–ä½å·

#### ç¬¬äºŒç±»ï¼šäºŒæ¬¡æ¨¡æ¿ï¼ˆCompositeTemplateï¼‰
**ç‰¹ç‚¹**ï¼šä¾èµ–å…¶ä»–ä½å·ï¼Œä½¿ç”¨è¡¨è¾¾å¼è®¡ç®—

**Configæ ¼å¼**ï¼š
```python
{
    'sources': [
        {'source_name': 'F.power', 'lag_seconds': 30},
        {'source_name': 'F.temperature', 'lag_seconds': 60},
    ],
    'calculation': {
        'expression': 'x1 * 0.5 + sin(x2) + sqrt(x3) + 10',
    },
}
```

**å…³é”®ç‚¹**ï¼š
- ä¸éœ€è¦"ç®€å•æ¨¡æ¿"æ¦‚å¿µ
- å‡½æ•°ç›´æ¥åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨
- åªéœ€è¦é…ç½®ä½å·å’Œæ»åæ—¶é—´

### 19.6 ä¼˜åŠ¿æ€»ç»“

**ç®€åŒ–åçš„ä¼˜åŠ¿**ï¼š
1. **æ¦‚å¿µæ›´æ¸…æ™°**ï¼šä¸éœ€è¦ç†è§£"ç®€å•æ¨¡æ¿"çš„æ¦‚å¿µ
2. **é…ç½®æ›´ç®€å•**ï¼šæ¯ä¸ªä½å·åªéœ€è¦é…ç½®åç§°å’Œæ»åæ—¶é—´
3. **è¡¨è¾¾å¼æ›´çµæ´»**ï¼šå‡½æ•°ç›´æ¥åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨
4. **UIæ›´ç®€æ´**ï¼šä¸éœ€è¦"ç®€å•æ¨¡æ¿"é€‰æ‹©ç•Œé¢
5. **æ˜“äºç†è§£**ï¼šè¡¨è¾¾å¼å°±æ˜¯æ•°å­¦è¡¨è¾¾å¼ï¼Œç›´è§‚æ˜äº†

### 19.7 å®æ–½å»ºè®®

1. **ç§»é™¤ç®€å•æ¨¡æ¿æ¦‚å¿µ**ï¼š
   - ä»Configæ ¼å¼ä¸­ç§»é™¤ `simple_template` å­—æ®µ
   - ä»UIä¸­ç§»é™¤"ç®€å•æ¨¡æ¿"é€‰æ‹©ç•Œé¢

2. **å®ç°è¡¨è¾¾å¼æ‰§è¡Œå™¨**ï¼š
   - ä½¿ç”¨ASTè§£æ + è‡ªå®šä¹‰æ‰§è¡Œå™¨
   - æ”¯æŒå¸¸ç”¨æ•°å­¦å‡½æ•°

3. **UIå®ç°**ï¼š
   - ä¾èµ–ä½å·é…ç½®ï¼ˆåªä¿ç•™ä½å·å’Œæ»åæ—¶é—´ï¼‰
   - è¡¨è¾¾å¼è¾“å…¥æ¡† + å‡½æ•°æç¤º

4. **æ–‡æ¡£æ›´æ–°**ï¼š
   - æ›´æ–°æ¨¡æ¿æ–‡æ¡£ï¼Œè¯´æ˜æ”¯æŒçš„å‡½æ•°
   - æä¾›è¡¨è¾¾å¼ç¤ºä¾‹

---

## äºŒåã€å®Œå…¨ç»Ÿä¸€çš„è¡¨è¾¾å¼æ¶æ„ï¼ˆç®€å•æ¨¡æ¿ä¹Ÿç”¨è¡¨è¾¾å¼ï¼‰

### 20.1 ç”¨æˆ·åé¦ˆåˆ†æ

**ç”¨æˆ·æå‡ºçš„æ–°è¦æ±‚**ï¼š
- ç®€å•æ¨¡æ¿ä¹Ÿä¸è¦ç”¨è¿™äº›æ¨¡æ¿äº†ï¼Œå°±ç›´æ¥å†™å‡½æ•°å°±å¥½äº†
- éœ€è¦å…¥å‚çš„è¯ï¼Œå°±ç”¨ `t`ï¼ˆæ—¶é—´ï¼‰

### 20.2 å®Œå…¨ç»Ÿä¸€çš„æ¶æ„è®¾è®¡

#### 20.2.1 æ ¸å¿ƒæ€è·¯

**å®Œå…¨ç»Ÿä¸€ä¸ºè¡¨è¾¾å¼**ï¼š
- **ç®€å•æ¨¡æ¿**ï¼šè¡¨è¾¾å¼ç”¨ `t`ï¼ˆæ—¶é—´ï¼‰ä½œä¸ºå˜é‡
- **äºŒæ¬¡æ¨¡æ¿**ï¼šè¡¨è¾¾å¼ç”¨ `x1, x2, x3`ï¼ˆå…¶ä»–ä½å·ï¼‰ä½œä¸ºå˜é‡
- æ‰€æœ‰æ¨¡æ¿éƒ½ä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾å¼è¯­æ³•å’Œå‡½æ•°

**ä¸å†åŒºåˆ†æ¨¡æ¿ç±»å‹**ï¼š
- ä¸éœ€è¦ ConstantTemplate, RandomTemplate, SinusoidalTemplate ç­‰
- åªéœ€è¦ä¸€ä¸ª ExpressionTemplateï¼ˆè¡¨è¾¾å¼æ¨¡æ¿ï¼‰
- æ ¹æ®æ˜¯å¦æœ‰ä¾èµ–ä½å·ï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯"ç‹¬ç«‹ç”Ÿæˆ"è¿˜æ˜¯"ä¾èµ–ç”Ÿæˆ"

#### 20.2.2 æ–°çš„Configæ ¼å¼ï¼ˆå®Œå…¨ç»Ÿä¸€ï¼‰

**ç‹¬ç«‹ç”Ÿæˆï¼ˆç®€å•æ¨¡æ¿ï¼‰**ï¼š
```python
{
    'name': 'light_intensity',
    'output_name': 'F.light',
    'type': 'expression',  # è¡¨è¾¾å¼æ¨¡æ¿
    'calculation': {
        'expression': '50 + 100 * sin(2 * pi * t / 86400)',  # ä½¿ç”¨ t ä½œä¸ºæ—¶é—´å˜é‡
        # æˆ–è€…ï¼š'50 + 100 * sin(2 * pi * t / 86400) + random() * 5'
    },
    'noise_level': 0.05,
}
```

**ä¾èµ–ç”Ÿæˆï¼ˆäºŒæ¬¡æ¨¡æ¿ï¼‰**ï¼š
```python
{
    'name': 'composite_output',
    'output_name': 'F.composite',
    'type': 'expression',  # è¡¨è¾¾å¼æ¨¡æ¿
    'sources': [
        {'source_name': 'F.power', 'lag_seconds': 30},      # x1
        {'source_name': 'F.temperature', 'lag_seconds': 60}, # x2
    ],
    'calculation': {
        'expression': 'x1 * 0.5 + sin(x2) + sqrt(x3) + 10',  # ä½¿ç”¨ x1, x2, x3
    },
    'noise_level': 0.05,
}
```

**å…³é”®ç‚¹**ï¼š
- æ‰€æœ‰æ¨¡æ¿éƒ½æ˜¯ `type: 'expression'`
- ç‹¬ç«‹ç”Ÿæˆï¼šè¡¨è¾¾å¼ç”¨ `t`ï¼ˆæ—¶é—´ï¼Œå•ä½ï¼šç§’ï¼‰
- ä¾èµ–ç”Ÿæˆï¼šè¡¨è¾¾å¼ç”¨ `x1, x2, x3`ï¼ˆå…¶ä»–ä½å·ï¼Œå·²åº”ç”¨æ»åï¼‰
- æ”¯æŒç›¸åŒçš„å‡½æ•°å’Œè¿ç®—ç¬¦

#### 20.2.3 è¡¨è¾¾å¼ç¤ºä¾‹

**ç‹¬ç«‹ç”Ÿæˆç¤ºä¾‹**ï¼š
```python
# å¸¸æ•°
'50'

# æ­£å¼¦æ³¢
'50 + 100 * sin(2 * pi * t / 86400)'

# ä¸‰è§’æ³¢ï¼ˆå¯ä»¥ç”¨å‡½æ•°å®ç°ï¼Œæˆ–ç›´æ¥ç”¨è¡¨è¾¾å¼ï¼‰
'50 + 100 * (2 * abs((t % 86400) / 86400 - 0.5) - 0.5)'

# æ–¹æ³¢
'50 + 100 * sign(sin(2 * pi * t / 86400))'

# éšæœºæ•°ï¼ˆéœ€è¦æ”¯æŒrandomå‡½æ•°ï¼‰
'50 + random() * 100'

# çº¿æ€§è¶‹åŠ¿
'50 + t * 0.001'

# æŒ‡æ•°è¶‹åŠ¿
'50 * exp(t * 0.00001)'

# å¤æ‚ç»„åˆ
'50 + 100 * sin(2 * pi * t / 86400) + 10 * sin(2 * pi * t / 3600) + random() * 5'
```

**ä¾èµ–ç”Ÿæˆç¤ºä¾‹**ï¼š
```python
# ç®€å•çº¿æ€§
'x1 * 0.5 + x2 * 0.3 + 10'

# å¸¦å‡½æ•°
'sin(x1) + sqrt(x2) + log(x3 + 1)'

# å¤æ‚ç»„åˆ
'(x1 * 0.5 + x2 * 0.3) ** 2 + sin(x3) * 10 + sqrt(x1 * x2) * 0.1'

# ä½¿ç”¨max/min
'max(x1, x2) * 0.5 + min(x3, x4) * 0.3'

# æ··åˆæ—¶é—´å’Œä½å·ï¼ˆå¦‚æœéœ€è¦ï¼‰
'x1 * 0.5 + sin(2 * pi * t / 86400) * 10'
```

#### 20.2.4 æ”¯æŒçš„å‡½æ•°å’Œå˜é‡

**å˜é‡**ï¼š
- `t` - æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä»start_timeå¼€å§‹è®¡ç®—ï¼Œç”¨äºç‹¬ç«‹ç”Ÿæˆ
- `x1, x2, x3, ...` - ä¾èµ–ä½å·ï¼ˆå·²åº”ç”¨æ»åï¼‰ï¼Œç”¨äºä¾èµ–ç”Ÿæˆ

**æ•°å­¦å‡½æ•°**ï¼š
- `sqrt(x)` - å¹³æ–¹æ ¹
- `log(x)` - è‡ªç„¶å¯¹æ•°
- `exp(x)` - æŒ‡æ•°å‡½æ•°
- `sin(x)`, `cos(x)`, `tan(x)` - ä¸‰è§’å‡½æ•°
- `abs(x)` - ç»å¯¹å€¼
- `max(x1, x2, ...)`, `min(x1, x2, ...)` - æœ€å¤§/æœ€å°å€¼
- `power(x, n)` - å¹‚å‡½æ•°
- `sign(x)` - ç¬¦å·å‡½æ•°ï¼ˆè¿”å›-1, 0, 1ï¼‰
- `random()` - éšæœºæ•°ï¼ˆ0åˆ°1ä¹‹é—´çš„å‡åŒ€åˆ†å¸ƒï¼‰
- `random_normal(mean, std)` - æ­£æ€åˆ†å¸ƒéšæœºæ•°

**å¸¸é‡**ï¼š
- `pi` - åœ†å‘¨ç‡ï¼ˆ3.14159...ï¼‰
- `e` - è‡ªç„¶å¸¸æ•°ï¼ˆ2.71828...ï¼‰

**è¿ç®—ç¬¦**ï¼š
- `+`, `-`, `*`, `/` - åŸºæœ¬è¿ç®—
- `**` - å¹‚è¿ç®—
- `%` - å–æ¨¡

### 20.3 åç«¯å®ç°ï¼ˆå®Œå…¨ç»Ÿä¸€ï¼‰

```python
class ExpressionTemplate(CapabilityTemplate):
    """
    è¡¨è¾¾å¼æ¨¡æ¿ï¼ˆå®Œå…¨ç»Ÿä¸€ï¼‰
    
    æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
    1. ç‹¬ç«‹ç”Ÿæˆï¼šè¡¨è¾¾å¼ä½¿ç”¨ tï¼ˆæ—¶é—´ï¼‰ä½œä¸ºå˜é‡
    2. ä¾èµ–ç”Ÿæˆï¼šè¡¨è¾¾å¼ä½¿ç”¨ x1, x2, x3ï¼ˆå…¶ä»–ä½å·ï¼‰ä½œä¸ºå˜é‡
    
    Configæ ¼å¼ï¼ˆç‹¬ç«‹ç”Ÿæˆï¼‰ï¼š
    {
        'name': 'light_intensity',
        'output_name': 'F.light',
        'type': 'expression',
        'calculation': {
            'expression': '50 + 100 * sin(2 * pi * t / 86400)',
        },
        'noise_level': 0.05,
    }
    
    Configæ ¼å¼ï¼ˆä¾èµ–ç”Ÿæˆï¼‰ï¼š
    {
        'name': 'composite_output',
        'output_name': 'F.composite',
        'type': 'expression',
        'sources': [
            {'source_name': 'F.power', 'lag_seconds': 30},
            {'source_name': 'F.temperature', 'lag_seconds': 60},
        ],
        'calculation': {
            'expression': 'x1 * 0.5 + sin(x2) + sqrt(x3) + 10',
        },
        'noise_level': 0.05,
    }
    """
    
    def validate_config(self):
        """éªŒè¯é…ç½®"""
        if 'calculation' not in self.config:
            raise ValueError("è¡¨è¾¾å¼æ¨¡æ¿éœ€è¦'calculation'é…ç½®")
        if 'expression' not in self.config['calculation']:
            raise ValueError("calculationéœ€è¦'expression'å­—æ®µ")
        
        # å¦‚æœæœ‰sourcesï¼ŒéªŒè¯sourcesé…ç½®
        if 'sources' in self.config:
            sources = self.config['sources']
            if not isinstance(sources, list):
                raise ValueError("'sources'å¿…é¡»æ˜¯ä¸€ä¸ªåˆ—è¡¨")
            for i, source in enumerate(sources):
                if 'source_name' not in source:
                    raise ValueError(f"source[{i}]ç¼ºå°‘'source_name'")
                if 'lag_seconds' not in source:
                    raise ValueError(f"source[{i}]ç¼ºå°‘'lag_seconds'")
    
    def get_dependencies(self) -> List[str]:
        """è·å–ä¾èµ–çš„æ•°æ®åç§°åˆ—è¡¨"""
        if 'sources' in self.config:
            return [source['source_name'] for source in self.config['sources']]
        return []
    
    def generate(self, time_points: np.ndarray, 
                 other_data: Optional[Dict[str, np.ndarray]] = None) -> np.ndarray:
        """
        ç”Ÿæˆæ•°æ®
        
        æµç¨‹ï¼š
        1. åˆ¤æ–­æ˜¯ç‹¬ç«‹ç”Ÿæˆè¿˜æ˜¯ä¾èµ–ç”Ÿæˆ
        2. ç‹¬ç«‹ç”Ÿæˆï¼šæ„å»ºå˜é‡å­—å…¸ï¼ˆtï¼‰
        3. ä¾èµ–ç”Ÿæˆï¼šå¤„ç†sourcesï¼ˆåº”ç”¨æ»åï¼‰ï¼Œæ„å»ºå˜é‡å­—å…¸ï¼ˆx1, x2, x3ï¼‰
        4. æ‰§è¡Œè¡¨è¾¾å¼
        5. æ·»åŠ å™ªå£°
        """
        expression = self.config['calculation']['expression']
        
        # åˆ¤æ–­æ˜¯ç‹¬ç«‹ç”Ÿæˆè¿˜æ˜¯ä¾èµ–ç”Ÿæˆ
        has_sources = 'sources' in self.config and len(self.config['sources']) > 0
        
        if has_sources:
            # ä¾èµ–ç”Ÿæˆæ¨¡å¼
            sources = self.config['sources']
            
            if other_data is None:
                raise ValueError("ä¾èµ–ç”Ÿæˆæ¨¡å¼éœ€è¦other_dataå‚æ•°")
            
            # å¤„ç†æ¯ä¸ªsourceï¼ˆåº”ç”¨æ»åï¼‰
            processed_sources = []
            for source in sources:
                source_name = source['source_name']
                lag_seconds = source.get('lag_seconds', 0)
                
                if source_name not in other_data:
                    raise ValueError(f"ç¼ºå°‘ä¾èµ–æ•°æ®: {source_name}")
                raw_data = other_data[source_name]
                
                # åº”ç”¨æ»å
                if lag_seconds > 0:
                    processed_data = self._apply_lag(raw_data, time_points, lag_seconds)
                else:
                    processed_data = raw_data.copy()
                
                processed_sources.append(processed_data)
            
            # æ„å»ºå˜é‡å­—å…¸ï¼ˆx1, x2, x3, ...ï¼‰
            variables = {}
            for i, data in enumerate(processed_sources):
                variables[f'x{i+1}'] = data
            
            # ä¹Ÿæä¾›æ—¶é—´å˜é‡ï¼ˆå¦‚æœéœ€è¦æ··åˆä½¿ç”¨ï¼‰
            variables['t'] = time_points
            
        else:
            # ç‹¬ç«‹ç”Ÿæˆæ¨¡å¼
            # æ„å»ºå˜é‡å­—å…¸ï¼ˆtï¼‰
            variables = {
                't': time_points,
            }
        
        # æ·»åŠ æ•°å­¦å‡½æ•°å’Œå¸¸é‡
        variables.update({
            'sqrt': np.sqrt,
            'log': np.log,
            'exp': np.exp,
            'sin': np.sin,
            'cos': np.cos,
            'tan': np.tan,
            'abs': np.abs,
            'max': np.maximum,
            'min': np.minimum,
            'power': np.power,
            'sign': np.sign,
            'random': lambda size=len(time_points): np.random.random(size),
            'random_normal': lambda mean=0, std=1, size=len(time_points): np.random.normal(mean, std, size),
            'pi': np.pi,
            'e': np.e,
        })
        
        # æ‰§è¡Œè¡¨è¾¾å¼
        try:
            evaluator = SafeExpressionEvaluator()
            data = evaluator.evaluate(expression, variables)
        except Exception as e:
            raise ValueError(f"è¡¨è¾¾å¼è®¡ç®—é”™è¯¯: {str(e)}")
        
        # æ·»åŠ å™ªå£°
        noise_level = self.config.get('noise_level', 0.0)
        if noise_level > 0:
            noise = np.random.normal(0, abs(data) * noise_level, size=len(data))
            data = data + noise
        
        return data
    
    def _apply_lag(self, data, time_points, lag_seconds):
        """åº”ç”¨æ»å"""
        time_interval = time_points[1] - time_points[0] if len(time_points) > 1 else 5.0
        lag_points = int(round(lag_seconds / time_interval))
        
        lagged_data = np.zeros_like(data)
        for i in range(len(data)):
            source_idx = i - lag_points
            if source_idx < 0:
                source_idx = 0
            lagged_data[i] = data[source_idx]
        
        return lagged_data
```

### 20.4 UIé…ç½®ç•Œé¢ï¼ˆå®Œå…¨ç»Ÿä¸€ï¼‰

```jsx
function ExpressionTemplateConfig({ template, onChange, availableOutputs }) {
  const [expression, setExpression] = useState(template.calculation?.expression || '')
  const [sources, setSources] = useState(template.sources || [])
  const [isDependent, setIsDependent] = useState(sources.length > 0)
  
  // æ”¯æŒçš„å‡½æ•°åˆ—è¡¨
  const supportedFunctions = [
    { name: 'sqrt', desc: 'å¹³æ–¹æ ¹', example: 'sqrt(x)' },
    { name: 'log', desc: 'è‡ªç„¶å¯¹æ•°', example: 'log(x)' },
    { name: 'exp', desc: 'æŒ‡æ•°å‡½æ•°', example: 'exp(x)' },
    { name: 'sin', desc: 'æ­£å¼¦', example: 'sin(x)' },
    { name: 'cos', desc: 'ä½™å¼¦', example: 'cos(x)' },
    { name: 'tan', desc: 'æ­£åˆ‡', example: 'tan(x)' },
    { name: 'abs', desc: 'ç»å¯¹å€¼', example: 'abs(x)' },
    { name: 'max', desc: 'æœ€å¤§å€¼', example: 'max(x1, x2)' },
    { name: 'min', desc: 'æœ€å°å€¼', example: 'min(x1, x2)' },
    { name: 'power', desc: 'å¹‚å‡½æ•°', example: 'power(x, 2)' },
    { name: 'sign', desc: 'ç¬¦å·å‡½æ•°', example: 'sign(x)' },
    { name: 'random', desc: 'éšæœºæ•°(0-1)', example: 'random()' },
    { name: 'random_normal', desc: 'æ­£æ€åˆ†å¸ƒéšæœºæ•°', example: 'random_normal(0, 1)' },
  ]
  
  // å¸¸é‡
  const constants = [
    { name: 'pi', desc: 'åœ†å‘¨ç‡', value: '3.14159...' },
    { name: 'e', desc: 'è‡ªç„¶å¸¸æ•°', value: '2.71828...' },
  ]
  
  return (
    <Space direction="vertical" style={{ width: '100%' }} size="middle">
      {/* æ¨¡å¼é€‰æ‹© */}
      <div>
        <label>ç”Ÿæˆæ¨¡å¼ï¼š</label>
        <Radio.Group
          value={isDependent ? 'dependent' : 'independent'}
          onChange={(e) => {
            const newIsDependent = e.target.value === 'dependent'
            setIsDependent(newIsDependent)
            if (!newIsDependent) {
              setSources([])
              onChange({ ...template, sources: [] })
            }
          }}
        >
          <Radio value="independent">ç‹¬ç«‹ç”Ÿæˆï¼ˆä½¿ç”¨æ—¶é—´ tï¼‰</Radio>
          <Radio value="dependent">ä¾èµ–ç”Ÿæˆï¼ˆä½¿ç”¨ä½å· x1, x2, ...ï¼‰</Radio>
        </Radio.Group>
      </div>
      
      {/* ä¾èµ–ä½å·é…ç½®ï¼ˆä»…ä¾èµ–ç”Ÿæˆæ¨¡å¼ï¼‰ */}
      {isDependent && (
        <div>
          <label>ä¾èµ–ä½å·åˆ—è¡¨ï¼š</label>
          <Button 
            onClick={() => {
              const newSources = [...sources, { source_name: '', lag_seconds: 0 }]
              setSources(newSources)
              onChange({ ...template, sources: newSources })
            }}
            style={{ marginBottom: 8 }}
          >
            + æ·»åŠ ä½å·
          </Button>
          {sources.map((source, index) => (
            <SourceConfigCard
              key={index}
              source={source}
              index={index}
              availableOutputs={availableOutputs}
              onChange={(updatedSource) => {
                const newSources = [...sources]
                newSources[index] = updatedSource
                setSources(newSources)
                onChange({ ...template, sources: newSources })
              }}
              onDelete={() => {
                const newSources = sources.filter((_, i) => i !== index)
                setSources(newSources)
                onChange({ ...template, sources: newSources })
              }}
            />
          ))}
        </div>
      )}
      
      {/* è¡¨è¾¾å¼é…ç½® */}
      <div>
        <label>è®¡ç®—è¡¨è¾¾å¼ï¼š</label>
        <ExpressionInput
          expression={expression}
          sources={sources}
          isDependent={isDependent}
          supportedFunctions={supportedFunctions}
          constants={constants}
          onChange={(newExpr) => {
            setExpression(newExpr)
            onChange({
              ...template,
              calculation: { expression: newExpr }
            })
          }}
        />
      </div>
      
      {/* å™ªå£°é…ç½® */}
      <div>
        <label>å™ªå£°æ°´å¹³ï¼š</label>
        <InputNumber
          value={template.noise_level || 0}
          onChange={(value) => onChange({ ...template, noise_level: value || 0 })}
          min={0}
          max={1}
          step={0.01}
        />
      </div>
    </Space>
  )
}

function ExpressionInput({ expression, sources, isDependent, supportedFunctions, constants, onChange }) {
  const [showFunctions, setShowFunctions] = useState(false)
  
  return (
    <Space direction="vertical" style={{ width: '100%' }} size="small">
      <Space>
        <Button 
          size="small" 
          type="link" 
          onClick={() => setShowFunctions(!showFunctions)}
        >
          {showFunctions ? 'éšè—' : 'æ˜¾ç¤º'}æ”¯æŒçš„å‡½æ•°å’Œå¸¸é‡
        </Button>
      </Space>
      
      {showFunctions && (
        <Card size="small" style={{ marginBottom: 8 }}>
          <div style={{ fontSize: '12px' }}>
            <div style={{ marginBottom: 8, fontWeight: 'bold' }}>æ”¯æŒçš„å‡½æ•°ï¼š</div>
            <Row gutter={[8, 8]}>
              {supportedFunctions.map(func => (
                <Col span={8} key={func.name}>
                  <Space>
                    <code>{func.name}</code>
                    <span style={{ color: '#666' }}>{func.desc}</span>
                  </Space>
                </Col>
              ))}
            </Row>
            <div style={{ marginTop: 8, marginBottom: 8, fontWeight: 'bold' }}>å¸¸é‡ï¼š</div>
            <Row gutter={[8, 8]}>
              {constants.map(constant => (
                <Col span={8} key={constant.name}>
                  <Space>
                    <code>{constant.name}</code>
                    <span style={{ color: '#666' }}>{constant.desc}</span>
                  </Space>
                </Col>
              ))}
            </Row>
          </div>
        </Card>
      )}
      
      <TextArea
        value={expression}
        onChange={(e) => onChange(e.target.value)}
        placeholder={
          isDependent 
            ? "ä¾‹å¦‚: x1 * 0.5 + sin(x2) + sqrt(x3) + 10"
            : "ä¾‹å¦‚: 50 + 100 * sin(2 * pi * t / 86400)"
        }
        rows={4}
        style={{ fontFamily: 'monospace', fontSize: '12px' }}
      />
      
      <div style={{ fontSize: '12px', color: '#666' }}>
        {isDependent ? (
          <>
            <div>å˜é‡è¯´æ˜ï¼š</div>
            <ul style={{ margin: '4px 0', paddingLeft: '20px' }}>
              {sources.map((source, index) => (
                <li key={index}>
                  <code>x{index + 1}</code> = {source.source_name} 
                  {source.lag_seconds > 0 && ` (æ»å${source.lag_seconds}ç§’)`}
                </li>
              ))}
            </ul>
            <div>ä¹Ÿå¯ä»¥ä½¿ç”¨ <code>t</code> è¡¨ç¤ºæ—¶é—´ï¼ˆç§’ï¼‰</div>
          </>
        ) : (
          <div>å˜é‡è¯´æ˜ï¼š<code>t</code> è¡¨ç¤ºæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œä»start_timeå¼€å§‹è®¡ç®—</div>
        )}
        <div>è¿ç®—ç¬¦ï¼š+, -, *, /, **ï¼ˆå¹‚ï¼‰, %ï¼ˆå–æ¨¡ï¼‰</div>
      </div>
    </Space>
  )
}
```

### 20.5 ä¼˜åŠ¿æ€»ç»“

**å®Œå…¨ç»Ÿä¸€çš„ä¼˜åŠ¿**ï¼š
1. **æ¶æ„æç®€**ï¼šåªæœ‰ä¸€ä¸ªæ¨¡æ¿ç±»å‹ï¼ˆExpressionTemplateï¼‰
2. **é…ç½®ç»Ÿä¸€**ï¼šæ‰€æœ‰æ¨¡æ¿éƒ½ä½¿ç”¨ç›¸åŒçš„è¡¨è¾¾å¼è¯­æ³•
3. **çµæ´»æ€§å¼º**ï¼šæ”¯æŒä»»æ„è¡¨è¾¾å¼ç»„åˆ
4. **æ˜“äºç†è§£**ï¼šè¡¨è¾¾å¼å°±æ˜¯æ•°å­¦è¡¨è¾¾å¼ï¼Œç›´è§‚æ˜äº†
5. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢å‡½æ•°åªéœ€æ·»åŠ åˆ°å‡½æ•°åˆ—è¡¨
6. **UIç®€æ´**ï¼šåªéœ€è¦ä¸€ä¸ªè¡¨è¾¾å¼è¾“å…¥æ¡†

### 20.6 å®æ–½å»ºè®®

1. **ç»Ÿä¸€æ¨¡æ¿ç±»å‹**ï¼š
   - ç§»é™¤æ‰€æœ‰ç®€å•æ¨¡æ¿ç±»ï¼ˆConstantTemplate, RandomTemplateç­‰ï¼‰
   - åªä¿ç•™ ExpressionTemplate
   - æ ¹æ®æ˜¯å¦æœ‰sourcesè‡ªåŠ¨åˆ¤æ–­æ¨¡å¼

2. **å®ç°è¡¨è¾¾å¼æ‰§è¡Œå™¨**ï¼š
   - ä½¿ç”¨ASTè§£æ + è‡ªå®šä¹‰æ‰§è¡Œå™¨
   - æ”¯æŒæ—¶é—´å˜é‡ `t` å’Œä½å·å˜é‡ `x1, x2, x3`
   - æ”¯æŒå¸¸ç”¨æ•°å­¦å‡½æ•°å’Œå¸¸é‡

3. **UIå®ç°**ï¼š
   - æ¨¡å¼é€‰æ‹©ï¼ˆç‹¬ç«‹ç”Ÿæˆ/ä¾èµ–ç”Ÿæˆï¼‰
   - ä¾èµ–ä½å·é…ç½®ï¼ˆä»…ä¾èµ–ç”Ÿæˆæ¨¡å¼ï¼‰
   - è¡¨è¾¾å¼è¾“å…¥æ¡† + å‡½æ•°æç¤º

4. **æ–‡æ¡£æ›´æ–°**ï¼š
   - æ›´æ–°æ¨¡æ¿æ–‡æ¡£ï¼Œè¯´æ˜è¡¨è¾¾å¼è¯­æ³•
   - æä¾›è¡¨è¾¾å¼ç¤ºä¾‹ï¼ˆç‹¬ç«‹ç”Ÿæˆå’Œä¾èµ–ç”Ÿæˆï¼‰
